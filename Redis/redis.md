# Redis

**å‰è¨€**



æˆ‘ä»¬çŸ¥é“redisæ”¯æŒäº”ç§æ•°æ®ç±»å‹ï¼Œå…¶å®è¿™äº”ç§ç±»å‹å°±æ˜¯äº”ç§æ•°æ®å¯¹è±¡ã€‚æˆ‘ä»¬ä¸æ›¾æ³¨æ„åˆ°ã€‚å…¶å®ï¼Œå®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬æ“ä½œçš„æ¯ä¸€ä¸ªå‘½ä»¤ï¼Œåº•å±‚éƒ½è‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ã€‚ä¸€ä¸ªæ˜¯é”®å¯¹è±¡ã€ä¸€ä¸ªæ˜¯å€¼å¯¹è±¡ã€‚



ä»Šå¤©æˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹ï¼Œredisä¸­çš„äº”ç§æ•°æ®å¯¹è±¡æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå®ƒä»¬åˆæœ‰å“ªäº›ç‰¹æ€§å‘¢ï¼Ÿ



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uNlqRNKxe0QFs8SmaxHGktTFcIxica7fra65Q5kuWVUt8gZASxgcwWrbibtDhEKM0owJsH04ZpHyEzA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



**å¯¹è±¡çš„å±æ€§**

redis çš„é”®å’Œå€¼éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä»¥ä¸‹äº”ä¸ªå±æ€§ï¼šç±»å‹ã€ç¼–ç ã€æŒ‡é’ˆã€å¼•ç”¨è®¡æ•°ã€ç©ºè½¬æ—¶é•¿ã€‚

```c
typedef struct redisObject {    
    unsigned type: 4; #ç±»å‹    
    unsigned encoding:4; #ç¼–ç     
    int refcount; #å¼•ç”¨è®¡æ•°  
    unsigned lru:22; #ç©ºè½¬æ—¶é•¿    
    void *ptr; #æŒ‡å‘åº•å±‚å®ç°æ•°æ®ç»“æ„çš„æŒ‡é’ˆ  
}
```



**type** å±æ€§ï¼Œå¯ä¸ºä»¥ä¸‹äº”ç§çš„å…¶ä¸­ä¸€ç§ï¼šå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å“ˆå¸Œã€é›†åˆã€æœ‰åºé›†åˆ

**refcount** å±æ€§ï¼Œç”¨äºè®°å½•è¯¥å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œå¯¹è±¡ä¼šé‡Šæ”¾

**lru** å±æ€§ï¼Œç”¨äºè®°å½•å¯¹è±¡æœ€åä¸€æ¬¡è®¿é—®çš„æ—¶é—´ï¼Œè‹¥è®¿é—®çš„æ—¶é—´è¿‡ä¹…ï¼Œå¯¹è±¡ä¼šé‡Šæ”¾

**ptr** å±æ€§ï¼Œç”¨äºæŒ‡å‘å¯¹è±¡çš„åº•å±‚å®ç°çš„æ•°æ®ç»“æ„ï¼Œè€Œæ•°æ®ç»“æ„æ˜¯ç”±encodingå†³å®šçš„

**encoding** å±æ€§ï¼Œè®°å½•äº†å¯¹è±¡æ‰€ä½¿ç”¨çš„ç¼–ç ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹è±¡åº•å±‚ä½¿ç”¨äº†å“ªç§æ•°æ®ç»“æ„ä½œä¸ºå¯¹è±¡çš„åº•å±‚å®ç°ã€‚å±æ€§å€¼å¯ä»¥æ˜¯ä»¥ä¸‹è¡¨æ ¼ä¸­çš„ä¸€ä¸ªã€‚



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uPgQL8CSDtqg7msF5BJmsnPciavHyKuvnQ7lO0rGiavgaBQYPiaOibZlPgQfTCmqOAI3ib5fW23r8BtUmg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/4o22OFcmzHkibCHbibcjuQ2RR5ITRsxibiabctV3kTbcOwnfuibuH1Qbial40SKT6ppxDjIKibcCyWHP9iaZpD437uzcBQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



**TYPE** å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸ªæ•°æ®åº“é”®çš„å€¼å¯¹è±¡çš„ç±»å‹

**OBJECT ENCODING** å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸ªæ•°æ®åº“é”®çš„å€¼å¯¹è±¡çš„ç¼–ç 

```
127.0.0.1:6379> set msg 'hello word'
OK
127.0.0.1:6379> get msg
"hello word"
127.0.0.1:6379> TYPE msg
string
127.0.0.1:6379> OBJECT ENCODING msg
"embstr"
127.0.0.1:6379>
```



æ³¨æ„ï¼šæ¯ç§ç±»å‹çš„å¯¹è±¡éƒ½è‡³å°‘ä½¿ç”¨äº†ä¸¤ç§ä»¥ä¸Šä¸åŒçš„ç¼–ç æ–¹å¼ã€‚é€šè¿‡æ”¹å˜ encoding çš„æ–¹å¼ï¼Œæ¥æé«˜ redis çš„çµæ´»æ€§å’Œæ•ˆç‡ï¼Œå› ä¸º redis ä¼šæ ¹æ®ä¸åŒçš„åœºæ™¯ï¼Œæ¥ä¸ºå¯¹è±¡è®¾ç½®ä¸åŒçš„ç¼–ç ï¼Œä»è€Œä¼˜åŒ–å¯¹è±¡åœ¨æŸä¸€åœºæ™¯ä¸‹çš„æ•ˆç‡ã€‚





**ä¸€ã€å­—ç¬¦ä¸²å¯¹è±¡**



å­—ç¬¦ä¸²çš„ç¼–ç å¯ä»¥æ˜¯ä»¥ä¸‹ä¸‰ç§ï¼šintã€rawã€embstrï¼›



**int** ç¼–ç ï¼Œrediså­˜å‚¨çš„æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œè¯¥æ•´æ•°å€¼å¯ä»¥ç”¨longç±»å‹è¡¨ç¤ºæ—¶ï¼Œä½¿ç”¨intç¼–ç ã€‚

**raw** ç¼–ç ï¼Œrediså­˜å‚¨çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²é•¿åº¦å¤§äº39ä¸ªå­—èŠ‚æ—¶ï¼Œä½¿ç”¨rawç¼–ç ã€‚

**embstr** ç¼–ç ï¼Œrediså­˜å‚¨çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸”é•¿åº¦å¤§äºç­‰äº39ä¸ªå­—èŠ‚æ—¶ï¼Œä½¿ç”¨embstrç¼–ç ã€‚



**raw å’Œ embstr ç¼–ç çš„åŒºåˆ«ï¼š**

raw ä¼šè°ƒç”¨ä¸¤æ¬¡å†…å­˜åˆ†é…æœºåˆ¶ï¼Œå†…å­˜ä¸æ˜¯è¿ç»­ç©ºé—´ã€‚é‡Šæ”¾å†…å­˜æ—¶ä¹Ÿéœ€è¦è°ƒç”¨ä¸¤æ¬¡å‡½æ•°ã€‚

embstr ä¼šè°ƒç”¨ä¸€æ¬¡å†…å­˜åˆ†é…æœºåˆ¶ï¼Œå†…å­˜æ˜¯è¿ç»­çš„ç©ºé—´ã€‚é‡Šæ”¾å†…å­˜åªéœ€è¦è°ƒç”¨ä¸€æ¬¡å‡½æ•°ã€‚



**1.1 ç¼–ç çš„è½¬æ¢**



å› ä¸ºappendå‘½ä»¤åªå…è®¸å¯¹ raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡è¿›è¡Œæ“ä½œã€‚å½“æˆ‘ä»¬å¯¹ä¸€ä¸ª int ç¼–ç çš„ æˆ– embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡è¿›è¡Œä¸€å®šçš„æ“ä½œæ—¶ï¼Œä¼šå°†ç¼–ç è½¬æ¢ä¸º raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚





```
127.0.0.1:6379> set msg 123
OK
127.0.0.1:6379> OBJECT ENCODING msg
"int"
127.0.0.1:6379> append msg 222
(integer) 6
127.0.0.1:6379> OBJECT ENCODING msg
"raw"
127.0.0.1:6379>
```

```
127.0.0.1:6379> set a 'abc'OK127.0.0.1:6379> object encoding a"embstr"127.0.0.1:6379> append a 123(integer) 6127.0.0.1:6379> object encoding a"raw"127.0.0.1:6379>
```



ä»¥ä¸Šå‘½ä»¤ï¼Œåˆ™æ˜¯å®è·µ int å’Œ embstr ç¼–ç ï¼Œé€šè¿‡ append è½¬æ¢ä¸º raw ç¼–ç ç±»å‹çš„è¿‡ç¨‹ã€‚





**äºŒã€åˆ—è¡¨å¯¹è±¡**



æ—©æœŸçš„åˆ—è¡¨å¯¹è±¡çš„ç¼–ç æ˜¯ç”± ziplist ã€ linkedlistï¼Œä¹Ÿå°±æ˜¯è¯´å½“å…ƒç´ å°‘æ—¶ä½¿ç”¨ziplistï¼Œå½“å…ƒç´ å¤šæ—¶ä½¿ç”¨ linkedlistã€‚ä½†æ˜¯åæ¥ï¼Œæ–°ç‰ˆæœ¬ä¸­å¯¹åˆ—è¡¨æ•°æ®ç»“æ„è¿›è¡Œäº†æ”¹é€ ï¼Œä½¿ç”¨ **quicklist** ä»£æ›¿äº† ziplist å’Œ linkedlistï¼›



**quicklist ç¼–ç ï¼Œ**æ˜¯ä½¿ç”¨å¿«é€Ÿåˆ—è¡¨ä½œä¸ºåˆ—è¡¨å¯¹è±¡çš„åº•å±‚å®ç°ã€‚

**ziplist ç¼–ç **ï¼Œæ˜¯ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåˆ—è¡¨å¯¹è±¡çš„åº•å±‚å®ç°ã€‚

**linkedlist ç¼–ç **ï¼Œæ˜¯ä½¿ç”¨åŒç«¯é“¾è¡¨ä½œä¸ºåˆ—è¡¨å¯¹è±¡çš„åº•å±‚å®ç°ã€‚



ä¸‹é¢å‘½ä»¤ï¼Œä½“ç°å‡ºæ–°ç‰ˆæœ¬ä¸­ä½¿ç”¨â€œå¿«é€Ÿåˆ—è¡¨â€ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„çš„å®ç°



```
127.0.0.1:6379> lpush list 1
(integer) 1
127.0.0.1:6379> object encoding list
"quicklist"
127.0.0.1:6379>
```



quicklist æ˜¯ ziplist å’Œ linkedlist çš„æ··åˆä½“ï¼Œå®ƒå°† linkedlist æŒ‰æ®µåˆ‡åˆ†ï¼Œæ¯ä¸€æ®µä½¿ç”¨ ziplist å­˜å‚¨ï¼Œå¤šä¸ª ziplist ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²æ¥èµ·æ¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uPgQL8CSDtqg7msF5BJmsnPTSIwe38L1u4RZMe6jVIwPMwqabeWAZhUDYF5ynpaSVQCNzfsrnQ7aQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



- quicklist å†…éƒ¨é»˜è®¤å•ä¸ª ziplist é•¿åº¦ä¸º 8k å­—èŠ‚ï¼Œè¶…å‡ºäº†è¿™ä¸ªå­—èŠ‚æ•°ï¼Œå°±ä¼šæ–°èµ·ä¸€ä¸ª ziplistã€‚
- ziplist çš„é•¿åº¦ç”±é…ç½®å‚æ•° list-max-ziplist-size å†³å®šã€‚
- å¿«é€Ÿåˆ—è¡¨ é»˜è®¤çš„å‹ç¼©æ·±åº¦æ˜¯0ï¼Œä¹Ÿå°±æ˜¯ä¸å‹ç¼©ã€‚å‹ç¼©çš„å®é™…æ·±åº¦å¯ç”±list-compress-depth å†³å®šã€‚
- ä¸ºäº†æ”¯æŒå¿«é€Ÿçš„ push/pop æ“ä½œï¼Œquicklist çš„é¦–å°¾ä¸¤ä¸ª ziplist ä¸å‹ç¼©ï¼Œæ­¤æ—¶æ·±åº¦å°±æ˜¯ 1ã€‚
- å¦‚æœæ·±åº¦ä¸º 2ï¼Œå°±è¡¨ç¤º quicklist çš„é¦–å°¾ç¬¬ä¸€ä¸ª ziplist ä»¥åŠé¦–å°¾ç¬¬äºŒä¸ª ziplist éƒ½ä¸å‹ç¼©ã€‚



**2.1 å¿«é€Ÿåˆ—è¡¨çš„æ•°æ®ç»“æ„ã€èŠ‚ç‚¹**





```c
#å¿«é€Ÿåˆ—è¡¨
struct quicklist {    
quicklistNode* head;    
quicklistNode* tail;    
long count; #å…ƒç´ æ€»æ•°    
int nodes; #ziplist èŠ‚ç‚¹çš„ä¸ªæ•°    
int compressDepth; # LZF ç®—æ³•å‹ç¼©æ·±åº¦
}
```



```c
#å¿«é€Ÿåˆ—è¡¨èŠ‚ç‚¹
struct quicklistNode {   
quicklistNode* prev;    
quicklistNode* next;    
ziplist* zl; #æŒ‡å‘å‹ç¼©åˆ—è¡¨    
int32 size; #ziplist çš„å­—èŠ‚æ€»æ•°    
int16 count; #ziplist ä¸­çš„å…ƒç´ æ•°é‡    
int2 encoding; #å­˜å‚¨å½¢å¼ 2bitï¼ŒåŸç”Ÿå­—èŠ‚æ•°ç»„è¿˜æ˜¯ LZF å‹ç¼©å­˜å‚¨
}
```



**2.2 åŒç«¯é“¾è¡¨ã€å‹ç¼©åˆ—è¡¨ã€\**å¿«é€Ÿåˆ—è¡¨\**çš„ç‰¹ç‚¹**

åŒç«¯é“¾è¡¨ï¼Œè¿›è¡Œpushã€popæ¥è¯´é€Ÿåº¦å¾ˆå¿«ï¼Œä½†æ˜¯å®ƒçš„å†…å­˜å¼€é”€æ¯”è¾ƒå¤§ï¼Œå› ä¸ºå®ƒè¦é¢å¤–å­˜å‚¨å‰é©±æŒ‡é’ˆå’Œåç»§æŒ‡é’ˆã€‚é“¾è¡¨é‡‡ç”¨ä¸è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å®ƒå¯¹ä¿®æ”¹å’Œæ’å…¥æ“ä½œæ¥è¯´ç›¸å½“å¿«é€Ÿï¼Œä½†æ˜¯å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚



å‹ç¼©åˆ—è¡¨ï¼Œä»…é™äºå­˜å‚¨å­—èŠ‚è¾ƒçŸ­çš„æ•°æ®ï¼Œå› ä¸ºå®ƒæ˜¯ä¸ºèŠ‚çœå†…å­˜è€Œå¼€å‘çš„æ•°æ®ç»“æ„ï¼Œå‹ç¼©åˆ—è¡¨ä½¿ç”¨è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å®ƒå¯¹åˆ é™¤å’Œæ’å…¥çš„æ•ˆç‡ç›¸å¯¹è¾ƒä½ï¼Œä½†æ˜¯æŸ¥è¯¢æ•ˆç‡å¾ˆé«˜ã€‚å‹ç¼©åˆ—è¡¨å¯¹äºæ’å…¥å¾ˆå¤§çš„æ•°æ®æƒ…å†µä¸‹ï¼Œä¼šäº§ç”Ÿæ‰©å®¹å’Œå¤§é‡æ‹·è´æµç¨‹ï¼Œæ­¤æ—¶æ•ˆç‡ç›¸å¯¹è¾ƒä½ã€‚



å¿«é€Ÿåˆ—è¡¨æ˜¯å¯¹å‹ç¼©åˆ—è¡¨å’ŒåŒç«¯é“¾è¡¨çš„ç©ºé—´å’Œæ—¶é—´æ•ˆç‡çš„æŠ˜ä¸­äº§ç‰©ã€‚å®ƒç»“åˆäº†äºŒè€…çš„ä¼˜ç‚¹ã€‚





**ä¸‰ã€å“ˆå¸Œå¯¹è±¡**



å“ˆå¸Œå¯¹è±¡çš„ç¼–ç æ–¹å¼æœ‰ ziplist ã€hashtable



**ziplist** ç¼–ç ï¼Œå“ˆå¸Œå¯¹è±¡åº•å±‚ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ã€‚

**hashtable** ç¼–ç ï¼Œå“ˆå¸Œå¯¹è±¡åº•å±‚ä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ã€‚

ä¸‹é¢å‘½ä»¤ï¼Œæ˜¯å‹ç¼©åˆ—è¡¨å®ç°çš„å“ˆå¸Œå¯¹è±¡å­˜å‚¨ã€‚



```
127.0.0.1:6379> hset mytest name "cici"
(integer) 1
127.0.0.1:6379> hset mytest age 18
(integer) 1
127.0.0.1:6379> hset mytest sex 'å¥³'
(integer) 1
127.0.0.1:6379> object encoding mytest
"ziplist"
127.0.0.1:6379>
```



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uPgQL8CSDtqg7msF5BJmsnPTsvbaRS8R1TicnmKyzRGVQcTyXBuwqicXxG5ickAUsVaC2Gk6cQXoxrTA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



ä¸‹é¢å‘½ä»¤ï¼Œæ˜¯å­—å…¸å®ç°çš„å“ˆå¸Œå¯¹è±¡å­˜å‚¨ã€‚



```
127.0.0.1:6379> hset mytest content 'æˆ‘æ˜¯ä¸­å›½äººï¼Œæˆ‘åœ¨æµ‹è¯•å“ˆå¸Œï¼Œä½ çœ‹åˆ°äº†å—ï¼Ÿæˆ‘æ˜¯ä¸­å›½äººï¼Œæˆ‘åœ¨æµ‹è¯•å“ˆå¸Œï¼Œä½ çœ‹åˆ°äº†å—ï¼Ÿæˆ‘æ˜¯ä¸­å›½äººï¼Œæˆ‘åœ¨æµ‹è¯•å“ˆå¸Œï¼Œä½ çœ‹åˆ°äº†å—ï¼Ÿæˆ‘æ˜¯ä¸­å›½äººï¼Œæˆ‘åœ¨æµ‹è¯•å“ˆå¸Œï¼Œä½ çœ‹åˆ°äº†å—ï¼Ÿæˆ‘æ˜¯ä¸­å›½äººï¼Œæˆ‘åœ¨æµ‹è¯•å“ˆå¸Œï¼Œä½ çœ‹åˆ°äº†å—ï¼Ÿæˆ‘æ˜¯ä¸­å›½äººï¼Œæˆ‘åœ¨æµ‹è¯•å“ˆå¸Œï¼Œä½ çœ‹åˆ°äº†å—ï¼Ÿæˆ‘æ˜¯ä¸­å›½äººï¼Œæˆ‘åœ¨æµ‹è¯•å“ˆå¸Œï¼Œä½ çœ‹åˆ°äº†å—ï¼Ÿ'
127.0.0.1:6379> object encoding mytest
"hashtable"
127.0.0.1:6379>
```



å½“ ziplist ä½œä¸ºå“ˆå¸Œå¯¹è±¡çš„åº•å±‚å®ç°æ—¶ï¼Œè‹¥å†æ¬¡å­˜å‚¨é”®å€¼ï¼Œé•¿åº¦å¤§äºç­‰äº64å­—èŠ‚æ—¶ï¼Œå“ˆå¸Œå¯¹è±¡çš„åº•å±‚å®ç°ï¼Œä¼šè¿›è¡Œç¼–ç è½¬æ¢ï¼Œæ­¤æ—¶çš„å“ˆå¸Œå¯¹è±¡çš„ç¼–ç æ–¹å¼ä¸º hashtable ã€‚



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uPgQL8CSDtqg7msF5BJmsnPD3WLvaVybjhWpdM0M6bsx59XnTiaIPYLfkcicUC8EQ0DLicV32v72aHQw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œhashtable ç¼–ç çš„å“ˆå¸Œå¯¹è±¡ï¼Œä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ï¼Œå“ˆå¸Œå¯¹è±¡ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹éƒ½ä½¿ç”¨ä¸€ä¸ªå­—å…¸é”®å€¼å¯¹æ¥å­˜å‚¨ã€‚å­—å…¸çš„æ¯ä¸ªé”®å’Œå€¼éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯¹è±¡ä¸­åˆ†åˆ«å­˜å­˜äº†é”®å€¼å¯¹çš„é”®å’Œå€¼ã€‚



**3.1 ç¼–ç è½¬æ¢**



å½“å“ˆå¸Œå¯¹è±¡åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹å“ˆå¸Œå¯¹è±¡ä¼šä½¿ç”¨å‹ç¼© ziplist ç¼–ç ï¼›



- å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰é”®å€¼å¯¹çš„é”®å’Œå€¼é•¿åº¦å°äº64å­—èŠ‚
- å“ˆå¸Œå¯¹è±¡ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å°äº 512 ä¸ª



ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ã€‚è‹¥ä¸æ»¡è¶³ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œå°†ä¼šé‡‡ç”¨ hashtable è¿›è¡Œç¼–ç ã€‚



**å››ã€é›†åˆå¯¹è±¡**



é›†åˆå¯¹è±¡çš„ç¼–ç æœ‰ intsetã€hashtable



**intset** ç¼–ç ï¼Œé›†åˆå¯¹è±¡ä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºåº•å±‚å®ç°ï¼Œé›†åˆå…ƒç´ éƒ½å­˜å‚¨åœ¨æ•´æ•°é›†åˆé‡Œã€‚

**hashtable** ç¼–ç ï¼Œé›†åˆå¯¹è±¡ä½¿ç”¨å­—å…¸ä½œä¸ºåº•å±‚å®ç°ã€‚

ä¸‹é¢å‘½ä»¤ï¼Œæ˜¯æ•´æ•°é›†åˆå®ç°çš„é›†åˆå¯¹è±¡å­˜å‚¨ã€‚



```
127.0.0.1:6379> sadd mynumber 111 222 333
(integer) 3
127.0.0.1:6379> object encoding mynumber
"intset"
127.0.0.1:6379>
```



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uPgQL8CSDtqg7msF5BJmsnP6FdjDofEzdSabFs0mVXnXiaYEnuFH6pLzvpoOc16v3rjVUUJUiaEHIxg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



ä¸‹é¢å‘½ä»¤ï¼Œæ˜¯å­—å…¸å®ç°çš„é›†åˆå¯¹è±¡å­˜å‚¨



```
127.0.0.1:6379> sadd mynumber "hello" "ä½ å¥½"
(integer) 2
127.0.0.1:6379> object encoding mynumber
"hashtable"
127.0.0.1:6379>
```



ä¸‹é¢å‘½ä»¤ï¼Œæ˜¯æŸ¥çœ‹é›†åˆä¸­çš„å…ƒç´ æ•°é‡ å’Œ å…ƒç´ å€¼ï¼Œç”±æ­¤å¯è§ï¼Œé›†åˆç¼–ç å‘ç”Ÿäº†å˜åŒ–ï¼Œå·²ç»ä» intset ç¼–ç è½¬æ¢æˆ hashtable ç¼–ç ã€‚



```
127.0.0.1:6379> scard mynumber
(integer) 5
127.0.0.1:6379> smembers mynumber
1) "hello"
2) "333"
3) "111"
4) "222"
5) "\xe4\xbd\xa0\xe5\xa5\xbd"
127.0.0.1:6379>
```



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uPgQL8CSDtqg7msF5BJmsnPbwPRpo8Z3iaMfGD4Ly4yERO7bvHM1Zuspb8rK6Un2yVD5KMIn4JoKjQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



ç”±ä¸Šå›¾å¯è§ï¼Œé›†åˆä¸­å› ä¸ºæ·»åŠ äº†å­—ç¬¦ä¸²ç±»å‹å€¼ï¼Œå› æ­¤ä»åŸæœ¬çš„ intset ç¼–ç è½¬ä¸º hashtable ç¼–ç ã€‚



**4.1 ç¼–ç è½¬æ¢**



å½“é›†åˆå¯¹è±¡åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡ä¼šä½¿ç”¨ intset ç¼–ç 



- é›†åˆå¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼ã€‚
- é›†åˆå¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡ä¸è¶…è¿‡ 512 ä¸ªã€‚



ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œé€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ã€‚è‹¥ä¸æ»¡è¶³ä»¥ä¸Šæ¡ä»¶çš„é›†åˆå¯¹è±¡å°†ä½¿ç”¨ hashtable ç¼–ç ã€‚





**äº”ã€æœ‰åºé›†åˆå¯¹è±¡**



æœ‰åºé›†åˆå¯¹è±¡æ˜¯æœ‰ ziplist ã€skiplist



**ziplist** ç¼–ç ï¼Œæœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ã€‚

**skiplist** ç¼–ç ï¼Œæœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨ zset ç»“æ„ä½œä¸ºåº•å±‚å®ç°ï¼Œä¸€ä¸ªzsetåŒ…å«ä¸€ä¸ªå­—å…¸å’Œä¸€ä¸ªè·³è·ƒè¡¨ã€‚



ä¸‹é¢å‘½ä»¤ï¼Œæ˜¯å‹ç¼©åˆ—è¡¨ä½œä¸ºæœ‰åºé›†åˆå¯¹è±¡çš„åº•å±‚å®ç°ã€‚



```
127.0.0.1:6379> zadd price 5.6 apple 3.4 orange
(integer) 2
127.0.0.1:6379> object encoding price
"ziplist"
127.0.0.1:6379>
```



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uPgQL8CSDtqg7msF5BJmsnPWeR8ajxgibBt9XgRriaLiaia6JlAn1aZyhoW1oN3D1uwbpDUpM3kSbR01A/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



æ³¨æ„ï¼šæœ‰åºé›†åˆåœ¨å‹ç¼©åˆ—è¡¨ä¸­æŒ‰åˆ†å€¼å¤§å°è¿›è¡Œæ’åºå­˜å‚¨ã€‚

ä¸‹é¢å‘½ä»¤ï¼Œæ˜¯è·³è·ƒè¡¨ä½œä¸ºæœ‰åºé›†åˆå¯¹è±¡çš„åº•å±‚å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ª zset ç»“æ„ã€‚



```
127.0.0.1:6379> zadd price 4.4 "ä¹°äº†ä¸€ä»¶è¡£æœï¼Œè¿™ä¸ªè¡£æœçœŸå¥½çœ‹ï¼ŒçœŸçš„å¾ˆå¥½çœ‹ï¼ŒçœŸçš„å¾ˆå¥½çœ‹ï¼ŒçœŸçš„å¾ˆå¥½çœ‹"(integer) 1
127.0.0.1:6379> object encoding price
"skiplist"
127.0.0.1:6379>
```



ä¸‹é¢å‘½ä»¤ï¼Œæ˜¯æŸ¥çœ‹æœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å’Œæ’åºæƒ…å†µã€‚

```
127.0.0.1:6379> zcard price
(integer) 3
127.0.0.1:6379> ZRANGE price 0 -1
1) "orange"
2) "\xe4\xb9\xb0\xe4\xba\x86\xe4\xb8\x80\xe4\xbb\xb6\xe8\xa1\xa3\xe6\x9c\x8d\xef\xbc\x8c\xe8\xbf\x99\xe4\xb8\xaa\xe8\xa1\xa3\xe6\x9c\x8d\xe7\x9c\x9f\xe5\xa5\xbd\xe7\x9c\x8b\xef\xbc\x8c\xe7\x9c\x9f\xe7\x9a\x84\xe5\xbe\x88\xe5\xa5\xbd\xe7\x9c\x8b\xef\xbc\x8c\xe7\x9c\x9f\xe7\x9a\x84\xe5\xbe\x88\xe5\xa5\xbd\xe7\x9c\x8b\xef\xbc\x8c\xe7\x9c\x9f\xe7\x9a\x84\xe5\xbe\x88\xe5\xa5\xbd\xe7\x9c\x8b"3) "apple"
127.0.0.1:6379>
```



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uPgQL8CSDtqg7msF5BJmsnPcTkXEa4bdgGU1VATicOAhHfXhxOQ2oPaa3WruZPpTbxRicO5snKK9G6g/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



ç”±ä¸Šå›¾å¯è§ï¼Œå½“æœ‰åºé›†åˆä½¿ç”¨äº† skiplist ç¼–ç æ–¹å¼ï¼Œå…¶å®åº•å±‚é‡‡ç”¨äº†zsetç»“æ„æ¥å­˜å‚¨äº†æ•°æ®å†…å®¹ã€‚



zset ç»“æ„åˆ†åˆ«ç”¨äº†ä¸€ä¸ªå­—å…¸ å’Œ ä¸€ä¸ªè·³è·ƒè¡¨æ¥å®Œæˆåº•å±‚å®ç°ã€‚

å­—å…¸çš„ä¼˜ç‚¹ï¼Œåœ¨äºå®ƒä»¥æ—¶é—´å¤æ‚åº¦ä¸ºO(1) çš„é€Ÿåº¦å–å€¼ã€‚

è·³è·ƒè¡¨çš„ä¼˜ç‚¹ï¼Œåœ¨äºå®ƒä»¥åˆ†å€¼è¿›è¡Œä»å°åˆ°å¤§çš„æ’åºã€‚ç»“åˆäºŒè€…çš„ä¼˜ç‚¹ä½œä¸º zset çš„æ•´ä½“ç»“æ„æ¥å®Œæˆäº†æœ‰åºé›†åˆçš„åº•å±‚å®ç°ã€‚



**5.1 ç¼–ç çš„è½¬æ¢**



æœ‰åºé›†åˆå¯¹è±¡åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡ä½¿ç”¨ziplist ç¼–ç 



- æœ‰åºé›†åˆä¿å­˜çš„å…ƒç´ æ•°é‡å°äº128ä¸ªã€‚
- æœ‰åºé›†åˆä¿å­˜çš„æ‰€æœ‰å…ƒç´ æˆå‘˜é•¿åº¦éƒ½å°äº64å­—èŠ‚ã€‚



ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œé€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ã€‚è‹¥ä¸æ»¡è¶³ä»¥ä¸Šæ¡ä»¶çš„æœ‰åºé›†åˆå¯¹è±¡å°†ä½¿ç”¨ skiplist ç¼–ç ã€‚



Sorted Setçš„æ•°æ®ç»“æ„æ˜¯ä¸€ç§è·³è¡¨ï¼Œå³SkipListï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢çº¿æ˜¯æŸ¥æ‰¾10çš„è¿‡ç¨‹ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/4o22OFcmzHkibCHbibcjuQ2RR5ITRsxibiabQCmG3icsOpxibHMmAVFTTCufywXTCh76DqgpoCGHLBdZahyCibT4K0mlg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)SkipList

- å¦‚ä½•å€ŸåŠ©Sorted setå®ç°å¤šç»´æ’åº

Sorted  Seté»˜è®¤æƒ…å†µä¸‹åªèƒ½æ ¹æ®ä¸€ä¸ªå› å­scoreè¿›è¡Œæ’åºã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå±€é™æ€§å°±å¾ˆå¤§ï¼Œä¸¾ä¸ªæ —å­ï¼šçƒ­é—¨æ’è¡Œæ¦œéœ€è¦æŒ‰ç…§ä¸‹è½½é‡&æœ€è¿‘æ›´æ–°æ—¶é—´æ’åºï¼Œå³ç±»ä¼¼æ•°æ®åº“ä¸­çš„ORDER BY download_count, update_time DESCã€‚é‚£è¿™æ ·çš„éœ€æ±‚å¦‚æœç”¨Redisçš„Sorted Setå®ç°å‘¢ï¼Ÿ

äº‹å®ä¸Šå¾ˆç®€å•ï¼Œæ€è·¯å°±æ˜¯å°†æ¶‰åŠæ’åºçš„å¤šä¸ªç»´åº¦çš„åˆ—é€šè¿‡ä¸€å®šçš„æ–¹å¼è½¬æ¢æˆä¸€ä¸ªç‰¹æ®Šçš„åˆ—ï¼Œå³result = function(x, y,  z)ï¼Œå³xï¼Œyï¼Œzæ˜¯ä¸‰ä¸ªæ’åºå› å­ï¼Œä¾‹å¦‚ä¸‹è½½é‡ã€æ—¶é—´ç­‰ï¼Œé€šè¿‡è‡ªå®šä¹‰å‡½æ•°function()è®¡ç®—å¾—åˆ°resultï¼Œå°†resultä½œä¸ºSorted  Setä¸­çš„scoreçš„å€¼ï¼Œå°±èƒ½å®ç°ä»»æ„ç»´åº¦çš„æ’åºéœ€æ±‚äº†ã€‚å¯ä»¥å‚è€ƒç¬”è€…ä¹‹å‰çš„æ–‡ç« ï¼šã€Š[Redisé«˜çº§ç©æ³•ï¼šå¦‚ä½•åˆ©ç”¨SortedSetå®ç°å¤šç»´åº¦æ’åº](http://mp.weixin.qq.com/s?__biz=MzU5ODUwNzY1Nw==&mid=2247484672&idx=1&sn=34b75672e83e403429504eed420ed299&chksm=fe426ce6c935e5f00e2f3819e9e59caa29b596846bfcc722d0c30be40e5d338471c7beefb915&scene=21#wechat_redirect)ã€‹ã€‚





**å…­ã€å¤šæ€å‘½ä»¤çš„å®ç°**



å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œå¯¹è±¡åŒ…å«ç±»å‹ã€ç¼–ç ã€æŒ‡é’ˆã€å¼•ç”¨è®¡æ•°ã€ç©ºè½¬æ—¶é•¿ äº”ä¸ªå±æ€§ã€‚ç¼–ç åœ¨å’ŒæŒ‡é’ˆåœ¨å‰é¢å·²ç»åˆ†åˆ«é˜è¿°äº†å…·ä½“çš„å®ç°æ–¹å¼ã€‚é‚£ç±»å‹ä¸»è¦ç”¨äºå“ªæ–¹é¢å‘¢ï¼Ÿ



å…¶å®ï¼Œç±»å‹ä¸»è¦ç”¨äºåˆ¤æ–­ç”¨æˆ·æ‰§è¡Œä¸€ä¸ªå‘½ä»¤æ—¶ï¼Œæ£€æµ‹å‘½ä»¤çš„é”®æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œè¯¥å‘½ä»¤ã€‚å¦‚æœå¯ä»¥æ‰§è¡Œï¼Œåˆ™æœåŠ¡å™¨å°±å¯¹é”®æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œå¦åˆ™ï¼ŒæœåŠ¡å™¨ä¼šæ‹’ç»æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚



å¤šæ€ä¸»è¦çš„ä½“ç°ï¼Œæ˜¯å½“ä¸€ä¸ªå¯¹è±¡çš„åº•å±‚å®ç°ï¼Œä¸æ­¢ä¸€ç§ç¼–ç æ–¹å¼æ—¶ï¼Œéœ€è¦æ ¹æ®ç¼–ç æ–¹å¼è¿›è¡ŒåŒºåˆ†ï¼Œæ¥é€‰æ‹©æ­£ç¡®çš„å‘½ä»¤æ‰§è¡Œæ–¹å¼ã€‚



![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/Z33JZWhn1uNlqRNKxe0QFs8SmaxHGktTdziaLI3RABFBDezQUOcj0s8eI1P9hsnrmPVthWH2O6CaWROsABEDxZQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





**ä¸ƒã€å¼•ç”¨è®¡æ•°ã€ç©ºè½¬æ—¶é•¿**



1ï¼‰Redisåœ¨è‡ªå·±çš„å¯¹è±¡ç³»ç»Ÿä¸­ï¼Œæ„å»ºäº†ä¸€ä¸ªå¯¹è±¡å¼•ç”¨è®¡æ•°ï¼Œå¯ç”¨äºå†…å­˜å›æ”¶æœºåˆ¶ï¼Œä¹Ÿå¯å®ç°å¯¹è±¡çš„å…±äº«æœºåˆ¶ï¼Œè®©å¤šä¸ªæ•°æ®åº“å…±äº«ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨äºèŠ‚çº¦å†…å­˜çš„ä½œç”¨ã€‚

2ï¼‰å¯¹è±¡å¸¦æœ‰è®¿é—®æ—¶é—´è®°å½•ä¿¡æ¯ï¼Œç”¨äºåˆ é™¤ç©ºé—´è½¬æ—¶é—´è¾ƒå¤§çš„é‚£ä¸ªé”®ã€‚

# 3ç§é«˜çº§æ•°æ®ç»“æ„

Redisä¸­3ç§é«˜çº§æ•°æ®ç»“æ„åˆ†åˆ«æ˜¯bitmapã€GEOã€HyperLogLogï¼Œé’ˆå¯¹è¿™3ç§æ•°æ®ç»“æ„ï¼Œç¬”è€…ä¹‹å‰ä¹Ÿæœ‰æ–‡ç« ä»‹ç»è¿‡ã€‚å…¶ä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯**bitmap**ã€‚

### bitmap

è¿™ä¸ªå°±æ˜¯Rediså®ç°çš„BloomFilterï¼ŒBloomFilteréå¸¸ç®€å•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡è®¾å·²ç»æœ‰3ä¸ªå…ƒç´ aã€bå’Œcï¼Œåˆ†åˆ«é€šè¿‡3ä¸ªhashç®—æ³•h1()ã€h2()å’Œh2()è®¡ç®—ç„¶åå¯¹ä¸€ä¸ªbitè¿›è¡Œèµ‹å€¼ï¼Œæ¥ä¸‹æ¥å‡è®¾éœ€è¦åˆ¤æ–­dæ˜¯å¦å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦ä½¿ç”¨3ä¸ªhashç®—æ³•h1()ã€h2()å’Œh2()å¯¹dè¿›è¡Œè®¡ç®—ï¼Œç„¶åå¾—åˆ°3ä¸ªbitçš„å€¼ï¼Œæ°å¥½è¿™3ä¸ªbitçš„å€¼ä¸º1ï¼Œè¿™å°±èƒ½å¤Ÿè¯´æ˜ï¼š**då¯èƒ½å­˜åœ¨é›†åˆä¸­**ã€‚å†åˆ¤æ–­eï¼Œç”±äºh1(e)ç®—å‡ºæ¥çš„bitä¹‹å‰çš„å€¼æ˜¯0ï¼Œé‚£ä¹ˆè¯´æ˜ï¼š**eä¸€å®šä¸å­˜åœ¨é›†åˆä¸­**ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/4o22OFcmzHkibCHbibcjuQ2RR5ITRsxibiabvlYodLib40LkOOt8SOmBKKFwWQuZUnVibMOJPQwg2CvQnJkqJWqiaiahbA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)BloomFilter

éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œbitmapå¹¶ä¸æ˜¯ä¸€ç§çœŸå®çš„æ•°æ®ç»“æ„ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯Stringæ•°æ®ç»“æ„ï¼Œåªä¸è¿‡æ“ä½œçš„ç²’åº¦å˜æˆäº†ä½ï¼Œå³bitã€‚å› ä¸ºStringç±»å‹æœ€å¤§é•¿åº¦ä¸º512MBï¼Œæ‰€ä»¥bitmapæœ€å¤šå¯ä»¥å­˜å‚¨2^32ä¸ªbitã€‚

### GEO

GEOæ•°æ®ç»“æ„å¯ä»¥åœ¨Redisä¸­å­˜å‚¨åœ°ç†åæ ‡ï¼Œå¹¶ä¸”åæ ‡æœ‰é™åˆ¶ï¼Œç”±EPSG:900913 / EPSG:3785 / OSGEO:41001 è§„å®šå¦‚ä¸‹ï¼š

1. æœ‰æ•ˆçš„ç»åº¦ä»-180åº¦åˆ°180åº¦ã€‚
2. æœ‰æ•ˆçš„çº¬åº¦ä»-85.05112878åº¦åˆ°85.05112878åº¦ã€‚

å½“åæ ‡ä½ç½®è¶…å‡ºä¸Šè¿°æŒ‡å®šèŒƒå›´æ—¶ï¼Œè¯¥å‘½ä»¤å°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚æ·»åŠ åœ°ç†ä½ç½®å‘½ä»¤å¦‚ä¸‹ï¼š

```
redis> GEOADD city 114.031040 22.324386 "shenzhen" 112.572154 22.267832 "guangzhou"
(integer) 2
redis> GEODIST city shenzhen guangzhou
"150265.8106"
```

ä½†æ˜¯ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒGeoæœ¬èº«ä¸æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒ**æœ¬è´¨ä¸Šè¿˜æ˜¯å€ŸåŠ©äºSorted Setï¼ˆZSETï¼‰**ï¼Œå¹¶ä¸”ä½¿ç”¨**GeoHash**æŠ€æœ¯è¿›è¡Œå¡«å……ã€‚Redisä¸­å°†ç»çº¬åº¦ä½¿ç”¨52ä½çš„æ•´æ•°è¿›è¡Œç¼–ç ï¼Œæ”¾è¿›zsetä¸­ï¼Œscoreå°±æ˜¯GeoHashçš„52ä½æ•´æ•°å€¼ã€‚åœ¨ä½¿ç”¨Redisè¿›è¡ŒGeoæŸ¥è¯¢æ—¶ï¼Œå…¶å†…éƒ¨å¯¹åº”çš„æ“ä½œå…¶å®å°±æ˜¯zset(skiplist)çš„æ“ä½œã€‚é€šè¿‡zsetçš„scoreè¿›è¡Œæ’åºå°±å¯ä»¥å¾—åˆ°åæ ‡é™„è¿‘çš„å…¶å®ƒå…ƒç´ ï¼Œé€šè¿‡å°†scoreè¿˜åŸæˆåæ ‡å€¼å°±å¯ä»¥å¾—åˆ°å…ƒç´ çš„åŸå§‹åæ ‡ã€‚

æ€»ä¹‹ï¼ŒRedisä¸­å¤„ç†è¿™äº›åœ°ç†ä½ç½®åæ ‡ç‚¹çš„æ€æƒ³æ˜¯ï¼šäºŒç»´å¹³é¢åæ ‡ç‚¹ --> ä¸€ç»´æ•´æ•°ç¼–ç å€¼ --> zset(scoreä¸ºç¼–ç å€¼) -->  zrangebyrank(è·å–scoreç›¸è¿‘çš„å…ƒç´ )ã€zrangebyscore --> é€šè¿‡score(æ•´æ•°ç¼–ç å€¼)åè§£åæ ‡ç‚¹  --> é™„è¿‘ç‚¹çš„åœ°ç†ä½ç½®åæ ‡ã€‚

- GEOHASHåŸç†

ä½¿ç”¨wikiä¸Šçš„ä¾‹å­ï¼Œçº¬åº¦ä¸º42.6ï¼Œç»åº¦ä¸º-5.6çš„ç‚¹ï¼Œè½¬åŒ–ä¸ºbase32çš„è¯è¦å¦‚ä½•è½¬å‘¢ï¼Ÿ
é¦–å…ˆæ‹¿çº¬åº¦æ¥è¿›è¡Œè¯´æ˜ï¼Œçº¬åº¦çš„èŒƒå›´ä¸º-90åˆ°90ï¼Œå°†è¿™ä¸ªèŒƒå›´åˆ’ä¸ºä¸¤æ®µï¼Œåˆ™ä¸º[-90,0]ã€[0,90]ï¼Œç„¶åçœ‹ç»™å®šçš„çº¬åº¦åœ¨å“ªä¸ªèŒƒå›´ï¼Œåœ¨å‰é¢çš„èŒƒå›´çš„è¯ï¼Œå°±è®¾å½“å‰ä½ä¸º0ï¼Œåé¢çš„è¯å€¼ä¾¿ä¸º1.ç„¶åç»§ç»­å°†ç¡®å®šçš„èŒƒå›´1åˆ†ä¸º2ï¼Œç»§ç»­ä»¥ç¡®å®šå€¼åœ¨å‰æ®µè¿˜æ˜¯åæ®µæ¥ç¡®å®šbitçš„å€¼ã€‚å°±è¿™æ ·æ…¢æ…¢çš„ç¼©å°èŒƒå›´ï¼Œä¸€èˆ¬æœ€å¤šç¼©å°13æ¬¡å°±å¯ä»¥äº†(ç»çº¬åº¦çš„äºŒè¿›åˆ¶ä½ç›¸åŠ æœ€å¤š25ä½ï¼Œç»åº¦13ä½ï¼Œçº¬åº¦12ä½)ã€‚è¿™æ—¶çš„ä¸­é—´å€¼ï¼Œå°†è·Ÿç»™å®šçš„å€¼æœ€ç›¸è¿‘ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/4o22OFcmzHkibCHbibcjuQ2RR5ITRsxibiabiaDSknNiaVNOyalgNhJjMkNd5KjnuJlUa1olsHnUicvoaeIg4lfs3GnqQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)Geohash

ç¬¬1è¡Œï¼Œçº¬åº¦42.6ä½äº[0, 90]ä¹‹é—´ï¼Œæ‰€ä»¥bit=1ï¼›ç¬¬2è¡Œï¼Œçº¬åº¦42.6ä½äº[0, 45]ä¹‹é—´ï¼Œæ‰€ä»¥bit=0ï¼›ç¬¬3è¡Œï¼Œçº¬åº¦42.6ä½äº[22.5,  45]ä¹‹é—´ï¼Œæ‰€ä»¥bit=1ï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™æ ·ï¼Œå–å‡ºå›¾ä¸­çš„bitä½ï¼š1011 1100 1001ï¼ŒåŒæ ·çš„æ–¹æ³•ï¼Œå°†ç»åº¦(èŒƒå›´-180åˆ°180)ç®—å‡ºæ¥ä¸º ï¼š0111 1100 0000 0ã€‚ç»“æœå¯¹å…¶å¦‚ä¸‹ï¼š

```
# ç»åº¦
0111 1100 0000 0
# çº¬åº¦
1011 1100 1001
```

å¾—åˆ°äº†ç»çº¬åº¦çš„äºŒè¿›åˆ¶ä½åï¼Œä¸‹é¢éœ€è¦å°†ä¸¤è€…è¿›è¡Œç»“åˆï¼šä»ç»åº¦ã€çº¬åº¦çš„å¾ªç¯ï¼Œæ¯æ¬¡å–å…¶äºŒè¿›åˆ¶çš„ä¸€ä½(ä¸è¶³ä½å–0)ï¼Œåˆå¹¶ä¸ºæ–°çš„äºŒè¿›åˆ¶æ•°ï¼š01101111 11110000 01000001  0ã€‚æ¯5ä½ä¸ºä¸€ä¸ªåè¿›åˆ¶æ•°ï¼Œç»“åˆbase32å¯¹åº”è¡¨æ˜ å°„ä¸ºbase32å€¼ä¸ºï¼šezs42ã€‚è¿™æ ·å°±å®Œæˆäº†encodeçš„è¿‡ç¨‹ã€‚

# Streams

è¿™æ˜¯Redis5.0å¼•å…¥çš„å…¨æ–°æ•°æ®ç»“æ„ï¼Œè¿™ç§æ•°æ®ç»“æ„ç¬”è€…ä¹‹å‰ä¹Ÿæœ‰æ–‡ç« å¯¹å…¶è¿›è¡Œè¯¦ç»†è§£è¯»ï¼Œé“¾æ¥åœ°å€ï¼šã€Š[Streamsï¼šæ·±å…¥å‰–æRedis5.0å…¨æ–°æ•°æ®ç»“æ„](http://mp.weixin.qq.com/s?__biz=MzU5ODUwNzY1Nw==&mid=2247484059&idx=1&sn=83da3a7e3ec3219e0792129e27e9f7bc&chksm=fe426b7dc935e26b4c05c4e4755bc3308a32799a3ac8ed4521040522dd678258ded12101ccf2&scene=21#wechat_redirect)ã€‹ï¼Œç”¨ä¸€å¥è¯æ¦‚æ‹¬Streamså°±æ˜¯Rediså®ç°çš„å†…å­˜ç‰ˆkafkaã€‚è€Œä¸”ï¼ŒStreamsä¹Ÿæœ‰**Consumer Groups**çš„æ¦‚å¿µã€‚é€šè¿‡Redisæºç ä¸­å¯¹streamçš„å®šä¹‰æˆ‘ä»¬å¯çŸ¥ï¼Œstreamsåº•å±‚çš„æ•°æ®ç»“æ„æ˜¯**radix tree**ï¼š

```
typedef struct stream {
    rax *rax;               /* The radix tree holding the stream. */
    uint64_t length;        /* Number of elements inside this stream. */
    streamID last_id;       /* Zero if there are yet no items. */
    rax *cgroups;           /* Consumer groups dictionary: name -> streamCG */
} stream;
```

é‚£ä¹ˆè¿™ä¸ªradix treeé•¿å•¥æ ·å‘¢ï¼Ÿåœ¨Redisæºç çš„rax.hæ–‡ä»¶ä¸­æœ‰ä¸€æ®µè¿™æ ·çš„æè¿°ï¼Œè¿™æ ·çœ‹èµ·æ¥æ˜¯ä¸æ˜¯å°±æ¯”è¾ƒç›´è§‚äº†ï¼š

```
 *                    (f) ""
 *                    /
 *                 (i o) "f"
 *                 /   \
 *    "firs"  ("rst")  (o) "fo"
 *              /        \
 *    "first" []       [t   b] "foo"
 *                     /     \
 *           "foot" ("er")    ("ar") "foob"
 *                    /          \
 *          "footer" []          [] "foobar"
```

**Radix Tree(åŸºæ•°æ ‘) äº‹å®ä¸Šå°±å‡ ä¹ç›¸åŒæ˜¯ä¼ ç»Ÿçš„äºŒå‰æ ‘**ã€‚ä»…ä»…æ˜¯åœ¨å¯»æ‰¾æ–¹å¼ä¸Šï¼Œä»¥ä¸€ä¸ªunsigned  intç±»å‹æ•°ä¸ºä¾‹ï¼Œåˆ©ç”¨è¿™ä¸ªæ•°çš„æ¯ä¸ªæ¯”ç‰¹ä½ä½œä¸ºæ ‘èŠ‚ç‚¹çš„æ¨æ–­ã€‚èƒ½å¤Ÿè¿™æ ·è¯´ï¼Œæ¯”æ–¹ä¸€ä¸ªæ•°10001010101010110101010ï¼Œé‚£ä¹ˆä¾ç…§Radix  æ ‘çš„æ’å…¥å°±æ˜¯åœ¨æ ¹èŠ‚ç‚¹ï¼Œå‡è®¾é‡åˆ°0ï¼Œå°±æŒ‡å‘å·¦èŠ‚ç‚¹ï¼Œå‡è®¾é‡åˆ°1å°±æŒ‡å‘å³èŠ‚ç‚¹ï¼Œåœ¨æ’å…¥è¿‡ç¨‹ä¸­æ„é€ æ ‘èŠ‚ç‚¹ï¼Œåœ¨åˆ é™¤è¿‡ç¨‹ä¸­åˆ é™¤æ ‘èŠ‚ç‚¹ã€‚å¦‚ä¸‹æ˜¯ä¸€ä¸ªä¿å­˜äº†7ä¸ªå•è¯çš„Radix Treeï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/4o22OFcmzHkibCHbibcjuQ2RR5ITRsxibiabeQJxnxp80LNBWEnxShCwHwOdD83L4ib2AycJQDIia7kyEacgmpibuDibyQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)radix tree





**å…«ã€é‡ç‚¹å›é¡¾**



æœ¬æ–‡ä¸»è¦å­¦ä¹ åˆ°ï¼Œredisçš„äº”å¤§æ•°æ®å¯¹è±¡ï¼Œæˆ‘ä»¬çŸ¥é“redisä¸­çš„æ¯ä¸ªé”®å€¼å¯¹å…¶å®éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ¯ä¸ªå¯¹è±¡çš„åº•å±‚å®ç°éƒ½è‡³å°‘é‡‡ç”¨ä¸¤ç§ä»¥ä¸Šçš„ç¼–ç æ–¹å¼æ¥æé«˜redisçš„æ€§èƒ½å’Œæ•ˆç‡ã€‚å¦å¤–ï¼Œredisè¿˜æ”¯æŒå¼•ç”¨è®¡æ•°å’Œå†…å­˜å…±äº«æœºåˆ¶ã€‚ç”¨äºæé«˜å¯¹è±¡çš„æœ€å¤§åŒ–åˆ©ç”¨å’Œå¿«é€Ÿé‡Šæ”¾æ— ç”¨å¯¹è±¡ã€‚å½“æˆ‘ä»¬æ‰§è¡Œæ¯ä¸€ä¸ªrediså‘½ä»¤æ—¶ï¼Œrediséƒ½ä¼šé¦–å…ˆæ£€æµ‹è¯¥å‘½ä»¤çš„é”®æ˜¯å¦æ”¯æŒæ‰§è¡Œè¯¥å‘½ä»¤ï¼Œè‹¥ä¸æ”¯æŒï¼Œåˆ™æŠ¥ç±»å‹å¼‚å¸¸ã€‚

### 1.string

1. **ä»‹ç»ï¼š** string æ˜¯ redis æœ€åŸºæœ¬çš„ç±»å‹ï¼Œå¯ä»¥ç†è§£æˆä¸ memcached ä¸€æ¨¡ä¸€æ ·çš„ç±»å‹ï¼Œä¸€ä¸ª key å¯¹åº”ä¸€ä¸ª valueã€‚value  ä¸ä»…æ˜¯ stringï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°å­—ã€‚string ç±»å‹æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œæ„æ€æ˜¯ redis çš„ string ç±»å‹å¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ï¼Œæ¯”å¦‚ jpg  å›¾ç‰‡æˆ–è€…åºåˆ—åŒ–çš„å¯¹è±¡ã€‚string ç±»å‹çš„å€¼æœ€å¤§èƒ½å­˜å‚¨ 512Mã€‚
2. **å¸¸ç”¨å‘½ä»¤:** set,get,decr,incr,mget ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯** ï¼šå¸¸è§„ key-value ç¼“å­˜åº”ç”¨ï¼›å¸¸è§„è®¡æ•°ï¼šå¾®åšæ•°ï¼Œç²‰ä¸æ•°ç­‰ã€‚

### 2.Hash

1. **ä»‹ç»** ï¼šHash æ˜¯ä¸€ä¸ªé”®å€¼ï¼ˆkey-valueï¼‰çš„é›†åˆã€‚redis çš„ hash æ˜¯ä¸€ä¸ª string çš„ key å’Œ value çš„æ˜ å°„è¡¨ï¼ŒHash ç‰¹åˆ«é€‚åˆå­˜å‚¨å¯¹è±¡ã€‚å¸¸ç”¨å‘½ä»¤ï¼šhget,hset,hgetall ç­‰ã€‚
2. **å¸¸ç”¨å‘½ä»¤** ï¼šhget,hset,hgetall ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯** ï¼šhash ç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡ï¼Œåç»­æ“ä½œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç›´æ¥ä»…ä»…ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„æŸä¸ªå­—æ®µçš„å€¼ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ hash æ•°æ®ç»“æ„æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œå•†å“ä¿¡æ¯ç­‰ç­‰ã€‚æ¯”å¦‚ä¸‹é¢æˆ‘å°±ç”¨ hash ç±»å‹å­˜æ”¾äº†æˆ‘æœ¬äººçš„ä¸€äº›ä¿¡æ¯ï¼š

```
key=JavaUser293847
value={
  â€œidâ€: 1,
  â€œnameâ€: â€œSnailClimbâ€,
  â€œageâ€: 24,
  â€œlocationâ€: â€œWuhan, Hubeiâ€
}
```

### 3.list

1. **ä»‹ç»** ï¼šlist åˆ—è¡¨æ˜¯ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼ŒæŒ‰ç…§æ’å…¥é¡ºåºæ’åºã€‚å¯ä»¥æ·»åŠ ä¸€ä¸ªå…ƒç´ åˆ°åˆ—è¡¨çš„å¤´éƒ¨ï¼ˆå·¦è¾¹ï¼‰æˆ–è€…å°¾éƒ¨ï¼ˆå³è¾¹ï¼‰ ï¼š
2. **å¸¸ç”¨å‘½ä»¤ï¼š**lpushã€rpushã€lpopã€rpopã€lrange(è·å–åˆ—è¡¨ç‰‡æ®µ)ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯** ï¼šlist åº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œä¹Ÿæ˜¯ Redis æœ€é‡è¦çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œæ¯”å¦‚ twitter çš„å…³æ³¨åˆ—è¡¨ï¼Œç²‰ä¸åˆ—è¡¨éƒ½å¯ä»¥ç”¨ list ç»“æ„æ¥å®ç°ã€‚

> **list å°±æ˜¯é“¾è¡¨ï¼Œå¯ä»¥ç”¨æ¥å½“æ¶ˆæ¯é˜Ÿåˆ—ç”¨ã€‚redis æä¾›äº† List çš„ push å’Œ pop æ“ä½œï¼Œè¿˜æä¾›äº†æ“ä½œæŸä¸€æ®µçš„  apiï¼Œå¯ä»¥ç›´æ¥æŸ¥è¯¢æˆ–è€…åˆ é™¤æŸä¸€æ®µçš„å…ƒç´ ã€‚redis list  çš„æ˜¯å®ç°æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ—¢å¯ä»¥æ”¯æŒåå‘æŸ¥æ‰¾å’Œéå†ï¼Œæ›´æ–¹ä¾¿æ“ä½œï¼Œä¸è¿‡å¸¦æ¥äº†é¢å¤–çš„å†…å­˜å¼€é”€ã€‚**

### 4.set

1. **ä»‹ç»** ï¼šset æ˜¯ string ç±»å‹çš„æ— åºé›†åˆã€‚é›†åˆæ˜¯é€šè¿‡ hashtable å®ç°çš„ã€‚set ä¸­çš„å…ƒç´ æ˜¯æ²¡æœ‰é¡ºåºçš„ï¼Œè€Œä¸”æ˜¯æ²¡æœ‰é‡å¤çš„ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** sddã€spopã€smembersã€sunion ç­‰ã€‚
3. **åº”ç”¨åœºæ™¯** ï¼šredis set å¯¹å¤–æä¾›çš„åŠŸèƒ½å’Œ list ä¸€æ ·æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äº set æ˜¯è‡ªåŠ¨å»é‡çš„ï¼Œè€Œä¸” set æä¾›äº†åˆ¤æ–­æŸä¸ªæˆå‘˜æ˜¯å¦åœ¨ä¸€ä¸ª set é›†åˆä¸­ã€‚

### 5.zset

1. **ä»‹ç»** ï¼šzset å’Œ set ä¸€æ ·æ˜¯ string ç±»å‹å…ƒç´ çš„é›†åˆï¼Œä¸”ä¸å…è®¸é‡å¤çš„å…ƒç´ ã€‚
2. **å¸¸ç”¨å‘½ä»¤ï¼š** zaddã€zrangeã€zremã€zcard ç­‰ã€‚
3. **ä½¿ç”¨åœºæ™¯ï¼š**sorted set  å¯ä»¥é€šè¿‡ç”¨æˆ·é¢å¤–æä¾›ä¸€ä¸ªä¼˜å…ˆçº§ï¼ˆscoreï¼‰çš„å‚æ•°æ¥ä¸ºæˆå‘˜æ’åºï¼Œå¹¶ä¸”æ˜¯æ’å…¥æœ‰åºçš„ï¼Œå³è‡ªåŠ¨æ’åºã€‚å½“ä½ éœ€è¦ä¸€ä¸ªæœ‰åºçš„å¹¶ä¸”ä¸é‡å¤çš„é›†åˆåˆ—è¡¨ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹© sorted set ç»“æ„ã€‚å’Œ set ç›¸æ¯”ï¼Œsorted set å…³è”äº†ä¸€ä¸ª double ç±»å‹æƒé‡çš„å‚æ•°  scoreï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ç…§ score è¿›è¡Œæœ‰åºæ’åˆ—ï¼Œredis æ­£æ˜¯é€šè¿‡åˆ†æ•°æ¥ä¸ºé›†åˆä¸­çš„æˆå‘˜è¿›è¡Œä»å°åˆ°å¤§çš„æ’åºã€‚

> **Redis sorted set çš„å†…éƒ¨ä½¿ç”¨ HashMap å’Œè·³è·ƒè¡¨(skipList)æ¥ä¿è¯æ•°æ®çš„å­˜å‚¨å’Œæœ‰åºï¼ŒHashMap é‡Œæ”¾çš„æ˜¯æˆå‘˜åˆ°  score çš„æ˜ å°„ï¼Œè€Œè·³è·ƒè¡¨é‡Œå­˜æ”¾çš„æ˜¯æ‰€æœ‰çš„æˆå‘˜ï¼Œæ’åºä¾æ®æ˜¯ HashMap é‡Œå­˜çš„  scoreï¼Œä½¿ç”¨è·³è·ƒè¡¨çš„ç»“æ„å¯ä»¥è·å¾—æ¯”è¾ƒé«˜çš„æŸ¥æ‰¾æ•ˆç‡ï¼Œå¹¶ä¸”åœ¨å®ç°ä¸Šæ¯”è¾ƒç®€å•ã€‚**

**Redis æ•°æ®ç±»å‹åº”ç”¨åœºæ™¯æ€»ç»“:**

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicLwYfVaFWKQapY9hjXAaT8J5Oasmt7qEiadkZJFNLucBF04YeO597Q1A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



**æˆ‘** ï¼šæˆ‘æ˜¯ç»“åˆ Spring Boot ä½¿ç”¨çš„ã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š

1. æ¥é€šè¿‡ `RedisTemplate` æ¥ä½¿ç”¨
2. ä½¿ç”¨ Spring Cache é›†æˆ Redis pom.xml ä¸­åŠ å…¥ä»¥ä¸‹ä¾èµ–ï¼š

ç®€å•è¯´ä¸€ä¸‹ä»£ç å§ï¼

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-pool2</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.session</groupId>
        <artifactId>spring-session-data-redis</artifactId>
    </dependency>

    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

- **spring-boot-starter-data-redis** :åœ¨ spring boot 2.x ä»¥ååº•å±‚ä¸å†ä½¿ç”¨ Jedisï¼Œè€Œæ˜¯æ¢æˆäº† Lettuceã€‚
- **commons-pool2** ï¼šç”¨ä½œ redis è¿æ¥æ± ï¼Œå¦‚ä¸å¼•å…¥å¯åŠ¨ä¼šæŠ¥é”™
- **spring-session-data-redis** ï¼šspring session å¼•å…¥ï¼Œç”¨ä½œå…±äº« sessionã€‚é…ç½®æ–‡ä»¶

`application.yml` çš„é…ç½®ï¼š

```yml
server:
  port: 8082
  servlet:
    session:
      timeout: 30ms
spring:
  cache:
    type: redis
  redis:
    host: 127.0.0.1
    port: 6379
    password:
    # redisé»˜è®¤æƒ…å†µä¸‹æœ‰16ä¸ªåˆ†ç‰‡ï¼Œè¿™é‡Œé…ç½®å…·ä½“ä½¿ç”¨çš„åˆ†ç‰‡ï¼Œé»˜è®¤ä¸º0
    database: 0
    lettuce:
      pool:
        # è¿æ¥æ± æœ€å¤§è¿æ¥æ•°(ä½¿ç”¨è´Ÿæ•°è¡¨ç¤ºæ²¡æœ‰é™åˆ¶),é»˜è®¤8
        max-active: 100
```

åˆ›å»ºå®ä½“ç±» `User.java`

```java
public class User implements Serializable{

    private static final long serialVersionUID = 662692455422902539L;

    private Integer id;

    private String name;

    private Integer age;

    public User() {
    }

    public User(Integer id, String name, Integer age) {
        this.id = id;
        this.name = name;
        this.age = age;
    }

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Integer getAge() {
        return age;
    }

    public void setAge(Integer age) {
        this.age = age;
    }

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", age=" + age +
                '}';
    }
}
```

### RedisTemplate çš„ä½¿ç”¨æ–¹å¼

é»˜è®¤æƒ…å†µä¸‹çš„æ¨¡æ¿åªèƒ½æ”¯æŒ `RedisTemplate<String, String>`ï¼Œä¹Ÿå°±æ˜¯åªèƒ½å­˜å…¥å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è‡ªå®šä¹‰æ¨¡æ¿å¾ˆæœ‰å¿…è¦ã€‚æ·»åŠ é…ç½®ç±» `RedisCacheConfig.java`

```java
@Configuration
@AutoConfigureAfter(RedisAutoConfiguration.class)
public class RedisCacheConfig {

    @Bean
    public RedisTemplate<String, Serializable> redisCacheTemplate(LettuceConnectionFactory connectionFactory) {

        RedisTemplate<String, Serializable> template = new RedisTemplate<>();
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setConnectionFactory(connectionFactory);
        return template;
    }
}
```

æµ‹è¯•ç±»ï¼š

```java
@RestController
@RequestMapping("/user")
public class UserController {

    public static Logger logger = LogManager.getLogger(UserController.class);

    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    @Autowired
    private RedisTemplate<String, Serializable> redisCacheTemplate;

    @RequestMapping("/test")
    public void test() {
        redisCacheTemplate.opsForValue().set("userkey", new User(1, "å¼ ä¸‰", 25));
        User user = (User) redisCacheTemplate.opsForValue().get("userkey");
        logger.info("å½“å‰è·å–å¯¹è±¡ï¼š{}", user.toString());
    }
```

ç„¶ååœ¨æµè§ˆå™¨è®¿é—®ï¼Œè§‚å¯Ÿåå°æ—¥å¿— http://localhost:8082/user/test ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicKPgg6GZwgftdOp8IcbvicF7CYY3Mib3pGFt05msY0bC72aojheBnDfCw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### ä½¿ç”¨ Spring Cache é›†æˆ Redis

Spring Cache å…·å¤‡å¾ˆå¥½çš„çµæ´»æ€§ï¼Œä¸ä»…èƒ½å¤Ÿä½¿ç”¨ SPELï¼ˆspring expression languageï¼‰æ¥å®šä¹‰ç¼“å­˜çš„ Key å’Œå„ç§  Conditionï¼Œè¿˜æä¾›äº†å¼€ç®±å³ç”¨çš„ç¼“å­˜ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆï¼Œä¹Ÿæ”¯æŒå’Œä¸»æµçš„ä¸“ä¸šç¼“å­˜å¦‚ EhCacheã€Redisã€Guava çš„é›†æˆã€‚

å®šä¹‰æ¥å£ `UserService.java`

```java
public interface UserService {

    User save(User user);

    void delete(int id);

    User get(Integer id);
}
```

æ¥å£å®ç°ç±» `UserServiceImpl.java`

```java
@Service
public class UserServiceImpl implements UserService{

    public static Logger logger = LogManager.getLogger(UserServiceImpl.class);

    private static Map<Integer, User> userMap = new HashMap<>();
    static {
        userMap.put(1, new User(1, "è‚–æˆ˜", 25));
        userMap.put(2, new User(2, "ç‹ä¸€åš", 26));
        userMap.put(3, new User(3, "æ¨ç´«", 24));
    }


    @CachePut(value ="user", key = "#user.id")
    @Override
    public User save(User user) {
        userMap.put(user.getId(), user);
        logger.info("è¿›å…¥saveæ–¹æ³•ï¼Œå½“å‰å­˜å‚¨å¯¹è±¡ï¼š{}", user.toString());
        return user;
    }

    @CacheEvict(value="user", key = "#id")
    @Override
    public void delete(int id) {
        userMap.remove(id);
        logger.info("è¿›å…¥deleteæ–¹æ³•ï¼Œåˆ é™¤æˆåŠŸ");
    }

    @Cacheable(value = "user", key = "#id")
    @Override
    public User get(Integer id) {
        logger.info("è¿›å…¥getæ–¹æ³•ï¼Œå½“å‰è·å–å¯¹è±¡ï¼š{}", userMap.get(id)==null?null:userMap.get(id).toString());
        return userMap.get(id);
    }
}
```

ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºæ•°æ®åº“çš„æ“ä½œï¼Œè¿™é‡Œç›´æ¥å®šä¹‰äº†ä¸€ä¸ª`Map<Integer,User> userMap`ã€‚

è¿™é‡Œçš„æ ¸å¿ƒæ˜¯ä¸‰ä¸ªæ³¨è§£ï¼š

- **`@Cachable`**
- **`@CachePut`**
- **`@CacheEvict`**

æµ‹è¯•ç±»ï¼š`UserController`

```java
@RestController
@RequestMapping("/user")
public class UserController {

    public static Logger logger = LogManager.getLogger(UserController.class);

    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    @Autowired
    private RedisTemplate<String, Serializable> redisCacheTemplate;

    @Autowired
    private UserService userService;

    @RequestMapping("/test")
    public void test() {
        redisCacheTemplate.opsForValue().set("userkey", new User(1, "å¼ ä¸‰", 25));
        User user = (User) redisCacheTemplate.opsForValue().get("userkey");
        logger.info("å½“å‰è·å–å¯¹è±¡ï¼š{}", user.toString());
    }


    @RequestMapping("/add")
    public void add() {
        User user = userService.save(new User(4, "æç°", 30));
        logger.info("æ·»åŠ çš„ç”¨æˆ·ä¿¡æ¯ï¼š{}",user.toString());
    }

    @RequestMapping("/delete")
    public void delete() {
        userService.delete(4);
    }

    @RequestMapping("/get/{id}")
    public void get(@PathVariable("id") String idStr) throws Exception{
        if (StringUtils.isBlank(idStr)) {
            throw new Exception("idä¸ºç©º");
        }
        Integer id = Integer.parseInt(idStr);
        User user = userService.get(id);
        logger.info("è·å–çš„ç”¨æˆ·ä¿¡æ¯ï¼š{}",user.toString());
    }
}
```

ç”¨ç¼“å­˜è¦æ³¨æ„ï¼Œå¯åŠ¨ç±»è¦åŠ ä¸Šä¸€ä¸ªæ³¨è§£å¼€å¯ç¼“å­˜ï¼š

```java
@SpringBootApplication(exclude=DataSourceAutoConfiguration.class)
@EnableCaching
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

}
```

1ã€å…ˆè°ƒç”¨æ·»åŠ æ¥å£ï¼šhttp://localhost:8082/user/add

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMickTjd9sMMcqa12oZcEwyX8DON4ZY06jzdDQsFS1xpjIyO9emCIJIksA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

2ã€å†è°ƒç”¨æŸ¥è¯¢æ¥å£ï¼ŒæŸ¥è¯¢ id=4 çš„ç”¨æˆ·ä¿¡æ¯ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicCoQMnNiaxmBxyBRcjKHSkU1a2Bdvlwg8fD3QfMyafxSFCvTHNIpycSw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œå·²ç»ä»ç¼“å­˜ä¸­è·å–æ•°æ®äº†ï¼Œå› ä¸ºä¸Šä¸€æ­¥ add æ–¹æ³•å·²ç»æŠŠ id=4 çš„ç”¨æˆ·æ•°æ®æ”¾å…¥äº† redis ç¼“å­˜ 3ã€è°ƒç”¨åˆ é™¤æ–¹æ³•ï¼Œåˆ é™¤ id=4 çš„ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒæ—¶æ¸…é™¤ç¼“å­˜

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicQA12AiaboqAvdBUwsyZdpNick3kXCRQ2TwNpHYxibxxgpWsiaKDoobjSgg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

4ã€å†æ¬¡è°ƒç”¨æŸ¥è¯¢æ¥å£ï¼ŒæŸ¥è¯¢ id=4 çš„ç”¨æˆ·ä¿¡æ¯ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicVCibQCZOjpNsejaCQF8mDB6rlVvSKkBmyRl6NtCEBR4Hs0tialM4uKsQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

æ²¡æœ‰äº†ç¼“å­˜ï¼Œæ‰€ä»¥è¿›å…¥äº† get æ–¹æ³•ï¼Œä» userMap ä¸­è·å–ã€‚

#### ç¼“å­˜æ³¨è§£

1ã€`@Cacheable` æ ¹æ®æ–¹æ³•çš„è¯·æ±‚å‚æ•°å¯¹å…¶ç»“æœè¿›è¡Œç¼“å­˜

- keyï¼šç¼“å­˜çš„ keyï¼Œå¯ä»¥ä¸ºç©ºï¼Œå¦‚æœæŒ‡å®šè¦æŒ‰ç…§ SPEL è¡¨è¾¾å¼ç¼–å†™ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™æŒ‰ç…§æ–¹æ³•çš„æ‰€æœ‰å‚æ•°è¿›è¡Œç»„åˆã€‚
- valueï¼šç¼“å­˜çš„åç§°ï¼Œå¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªï¼ˆå¦‚ @Cacheable (value='user')æˆ–è€…@Cacheable(value={'user1','user2'})ï¼‰
- conditionï¼šç¼“å­˜çš„æ¡ä»¶ï¼Œå¯ä»¥ä¸ºç©ºï¼Œä½¿ç”¨ SPEL ç¼–å†™ï¼Œè¿”å› true æˆ–è€… falseï¼Œåªæœ‰ä¸º true æ‰è¿›è¡Œç¼“å­˜ã€‚

> `@Cacheable` æ³¨è§£ä¸æ”¯æŒé…ç½®è¿‡æœŸæ—¶é—´ï¼Œæ‰€æœ‰éœ€è¦é€šè¿‡é…ç½® **cacheManager**æ¥é…ç½®é»˜è®¤çš„è¿‡æœŸæ—¶é—´å’Œé’ˆå¯¹æ¯ä¸ªç±»æˆ–è€…æ˜¯æ–¹æ³•è¿›è¡Œç¼“å­˜å¤±æ•ˆæ—¶é—´é…ç½®ã€‚

2ã€`@CachePut`æ ¹æ®æ–¹æ³•çš„è¯·æ±‚å‚æ•°å¯¹å…¶ç»“æœè¿›è¡Œç¼“å­˜ï¼Œå’Œ@Cacheable ä¸åŒçš„æ˜¯ï¼Œå®ƒæ¯æ¬¡éƒ½ä¼šè§¦å‘çœŸå®æ–¹æ³•çš„è°ƒç”¨ã€‚å‚æ•°æè¿°è§ä¸Šã€‚

3ã€`@CacheEvict`æ ¹æ®æ¡ä»¶å¯¹ç¼“å­˜è¿›è¡Œæ¸…ç©º

- keyï¼šåŒä¸Š
- valueï¼šåŒä¸Š
- conditionï¼šåŒä¸Š
- allEntriesï¼šæ˜¯å¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å†…å®¹ï¼Œç¼ºçœä¸º falseï¼Œå¦‚æœæŒ‡å®šä¸º trueï¼Œåˆ™æ–¹æ³•è°ƒç”¨åå°†ç«‹å³æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
- beforeInvocationï¼šæ˜¯å¦åœ¨æ–¹æ³•æ‰§è¡Œå‰å°±æ¸…ç©ºï¼Œç¼ºçœä¸º falseï¼Œå¦‚æœæŒ‡å®šä¸º trueï¼Œåˆ™åœ¨æ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œçš„æ—¶å€™å°±æ¸…ç©ºç¼“å­˜ã€‚ç¼ºçœæƒ…å†µä¸‹ï¼Œå¦‚æœæ–¹æ³•æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ä¸ä¼šæ¸…ç©ºç¼“å­˜ã€‚

### ç¼“å­˜é—®é¢˜

ğŸ™â€â™‚ï¸**é¢è¯•å®˜**ï¼šçœ‹äº†ä¸€ä¸‹ä½ çš„ demoï¼Œç®€å•æ˜“æ‡‚ã€‚é‚£ä½ åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨ç¼“å­˜æœ‰é‡åˆ°ä»€ä¹ˆé—®é¢˜æˆ–è€…ä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ä½ çŸ¥é“å—ï¼Ÿ

**ğŸ™‹ æˆ‘ï¼š** ï¼š**ç¼“å­˜å’Œæ•°æ®åº“æ•°æ®ä¸€è‡´æ€§é—®é¢˜**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹éå¸¸å®¹æ˜“å‡ºç°ç¼“å­˜å’Œæ•°æ®åº“é—´æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€ç‚¹ï¼Œå¦‚æœé¡¹ç›®å¯¹ç¼“å­˜çš„è¦æ±‚æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼Œé‚£ä¹ˆå°±ä¸è¦ä½¿ç”¨ç¼“å­˜ã€‚æˆ‘ä»¬åªèƒ½é‡‡å–åˆé€‚çš„ç­–ç•¥æ¥é™ä½ç¼“å­˜å’Œæ•°æ®åº“é—´æ•°æ®ä¸ä¸€è‡´çš„æ¦‚ç‡ï¼Œè€Œæ— æ³•ä¿è¯ä¸¤è€…é—´çš„å¼ºä¸€è‡´æ€§ã€‚åˆé€‚çš„ç­–ç•¥åŒ…æ‹¬åˆé€‚çš„ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼Œæ›´æ–°æ•°æ®åº“ååŠæ—¶æ›´æ–°ç¼“å­˜ã€ç¼“å­˜å¤±è´¥æ—¶å¢åŠ é‡è¯•æœºåˆ¶ã€‚

ğŸ™â€â™‚ï¸**é¢è¯•å®˜** : **Redis é›ªå´©**äº†è§£å—ï¼Ÿ

**ğŸ™‹ æˆ‘ï¼š**  ï¼šæˆ‘äº†è§£çš„ï¼Œç›®å‰ç”µå•†é¦–é¡µä»¥åŠçƒ­ç‚¹æ•°æ®éƒ½ä¼šå»åšç¼“å­˜ï¼Œä¸€èˆ¬ç¼“å­˜éƒ½æ˜¯å®šæ—¶ä»»åŠ¡å»åˆ·æ–°ï¼Œæˆ–è€…æŸ¥ä¸åˆ°ä¹‹åå»æ›´æ–°ç¼“å­˜çš„ï¼Œå®šæ—¶ä»»åŠ¡åˆ·æ–°å°±æœ‰ä¸€ä¸ªé—®é¢˜ã€‚ä¸¾ä¸ªæ —å­ï¼šå¦‚æœé¦–é¡µæ‰€æœ‰ Key çš„å¤±æ•ˆæ—¶é—´éƒ½æ˜¯ 12 å°æ—¶ï¼Œä¸­åˆ 12 ç‚¹åˆ·æ–°çš„ï¼Œæˆ‘é›¶ç‚¹æœ‰ä¸ªå¤§ä¿ƒæ´»åŠ¨å¤§é‡ç”¨æˆ·æ¶Œå…¥ï¼Œå‡è®¾æ¯ç§’ 6000 ä¸ªè¯·æ±‚ï¼Œæœ¬æ¥ç¼“å­˜å¯ä»¥æŠ—ä½æ¯ç§’  5000 ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯ç¼“å­˜ä¸­æ‰€æœ‰ Key éƒ½å¤±æ•ˆäº†ã€‚æ­¤æ—¶ 6000 ä¸ª/ç§’çš„è¯·æ±‚å…¨éƒ¨è½åœ¨äº†æ•°æ®åº“ä¸Šï¼Œæ•°æ®åº“å¿…ç„¶æ‰›ä¸ä½ï¼ŒçœŸå®æƒ…å†µå¯èƒ½ DBA  éƒ½æ²¡ååº”è¿‡æ¥ç›´æ¥æŒ‚äº†ï¼Œæ­¤æ—¶ï¼Œå¦‚æœæ²¡ä»€ä¹ˆç‰¹åˆ«çš„æ–¹æ¡ˆæ¥å¤„ç†ï¼ŒDBA å¾ˆç€æ€¥ï¼Œé‡å¯æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ç«‹é©¬åˆè¢«æ–°æµé‡ç»™æ‰“æ­»äº†ã€‚è¿™å°±æ˜¯æˆ‘ç†è§£çš„ç¼“å­˜é›ªå´©ã€‚

æˆ‘å¿ƒæƒ³ï¼šåŒä¸€æ—¶é—´å¤§é¢ç§¯å¤±æ•ˆï¼Œç¬é—´ Redis  è·Ÿæ²¡æœ‰ä¸€æ ·ï¼Œé‚£è¿™ä¸ªæ•°é‡çº§åˆ«çš„è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“å‡ ä¹æ˜¯ç¾éš¾æ€§çš„ï¼Œä½ æƒ³æƒ³å¦‚æœæŒ‚çš„æ˜¯ä¸€ä¸ªç”¨æˆ·æœåŠ¡çš„åº“ï¼Œé‚£å…¶ä»–ä¾èµ–ä»–çš„åº“æ‰€æœ‰æ¥å£å‡ ä¹éƒ½ä¼šæŠ¥é”™ï¼Œå¦‚æœæ²¡åšç†”æ–­ç­‰ç­–ç•¥åŸºæœ¬ä¸Šå°±æ˜¯ç¬é—´æŒ‚ä¸€ç‰‡çš„èŠ‚å¥ï¼Œä½ æ€ä¹ˆé‡å¯ç”¨æˆ·éƒ½ä¼šæŠŠä½ æ‰“æŒ‚ï¼Œç­‰ä½ é‡å¯å¥½çš„æ—¶å€™ï¼Œç”¨æˆ·æ—©ç¡è§‰å»äº†ï¼Œä¸´ç¡ä¹‹å‰ï¼Œéª‚éª‚å’§å’§â€œä»€ä¹ˆåƒåœ¾äº§å“â€ã€‚

ğŸ™â€â™‚ï¸**é¢è¯•å®˜** ï¼šå—¯ï¼Œè¿˜ä¸é”™ï¼Œé‚£è¿™ç§æƒ…å†µä½ éƒ½æ˜¯æ€ä¹ˆåº”å¯¹çš„ï¼Ÿï¼ˆé¢è¯•å®˜æ‘¸æ‘¸äº†è‡ªå·±çš„å¤´å‘ï¼‰

**ğŸ™‹ æˆ‘**ï¼šå¤„ç†ç¼“å­˜é›ªå´©ç®€å•ï¼Œåœ¨æ‰¹é‡å¾€ Redis å­˜æ•°æ®çš„æ—¶å€™ï¼ŒæŠŠæ¯ä¸ª Key çš„å¤±æ•ˆæ—¶é—´éƒ½åŠ ä¸ªéšæœºå€¼å°±å¥½äº†ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ•°æ®ä¸ä¼šå†åŒä¸€æ—¶é—´å¤§é¢ç§¯å¤±æ•ˆã€‚

```
setRedisï¼ˆkey, value, time+Math.random()*10000ï¼‰;
```

å¦‚æœ Redis æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œå°†çƒ­ç‚¹æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒçš„ Redis åº“ä¸­ä¹Ÿèƒ½é¿å…å…¨éƒ¨å¤±æ•ˆã€‚æˆ–è€…è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸï¼Œæœ‰æ›´æ–°æ“ä½œå°±æ›´æ–°ç¼“å­˜å°±å¥½äº†ï¼ˆæ¯”å¦‚è¿ç»´æ›´æ–°äº†é¦–é¡µå•†å“ï¼Œé‚£ä½ åˆ·ä¸‹ç¼“å­˜å°±å¥½äº†ï¼Œä¸è¦è®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰ï¼Œç”µå•†é¦–é¡µçš„æ•°æ®ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ“ä½œï¼Œä¿é™©ã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜**ï¼šé‚£ä½ äº†è§£**ç¼“å­˜ç©¿é€å’Œå‡»ç©¿**ä¹ˆï¼Œå¯ä»¥è¯´è¯´ä»–ä»¬è·Ÿé›ªå´©çš„åŒºåˆ«å—ï¼Ÿ

**ğŸ™‹ æˆ‘**ï¼šå—¯ï¼Œäº†è§£ï¼Œå…ˆè¯´ä¸‹ç¼“å­˜ç©¿é€å§ï¼Œç¼“å­˜ç©¿é€æ˜¯æŒ‡ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œè€Œç”¨æˆ·ï¼ˆé»‘å®¢ï¼‰ä¸æ–­å‘èµ·è¯·æ±‚ï¼Œä¸¾ä¸ªæ —å­ï¼šæˆ‘ä»¬æ•°æ®åº“çš„ id éƒ½æ˜¯ä» 1 è‡ªå¢çš„ï¼Œå¦‚æœå‘èµ· id=-1 çš„æ•°æ®æˆ–è€… id ç‰¹åˆ«å¤§ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™æ ·çš„ä¸æ–­æ”»å‡»å¯¼è‡´æ•°æ®åº“å‹åŠ›å¾ˆå¤§ï¼Œä¸¥é‡ä¼šå‡»å®æ•°æ®åº“ã€‚

**æˆ‘åˆæ¥ç€è¯´**ï¼šè‡³äºç¼“å­˜å‡»ç©¿å˜›ï¼Œè¿™ä¸ªè·Ÿç¼“å­˜é›ªå´©æœ‰ç‚¹åƒï¼Œä½†æ˜¯åˆæœ‰ä¸€ç‚¹ä¸ä¸€æ ·ï¼Œç¼“å­˜é›ªå´©æ˜¯å› ä¸ºå¤§é¢ç§¯çš„ç¼“å­˜å¤±æ•ˆï¼Œæ‰“å´©äº† DBï¼Œè€Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ä¸€ä¸ª Key éå¸¸çƒ­ç‚¹ï¼Œåœ¨ä¸åœåœ°æ‰›ç€å¤§é‡çš„è¯·æ±‚ï¼Œå¤§å¹¶å‘é›†ä¸­å¯¹è¿™ä¸€ä¸ªç‚¹è¿›è¡Œè®¿é—®ï¼Œå½“è¿™ä¸ª Key  åœ¨å¤±æ•ˆçš„ç¬é—´ï¼ŒæŒç»­çš„å¤§å¹¶å‘ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå°±åœ¨è¿™ä¸ª Key çš„ç‚¹ä¸Šå‡»ç©¿äº†ç¼“å­˜ã€‚

é¢è¯•å®˜éœ²å‡ºæ¬£æ…°çš„çœ¼å…‰ï¼šé‚£ä»–ä»¬åˆ†åˆ«æ€ä¹ˆè§£å†³ï¼Ÿ

**ğŸ™‹ æˆ‘**ï¼šç¼“å­˜ç©¿é€æˆ‘ä¼šåœ¨æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œæ¯”å¦‚ç”¨æˆ·é‰´æƒï¼Œå‚æ•°åšæ ¡éªŒï¼Œä¸åˆæ³•çš„æ ¡éªŒç›´æ¥ returnï¼Œæ¯”å¦‚ id åšåŸºç¡€æ ¡éªŒï¼Œid<=0 ç›´æ¥æ‹¦æˆªã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜**ï¼šé‚£ä½ è¿˜æœ‰åˆ«çš„æ–¹æ³•å—ï¼Ÿ

**ğŸ™‹ æˆ‘**ï¼šæˆ‘è®°å¾— Redis é‡Œè¿˜æœ‰ä¸€ä¸ªé«˜çº§ç”¨æ³•**å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom  Filterï¼‰**è¿™ä¸ªä¹Ÿèƒ½å¾ˆå¥½çš„é¢„é˜²ç¼“å­˜ç©¿é€çš„å‘ç”Ÿï¼Œä»–çš„åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åˆ©ç”¨é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•å¿«é€Ÿåˆ¤æ–­å‡ºä½ è¿™ä¸ª Key  æ˜¯å¦åœ¨æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œä¸å­˜åœ¨ä½  return å°±å¥½äº†ï¼Œå­˜åœ¨ä½ å°±å»æŸ¥ DB åˆ·æ–° KV å†  returnã€‚ç¼“å­˜å‡»ç©¿çš„è¯ï¼Œè®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸï¼Œæˆ–è€…åŠ ä¸Šäº’æ–¥é”å°±æå®šäº†ã€‚ä½œä¸ºæš–ç”·ï¼Œä»£ç ç»™ä½ å‡†å¤‡å¥½äº†ï¼Œæ‹¿èµ°ä¸è°¢ã€‚

```java
public static String getData(String key) throws InterruptedException {
        //ä»RedisæŸ¥è¯¢æ•°æ®
        String result = getDataByKV(key);
        //å‚æ•°æ ¡éªŒ
        if (StringUtils.isBlank(result)) {
            try {
                //è·å¾—é”
                if (reenLock.tryLock()) {
                    //å»æ•°æ®åº“æŸ¥è¯¢
                    result = getDataByDB(key);
                    //æ ¡éªŒ
                    if (StringUtils.isNotBlank(result)) {
                        //æ’è¿›ç¼“å­˜
                        setDataToKV(key, result);
                    }
                } else {
                    //ç¡ä¸€ä¼šå†æ‹¿
                    Thread.sleep(100L);
                    result = getData(key);
                }
            } finally {
                //é‡Šæ”¾é”
                reenLock.unlock();
            }
        }
        return result;
    }
```

**é¢è¯•å®˜** ï¼šå—¯å—¯ï¼Œè¿˜ä¸é”™ã€‚

## Redis ä¸ºä½•è¿™ä¹ˆå¿«

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šredis ä½œä¸ºç¼“å­˜å¤§å®¶éƒ½åœ¨ç”¨ï¼Œé‚£ redis ä¸€å®šå¾ˆå¿«å’¯ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šå½“ç„¶äº†ï¼Œå®˜æ–¹æä¾›çš„æ•°æ®å¯ä»¥è¾¾åˆ° 100000+çš„ QPSï¼ˆæ¯ç§’å†…çš„æŸ¥è¯¢æ¬¡æ•°ï¼‰ï¼Œè¿™ä¸ªæ•°æ®ä¸æ¯” Memcached å·®ï¼

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šredis è¿™ä¹ˆå¿«ï¼Œå®ƒçš„â€œå¤šçº¿ç¨‹æ¨¡å‹â€ä½ äº†è§£å—ï¼Ÿï¼ˆéœ²å‡ºé‚ªé­…ä¸€ç¬‘ï¼‰

**ğŸ™‹ æˆ‘** ï¼šæ‚¨æ˜¯æƒ³é—® Redis è¿™ä¹ˆå¿«ï¼Œä¸ºä»€ä¹ˆè¿˜æ˜¯å•çº¿ç¨‹çš„å§ã€‚Redis ç¡®å®æ˜¯å•è¿›ç¨‹å•çº¿ç¨‹çš„æ¨¡å‹ï¼Œå› ä¸º Redis å®Œå…¨æ˜¯åŸºäºå†…å­˜çš„æ“ä½œï¼ŒCPU  ä¸æ˜¯ Redis çš„ç“¶é¢ˆï¼ŒRedis çš„ç“¶é¢ˆæœ€æœ‰å¯èƒ½æ˜¯æœºå™¨å†…å­˜çš„å¤§å°æˆ–è€…ç½‘ç»œå¸¦å®½ã€‚æ—¢ç„¶å•çº¿ç¨‹å®¹æ˜“å®ç°ï¼Œè€Œä¸” CPU  ä¸ä¼šæˆä¸ºç“¶é¢ˆï¼Œé‚£å°±é¡ºç†æˆç« çš„é‡‡ç”¨å•çº¿ç¨‹çš„æ–¹æ¡ˆäº†ï¼ˆæ¯•ç«Ÿé‡‡ç”¨å¤šçº¿ç¨‹ä¼šæœ‰å¾ˆå¤šéº»çƒ¦ï¼‰ã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šå—¯ï¼Œæ˜¯çš„ã€‚é‚£ä½ èƒ½è¯´è¯´ Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«å—ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šå¯ä»¥è¿™ä¹ˆè¯´å§ã€‚ç¬¬ä¸€ï¼šRedis å®Œå…¨åŸºäºå†…å­˜ï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚æ˜¯çº¯ç²¹çš„å†…å­˜æ“ä½œï¼Œéå¸¸è¿…é€Ÿï¼Œæ•°æ®å­˜åœ¨å†…å­˜ä¸­ï¼Œç±»ä¼¼äº HashMapï¼ŒHashMap çš„ä¼˜åŠ¿å°±æ˜¯æŸ¥æ‰¾å’Œæ“ä½œçš„æ—¶é—´å¤æ‚åº¦æ˜¯  O(1)ã€‚ç¬¬äºŒï¼šæ•°æ®ç»“æ„ç®€å•ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•ã€‚ç¬¬ä¸‰ï¼šé‡‡ç”¨å•çº¿ç¨‹ï¼Œé¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹å¯¼è‡´çš„ CPU  åˆ‡æ¢ï¼Œä¸ç”¨å»è€ƒè™‘å„ç§é”çš„é—®é¢˜ï¼Œä¸å­˜åœ¨åŠ é”é‡Šæ”¾é”æ“ä½œï¼Œæ²¡æœ‰æ­»é”é—®é¢˜å¯¼è‡´çš„æ€§èƒ½æ¶ˆè€—ã€‚ç¬¬å››ï¼šä½¿ç”¨å¤šè·¯å¤ç”¨ IO æ¨¡å‹ï¼Œéé˜»å¡ IOã€‚

## Redis å’Œ Memcached çš„åŒºåˆ«

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜**ï¼šå—¯å—¯ï¼Œè¯´çš„å¾ˆè¯¦ç»†ã€‚é‚£ä½ ä¸ºä»€ä¹ˆé€‰æ‹© Redis çš„ç¼“å­˜æ–¹æ¡ˆè€Œä¸ç”¨ memcached å‘¢

**ğŸ™‹ æˆ‘** ï¼š

1. **å­˜å‚¨æ–¹å¼ä¸Š** ï¼šmemcache ä¼šæŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ï¼Œæ–­ç”µåä¼šæŒ‚æ‰ï¼Œæ•°æ®ä¸èƒ½è¶…è¿‡å†…å­˜å¤§å°ã€‚redis æœ‰éƒ¨åˆ†æ•°æ®å­˜åœ¨ç¡¬ç›˜ä¸Šï¼Œè¿™æ ·èƒ½ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚
2. **æ•°æ®æ”¯æŒç±»å‹ä¸Š** ï¼šmemcache å¯¹æ•°æ®ç±»å‹çš„æ”¯æŒç®€å•ï¼Œåªæ”¯æŒç®€å•çš„ key-valueï¼Œï¼Œè€Œ redis æ”¯æŒäº”ç§æ•°æ®ç±»å‹ã€‚
3. **ä½¿ç”¨åº•å±‚æ¨¡å‹ä¸åŒï¼š** å®ƒä»¬ä¹‹é—´åº•å±‚å®ç°æ–¹å¼ä»¥åŠä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡çš„åº”ç”¨åè®®ä¸ä¸€æ ·ã€‚redis ç›´æ¥è‡ªå·±æ„å»ºäº† VM æœºåˆ¶ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚ã€‚
4. **value çš„å¤§å°** ï¼šredis å¯ä»¥è¾¾åˆ° 1GBï¼Œè€Œ memcache åªæœ‰ 1MBã€‚

## æ·˜æ±°ç­–ç•¥

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šé‚£ä½ è¯´è¯´ä½ çŸ¥é“çš„ redis çš„æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šRedis æœ‰å…­ç§æ·˜æ±°ç­–ç•¥

| ç­–ç•¥            | æè¿°                                                         |
| :-------------- | :----------------------------------------------------------- |
| volatile-lru    | ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„ KV é›†ä¸­ä¼˜å…ˆå¯¹æœ€è¿‘æœ€å°‘ä½¿ç”¨(less recently used)çš„æ•°æ®æ·˜æ±° |
| volitile-ttl    | ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„ KV é›†ä¸­ä¼˜å…ˆå¯¹å‰©ä½™æ—¶é—´çŸ­(time to live)çš„æ•°æ®æ·˜æ±° |
| volitile-random | ä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„ KV é›†ä¸­éšæœºé€‰æ‹©æ•°æ®æ·˜æ±°                   |
| allkeys-lru     | ä»æ‰€æœ‰ KV é›†ä¸­ä¼˜å…ˆå¯¹æœ€è¿‘æœ€å°‘ä½¿ç”¨(less recently used)çš„æ•°æ®æ·˜æ±° |
| allKeys-random  | ä»æ‰€æœ‰ KV é›†ä¸­éšæœºé€‰æ‹©æ•°æ®æ·˜æ±°                               |
| noeviction      | ä¸æ·˜æ±°ç­–ç•¥ï¼Œè‹¥è¶…è¿‡æœ€å¤§å†…å­˜ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯                     |

4.0 ç‰ˆæœ¬åå¢åŠ ä»¥ä¸‹ä¸¤ç§ï¼š

1. **volatile-lfu**ï¼šä»å·²è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ•°æ®é›†(server.db[i].expires)ä¸­æŒ‘é€‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„æ•°æ®æ·˜æ±°
2. **allkeys-lfu**ï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€ä¸ç»å¸¸ä½¿ç”¨çš„ key

## redis æŒä¹…åŒ–æœºåˆ¶

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šä½ å¯¹ redis çš„æŒä¹…åŒ–æœºåˆ¶äº†è§£å—ï¼Ÿæ€ä¹ˆä¿è¯ redis æŒ‚æ‰ä¹‹åå†é‡å¯æ•°æ®å¯ä»¥è¿›è¡Œæ¢å¤?èƒ½è®²ä¸€ä¸‹å—ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šredis  ä¸ºäº†ä¿è¯æ•ˆç‡ï¼Œæ•°æ®ç¼“å­˜åœ¨äº†å†…å­˜ä¸­ï¼Œä½†æ˜¯ä¼šå‘¨æœŸæ€§çš„æŠŠæ›´æ–°çš„æ•°æ®å†™å…¥ç£ç›˜æˆ–è€…æŠŠä¿®æ”¹æ“ä½œå†™å…¥è¿½åŠ çš„è®°å½•æ–‡ä»¶ä¸­ï¼Œä»¥ä¿è¯æ•°æ®çš„æŒä¹…åŒ–ã€‚Redis  çš„æŒä¹…åŒ–ç­–ç•¥æœ‰ä¸¤ç§ï¼š1ã€RDBï¼šå¿«ç…§å½¢å¼æ˜¯ç›´æ¥æŠŠå†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åˆ°ä¸€ä¸ª dump çš„æ–‡ä»¶ä¸­ï¼Œå®šæ—¶ä¿å­˜ï¼Œä¿å­˜ç­–ç•¥ã€‚2ã€AOFï¼šæŠŠæ‰€æœ‰çš„å¯¹  Redis çš„æœåŠ¡å™¨è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤éƒ½å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œå‘½ä»¤çš„é›†åˆã€‚Redis é»˜è®¤æ˜¯å¿«ç…§ RDB çš„æŒä¹…åŒ–æ–¹å¼ã€‚å½“ Redis  é‡å¯çš„æ—¶å€™ï¼Œå®ƒä¼šä¼˜å…ˆä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿˜åŸæ•°æ®é›†ï¼Œå› ä¸º AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®é›†é€šå¸¸æ¯” RDB  æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®é›†æ›´å®Œæ•´ã€‚ä½ ç”šè‡³å¯ä»¥å…³é—­æŒä¹…åŒ–åŠŸèƒ½ï¼Œè®©æ•°æ®åªåœ¨æœåŠ¡å™¨è¿è¡Œæ—¶å­˜ã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šé‚£ä½ å†è¯´ä¸‹ RDB æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šé»˜è®¤ Redis æ˜¯ä¼šä»¥å¿«ç…§"RDB"çš„å½¢å¼å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜çš„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ dump.rdbã€‚å·¥ä½œåŸç†ç®€å•è¯´ä¸€ä¸‹ï¼šå½“ Redis  éœ€è¦åšæŒä¹…åŒ–æ—¶ï¼ŒRedis ä¼š fork ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å°†æ•°æ®å†™åˆ°ç£ç›˜ä¸Šä¸€ä¸ªä¸´æ—¶ RDB æ–‡ä»¶ä¸­ã€‚å½“å­è¿›ç¨‹å®Œæˆå†™ä¸´æ—¶æ–‡ä»¶åï¼Œå°†åŸæ¥çš„ RDB æ›¿æ¢æ‰ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥ copy-on-writeã€‚

**ğŸ™‹ æˆ‘** ï¼šRDB çš„ä¼˜ç‚¹æ˜¯ï¼šè¿™ç§æ–‡ä»¶éå¸¸é€‚åˆç”¨äºå¤‡ä»½ï¼šæ¯”å¦‚ï¼Œä½ å¯ä»¥åœ¨æœ€è¿‘çš„ 24 å°æ—¶å†…ï¼Œæ¯å°æ—¶å¤‡ä»½ä¸€æ¬¡ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæœˆçš„æ¯ä¸€å¤©ä¹Ÿå¤‡ä»½ä¸€ä¸ª RDB  æ–‡ä»¶ã€‚è¿™æ ·çš„è¯ï¼Œå³ä½¿é‡ä¸Šé—®é¢˜ï¼Œä¹Ÿå¯ä»¥éšæ—¶å°†æ•°æ®é›†è¿˜åŸåˆ°ä¸åŒçš„ç‰ˆæœ¬ã€‚RDB éå¸¸é€‚åˆç¾éš¾æ¢å¤ã€‚RDB  çš„ç¼ºç‚¹æ˜¯ï¼šå¦‚æœä½ éœ€è¦å°½é‡é¿å…åœ¨æœåŠ¡å™¨æ•…éšœæ—¶ä¸¢å¤±æ•°æ®ï¼Œé‚£ä¹ˆ RDB ä¸åˆé€‚ä½ ã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šé‚£ä½ è¦ä¸å†è¯´ä¸‹ AOFï¼Ÿï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šï¼ˆè¯´å°±ä¸€èµ·è¯´ä¸‹å§ï¼‰ä½¿ç”¨ AOF åšæŒä¹…åŒ–ï¼Œæ¯ä¸€ä¸ªå†™å‘½ä»¤éƒ½é€šè¿‡ write å‡½æ•°è¿½åŠ åˆ° appendonly.aof ä¸­ï¼Œé…ç½®æ–¹å¼å¦‚ä¸‹ï¼š

```
appendfsync yes
appendfsync always     #æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶ã€‚
appendfsync everysec   #æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œè¯¥ç­–ç•¥ä¸ºAOFçš„ç¼ºçœç­–ç•¥ã€‚
```

AOF å¯ä»¥åšåˆ°å…¨ç¨‹æŒä¹…åŒ–ï¼Œåªéœ€è¦åœ¨é…ç½®ä¸­å¼€å¯ appendonly yesã€‚è¿™æ · redis æ¯æ‰§è¡Œä¸€ä¸ªä¿®æ”¹æ•°æ®çš„å‘½ä»¤ï¼Œéƒ½ä¼šæŠŠå®ƒæ·»åŠ åˆ° AOF æ–‡ä»¶ä¸­ï¼Œå½“ redis é‡å¯æ—¶ï¼Œå°†ä¼šè¯»å– AOF æ–‡ä»¶è¿›è¡Œé‡æ”¾ï¼Œæ¢å¤åˆ° redis å…³é—­å‰çš„æœ€åæ—¶åˆ»ã€‚

**ğŸ™‹ æˆ‘é¡¿äº†ä¸€ä¸‹ï¼Œç»§ç»­è¯´** ï¼šä½¿ç”¨ AOF çš„ä¼˜ç‚¹æ˜¯ä¼šè®© redis å˜å¾—éå¸¸è€ä¹…ã€‚å¯ä»¥è®¾ç½®ä¸åŒçš„ fsync ç­–ç•¥ï¼Œaof çš„é»˜è®¤ç­–ç•¥æ˜¯æ¯ç§’é’Ÿ fsync  ä¸€æ¬¡ï¼Œåœ¨è¿™ç§é…ç½®ä¸‹ï¼Œå°±ç®—å‘ç”Ÿæ•…éšœåœæœºï¼Œä¹Ÿæœ€å¤šä¸¢å¤±ä¸€ç§’é’Ÿçš„æ•°æ®ã€‚ç¼ºç‚¹æ˜¯å¯¹äºç›¸åŒçš„æ•°æ®é›†æ¥è¯´ï¼ŒAOF çš„æ–‡ä»¶ä½“ç§¯é€šå¸¸è¦å¤§äº RDB  æ–‡ä»¶çš„ä½“ç§¯ã€‚æ ¹æ®æ‰€ä½¿ç”¨çš„ fsync ç­–ç•¥ï¼ŒAOF çš„é€Ÿåº¦å¯èƒ½ä¼šæ…¢äº RDBã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜åˆé—®** ï¼šä½ è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£æˆ‘è¯¥ç”¨å“ªä¸€ä¸ªå‘¢ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šå¦‚æœä½ éå¸¸å…³å¿ƒä½ çš„æ•°æ®ï¼Œä½†ä»ç„¶å¯ä»¥æ‰¿å—æ•°åˆ†é’Ÿå†…çš„æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆå¯ä»¥é¢åªä½¿ç”¨ RDB æŒä¹…ã€‚AOF å°† Redis  æ‰§è¡Œçš„æ¯ä¸€æ¡å‘½ä»¤è¿½åŠ åˆ°ç£ç›˜ä¸­ï¼Œå¤„ç†å·¨å¤§çš„å†™å…¥ä¼šé™ä½ Redis çš„æ€§èƒ½ï¼Œä¸çŸ¥é“ä½ æ˜¯å¦å¯ä»¥æ¥å—ã€‚æ•°æ®åº“å¤‡ä»½å’Œç¾éš¾æ¢å¤ï¼šå®šæ—¶ç”Ÿæˆ RDB  å¿«ç…§éå¸¸ä¾¿äºè¿›è¡Œæ•°æ®åº“å¤‡ä»½ï¼Œå¹¶ä¸” RDB æ¢å¤æ•°æ®é›†çš„é€Ÿåº¦ä¹Ÿè¦æ¯” AOF æ¢å¤çš„é€Ÿåº¦å¿«ã€‚å½“ç„¶äº†ï¼Œredis æ”¯æŒåŒæ—¶å¼€å¯ RDB å’Œ  AOFï¼Œç³»ç»Ÿé‡å¯åï¼Œredis ä¼šä¼˜å…ˆä½¿ç”¨ AOF æ¥æ¢å¤æ•°æ®ï¼Œè¿™æ ·ä¸¢å¤±çš„æ•°æ®ä¼šæœ€å°‘ã€‚

**Redis 4.0 å¯¹äºæŒä¹…åŒ–æœºåˆ¶çš„ä¼˜åŒ–**

Redis 4.0 å¼€å§‹æ”¯æŒ RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–ï¼ˆé»˜è®¤å…³é—­ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ `aof-use-rdb-preamble` å¼€å¯ï¼‰ã€‚

å¦‚æœæŠŠæ··åˆæŒä¹…åŒ–æ‰“å¼€ï¼ŒAOF é‡å†™çš„æ—¶å€™å°±ç›´æ¥æŠŠ RDB çš„å†…å®¹å†™åˆ° AOF æ–‡ä»¶å¼€å¤´ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥ç»“åˆ RDB å’Œ AOF çš„ä¼˜ç‚¹,  å¿«é€ŸåŠ è½½åŒæ—¶é¿å…ä¸¢å¤±è¿‡å¤šçš„æ•°æ®ã€‚å½“ç„¶ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œ AOF é‡Œé¢çš„ RDB éƒ¨åˆ†æ˜¯å‹ç¼©æ ¼å¼ä¸å†æ˜¯ AOF æ ¼å¼ï¼Œå¯è¯»æ€§è¾ƒå·®ã€‚

**è¡¥å……å†…å®¹ï¼šAOF é‡å†™**

AOF é‡å†™å¯ä»¥äº§ç”Ÿä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ï¼Œè¿™ä¸ªæ–°çš„ AOF æ–‡ä»¶å’ŒåŸæœ‰çš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€æ ·ï¼Œä½†ä½“ç§¯æ›´å°ã€‚

AOF é‡å†™æ˜¯ä¸€ä¸ªæœ‰æ­§ä¹‰çš„åå­—ï¼Œè¯¥åŠŸèƒ½æ˜¯é€šè¿‡è¯»å–æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ¥å®ç°çš„ï¼Œç¨‹åºæ— é¡»å¯¹ç°æœ‰ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å…¥ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œã€‚

åœ¨æ‰§è¡Œ BGREWRITEAOF å‘½ä»¤æ—¶ï¼ŒRedis æœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ª AOF é‡å†™ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä¼šåœ¨å­è¿›ç¨‹åˆ›å»ºæ–° AOF  æ–‡ä»¶æœŸé—´ï¼Œè®°å½•æœåŠ¡å™¨æ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤ã€‚å½“å­è¿›ç¨‹å®Œæˆåˆ›å»ºæ–° AOF æ–‡ä»¶çš„å·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå°†é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–° AOF  æ–‡ä»¶çš„æœ«å°¾ï¼Œä½¿å¾—æ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚æœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„ AOF æ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®Œæˆ AOF  æ–‡ä»¶é‡å†™æ“ä½œ

## ä¸»ä»å¤åˆ¶

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šredis å•èŠ‚ç‚¹å­˜åœ¨å•ç‚¹æ•…éšœé—®é¢˜ï¼Œä¸ºäº†è§£å†³å•ç‚¹é—®é¢˜ï¼Œä¸€èˆ¬éƒ½éœ€è¦å¯¹ redis é…ç½®ä»èŠ‚ç‚¹ï¼Œç„¶åä½¿ç”¨å“¨å…µæ¥ç›‘å¬ä¸»èŠ‚ç‚¹çš„å­˜æ´»çŠ¶æ€ï¼Œå¦‚æœä¸»èŠ‚ç‚¹æŒ‚æ‰ï¼Œä»èŠ‚ç‚¹èƒ½ç»§ç»­æä¾›ç¼“å­˜åŠŸèƒ½ï¼Œä½ èƒ½è¯´è¯´ redis ä¸»ä»å¤åˆ¶çš„è¿‡ç¨‹å’ŒåŸç†å—ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šæˆ‘æœ‰ç‚¹æ‡µï¼Œè¿™ä¸ªè¯´æ¥å°±è¯é•¿äº†ã€‚ä½†å¹¸å¥½æå‰å‡†å¤‡äº†ï¼šä¸»ä»é…ç½®ç»“åˆå“¨å…µæ¨¡å¼èƒ½è§£å†³å•ç‚¹æ•…éšœé—®é¢˜ï¼Œæé«˜ redis å¯ç”¨æ€§ã€‚ä»èŠ‚ç‚¹ä»…æä¾›è¯»æ“ä½œï¼Œä¸»èŠ‚ç‚¹æä¾›å†™æ“ä½œã€‚å¯¹äºè¯»å¤šå†™å°‘çš„çŠ¶å†µï¼Œå¯ç»™ä¸»èŠ‚ç‚¹é…ç½®å¤šä¸ªä»èŠ‚ç‚¹ï¼Œä»è€Œæé«˜å“åº”æ•ˆç‡ã€‚

**ğŸ™‹ æˆ‘é¡¿äº†ä¸€ä¸‹ï¼Œæ¥ç€è¯´ï¼š** å…³äºå¤åˆ¶è¿‡ç¨‹ï¼Œæ˜¯è¿™æ ·çš„ï¼š

1. ä»èŠ‚ç‚¹æ‰§è¡Œ`slaveof[masterIP][masterPort]`ï¼Œä¿å­˜ä¸»èŠ‚ç‚¹ä¿¡æ¯
2. ä»èŠ‚ç‚¹ä¸­çš„å®šæ—¶ä»»åŠ¡å‘ç°ä¸»èŠ‚ç‚¹ä¿¡æ¯ï¼Œå»ºç«‹å’Œä¸»èŠ‚ç‚¹çš„ socket è¿æ¥
3. ä»èŠ‚ç‚¹å‘é€ Ping ä¿¡å·ï¼Œä¸»èŠ‚ç‚¹è¿”å› Pongï¼Œä¸¤è¾¹èƒ½äº’ç›¸é€šä¿¡
4. è¿æ¥å»ºç«‹åï¼Œä¸»èŠ‚ç‚¹å°†æ‰€æœ‰æ•°æ®å‘é€ç»™ä»èŠ‚ç‚¹ï¼ˆæ•°æ®åŒæ­¥ï¼‰
5. ä¸»èŠ‚ç‚¹æŠŠå½“å‰çš„æ•°æ®åŒæ­¥ç»™ä»èŠ‚ç‚¹åï¼Œä¾¿å®Œæˆäº†å¤åˆ¶çš„å»ºç«‹è¿‡ç¨‹ã€‚æ¥ä¸‹æ¥ï¼Œä¸»èŠ‚ç‚¹å°±ä¼šæŒç»­çš„æŠŠå†™å‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´æ€§ã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šé‚£ä½ èƒ½è¯¦ç»†è¯´ä¸‹æ•°æ®åŒæ­¥çš„è¿‡ç¨‹å—ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šï¼ˆæˆ‘å¿ƒæƒ³ï¼šè¿™ä¹Ÿé—®çš„å¤ªç»†äº†å§ï¼‰å¯ä»¥ã€‚redis2.8 ä¹‹å‰ä½¿ç”¨`sync[runId][offset]`åŒæ­¥å‘½ä»¤ï¼Œredis2.8 ä¹‹åä½¿ç”¨`psync[runId][offset]`å‘½ä»¤ã€‚ä¸¤è€…ä¸åŒåœ¨äºï¼Œsync å‘½ä»¤ä»…æ”¯æŒå…¨é‡å¤åˆ¶è¿‡ç¨‹ï¼Œpsync æ”¯æŒå…¨é‡å’Œéƒ¨åˆ†å¤åˆ¶ã€‚ä»‹ç»åŒæ­¥ä¹‹å‰ï¼Œå…ˆä»‹ç»å‡ ä¸ªæ¦‚å¿µï¼š

- runIdï¼šæ¯ä¸ª redis èŠ‚ç‚¹å¯åŠ¨éƒ½ä¼šç”Ÿæˆå”¯ä¸€çš„ uuidï¼Œæ¯æ¬¡ redis é‡å¯åï¼ŒrunId éƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚

- offsetï¼šä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹éƒ½å„è‡ªç»´æŠ¤è‡ªå·±çš„ä¸»ä»å¤åˆ¶åç§»é‡ offsetï¼Œå½“ä¸»èŠ‚ç‚¹æœ‰å†™å…¥å‘½ä»¤æ—¶ï¼Œoffset=offset+å‘½ä»¤çš„å­—èŠ‚é•¿åº¦ã€‚ä»èŠ‚ç‚¹åœ¨æ”¶åˆ°ä¸»èŠ‚ç‚¹å‘é€çš„å‘½ä»¤åï¼Œä¹Ÿä¼šå¢åŠ è‡ªå·±çš„  offsetï¼Œå¹¶æŠŠè‡ªå·±çš„ offset å‘é€ç»™ä¸»èŠ‚ç‚¹ã€‚è¿™æ ·ï¼Œä¸»èŠ‚ç‚¹åŒæ—¶ä¿å­˜è‡ªå·±çš„ offset å’Œä»èŠ‚ç‚¹çš„ offsetï¼Œé€šè¿‡å¯¹æ¯” offset æ¥åˆ¤æ–­ä¸»ä»èŠ‚ç‚¹æ•°æ®æ˜¯å¦ä¸€è‡´ã€‚

- repl_backlog_sizeï¼šä¿å­˜åœ¨ä¸»èŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªå›ºå®šé•¿åº¦çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°æ˜¯ 1MBã€‚

  ï¼ˆ1ï¼‰ä¸»èŠ‚ç‚¹å‘é€æ•°æ®ç»™ä»èŠ‚ç‚¹è¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹è¿˜ä¼šè¿›è¡Œä¸€äº›å†™æ“ä½œï¼Œè¿™æ—¶å€™çš„æ•°æ®å­˜å‚¨åœ¨å¤åˆ¶ç¼“å†²åŒºä¸­ã€‚ä»èŠ‚ç‚¹åŒæ­¥ä¸»èŠ‚ç‚¹æ•°æ®å®Œæˆåï¼Œä¸»èŠ‚ç‚¹å°†ç¼“å†²åŒºçš„æ•°æ®ç»§ç»­å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œç”¨äºéƒ¨åˆ†å¤åˆ¶ã€‚ï¼ˆ2ï¼‰ä¸»èŠ‚ç‚¹å“åº”å†™å‘½ä»¤æ—¶ï¼Œä¸ä½†ä¼šæŠŠå‘½åå‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè¿˜ä¼šå†™å…¥å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œç”¨äºå¤åˆ¶å‘½ä»¤ä¸¢å¤±çš„æ•°æ®è¡¥æ•‘ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMic6gIBl67EZnVQ8WSJRaCZRsHzvVYsticaVFtl2O4baBYAFcvrorNV13Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

ä¸Šé¢æ˜¯ psync çš„æ‰§è¡Œæµç¨‹ï¼š

ä»èŠ‚ç‚¹å‘é€ psync[runId][offset]å‘½ä»¤ï¼Œä¸»èŠ‚ç‚¹æœ‰ä¸‰ç§å“åº”ï¼š

1. **FULLRESYNC** ï¼šç¬¬ä¸€æ¬¡è¿æ¥ï¼Œè¿›è¡Œå…¨é‡å¤åˆ¶
2. **CONTINUE** ï¼šè¿›è¡Œéƒ¨åˆ†å¤åˆ¶
3. **ERR** ï¼šä¸æ”¯æŒ psync å‘½ä»¤ï¼Œè¿›è¡Œå…¨é‡å¤åˆ¶

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šå¾ˆå¥½ï¼Œé‚£ä½ èƒ½å…·ä½“è¯´ä¸‹å…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶çš„è¿‡ç¨‹å—ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šå¯ä»¥

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicVYLfZftxM7kQPHha4KRJlWUVtAsebwW7LBWyg7PyTyVDx0FdcEsY1Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

ä¸Šé¢æ˜¯å…¨é‡å¤åˆ¶çš„æµç¨‹ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ æ­¥ï¼š

1. ä»èŠ‚ç‚¹å‘é€ psync ? -1 å‘½ä»¤ï¼ˆå› ä¸ºç¬¬ä¸€æ¬¡å‘é€ï¼Œä¸çŸ¥é“ä¸»èŠ‚ç‚¹çš„ runIdï¼Œæ‰€ä»¥ä¸º?ï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡å¤åˆ¶ï¼Œæ‰€ä»¥ offset=-1ï¼‰ã€‚
2. ä¸»èŠ‚ç‚¹å‘ç°ä»èŠ‚ç‚¹æ˜¯ç¬¬ä¸€æ¬¡å¤åˆ¶ï¼Œè¿”å› FULLRESYNC {runId} {offset}ï¼ŒrunId æ˜¯ä¸»èŠ‚ç‚¹çš„ runIdï¼Œoffset æ˜¯ä¸»èŠ‚ç‚¹ç›®å‰çš„ offsetã€‚
3. ä»èŠ‚ç‚¹æ¥æ”¶ä¸»èŠ‚ç‚¹ä¿¡æ¯åï¼Œä¿å­˜åˆ° info ä¸­ã€‚
4. ä¸»èŠ‚ç‚¹åœ¨å‘é€ FULLRESYNC åï¼Œå¯åŠ¨ bgsave å‘½ä»¤ï¼Œç”Ÿæˆ RDB æ–‡ä»¶ï¼ˆæ•°æ®æŒä¹…åŒ–ï¼‰ã€‚
5. ä¸»èŠ‚ç‚¹å‘é€ RDB æ–‡ä»¶ç»™ä»èŠ‚ç‚¹ã€‚åˆ°ä»èŠ‚ç‚¹åŠ è½½æ•°æ®å®Œæˆè¿™æ®µæœŸé—´ä¸»èŠ‚ç‚¹çš„å†™å‘½ä»¤æ”¾å…¥ç¼“å†²åŒºã€‚
6. ä»èŠ‚ç‚¹æ¸…ç†è‡ªå·±çš„æ•°æ®åº“æ•°æ®ã€‚
7. ä»èŠ‚ç‚¹åŠ è½½ RDB æ–‡ä»¶ï¼Œå°†æ•°æ®ä¿å­˜åˆ°è‡ªå·±çš„æ•°æ®åº“ä¸­ã€‚
8. å¦‚æœä»èŠ‚ç‚¹å¼€å¯äº† AOFï¼Œä»èŠ‚ç‚¹ä¼šå¼‚æ­¥é‡å†™ AOF æ–‡ä»¶ã€‚

å…³äºéƒ¨åˆ†å¤åˆ¶æœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜ï¼š

1. éƒ¨åˆ†å¤åˆ¶ä¸»è¦æ˜¯ Redis é’ˆå¯¹å…¨é‡å¤åˆ¶çš„è¿‡é«˜å¼€é”€åšå‡ºçš„ä¸€ç§ä¼˜åŒ–æªæ–½ï¼Œä½¿ç”¨`psync[runId][offset]`å‘½ä»¤å®ç°ã€‚å½“ä»èŠ‚ç‚¹æ­£åœ¨å¤åˆ¶ä¸»èŠ‚ç‚¹æ—¶ï¼Œå¦‚æœå‡ºç°ç½‘ç»œé—ªæ–­æˆ–è€…å‘½ä»¤ä¸¢å¤±ç­‰å¼‚å¸¸æƒ…å†µæ—¶ï¼Œä»èŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹è¦æ±‚è¡¥å‘ä¸¢å¤±çš„å‘½ä»¤æ•°æ®ï¼Œä¸»èŠ‚ç‚¹çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå°†è¿™éƒ¨åˆ†æ•°æ®ç›´æ¥å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥ä¿æŒä¸»ä»èŠ‚ç‚¹å¤åˆ¶çš„ä¸€è‡´æ€§ã€‚è¡¥å‘çš„è¿™éƒ¨åˆ†æ•°æ®ä¸€èˆ¬è¿œè¿œå°äºå…¨é‡æ•°æ®ã€‚
2. ä¸»ä»è¿æ¥ä¸­æ–­æœŸé—´ä¸»èŠ‚ç‚¹ä¾ç„¶å“åº”å‘½ä»¤ï¼Œä½†å› å¤åˆ¶è¿æ¥ä¸­æ–­å‘½ä»¤æ— æ³•å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä¸è¿‡ä¸»èŠ‚ç‚¹å†…çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¾ç„¶å¯ä»¥ä¿å­˜æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å†™å‘½ä»¤æ•°æ®ã€‚
3. å½“ä¸»ä»è¿æ¥æ¢å¤åï¼Œç”±äºä»èŠ‚ç‚¹ä¹‹å‰ä¿å­˜äº†è‡ªèº«å·²å¤åˆ¶çš„åç§»é‡å’Œä¸»èŠ‚ç‚¹çš„è¿è¡Œ IDã€‚å› æ­¤ä¼šæŠŠå®ƒä»¬å½“åš psync å‚æ•°å‘é€ç»™ä¸»èŠ‚ç‚¹ï¼Œè¦æ±‚è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ã€‚
4. ä¸»èŠ‚ç‚¹æ¥æ”¶åˆ° psync å‘½ä»¤åé¦–å…ˆæ ¸å¯¹å‚æ•° runId æ˜¯å¦ä¸è‡ªèº«ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œè¯´æ˜ä¹‹å‰å¤åˆ¶çš„æ˜¯å½“å‰ä¸»èŠ‚ç‚¹ï¼›ä¹‹åæ ¹æ®å‚æ•° offset  åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­æŸ¥æ‰¾ï¼Œå¦‚æœ offset ä¹‹åçš„æ•°æ®å­˜åœ¨ï¼Œåˆ™å¯¹ä»èŠ‚ç‚¹å‘é€+COUTINUE  å‘½ä»¤ï¼Œè¡¨ç¤ºå¯ä»¥è¿›è¡Œéƒ¨åˆ†å¤åˆ¶ã€‚å› ä¸ºç¼“å†²åŒºå¤§å°å›ºå®šï¼Œè‹¥å‘ç”Ÿç¼“å†²æº¢å‡ºï¼Œåˆ™è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚
5. ä¸»èŠ‚ç‚¹æ ¹æ®åç§»é‡æŠŠå¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œçš„æ•°æ®å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä¿è¯ä¸»ä»å¤åˆ¶è¿›å…¥æ­£å¸¸çŠ¶æ€ã€‚

## å“¨å…µ

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šé‚£ä¸»ä»å¤åˆ¶ä¼šå­˜åœ¨å“ªäº›é—®é¢˜å‘¢ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šä¸»ä»å¤åˆ¶ä¼šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. ä¸€æ—¦ä¸»èŠ‚ç‚¹å®•æœºï¼Œä»èŠ‚ç‚¹æ™‹å‡ä¸ºä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶éœ€è¦ä¿®æ”¹åº”ç”¨æ–¹çš„ä¸»èŠ‚ç‚¹åœ°å€ï¼Œè¿˜éœ€è¦å‘½ä»¤æ‰€æœ‰ä»èŠ‚ç‚¹å»å¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦äººå·¥å¹²é¢„ã€‚
2. ä¸»èŠ‚ç‚¹çš„å†™èƒ½åŠ›å—åˆ°å•æœºçš„é™åˆ¶ã€‚
3. ä¸»èŠ‚ç‚¹çš„å­˜å‚¨èƒ½åŠ›å—åˆ°å•æœºçš„é™åˆ¶ã€‚
4. åŸç”Ÿå¤åˆ¶çš„å¼Šç«¯åœ¨æ—©æœŸçš„ç‰ˆæœ¬ä¸­ä¹Ÿä¼šæ¯”è¾ƒçªå‡ºï¼Œæ¯”å¦‚ï¼šredis å¤åˆ¶ä¸­æ–­åï¼Œä»èŠ‚ç‚¹ä¼šå‘èµ· psyncã€‚æ­¤æ—¶å¦‚æœåŒæ­¥ä¸æˆåŠŸï¼Œåˆ™ä¼šè¿›è¡Œå…¨é‡åŒæ­¥ï¼Œä¸»åº“æ‰§è¡Œå…¨é‡å¤‡ä»½çš„åŒæ—¶ï¼Œå¯èƒ½ä¼šé€ æˆæ¯«ç§’æˆ–ç§’çº§çš„å¡é¡¿ã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šé‚£æ¯”è¾ƒä¸»æµçš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šå½“ç„¶æ˜¯å“¨å…µå•Šã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šé‚£ä¹ˆé—®é¢˜åˆæ¥äº†ã€‚é‚£ä½ è¯´ä¸‹å“¨å…µæœ‰å“ªäº›åŠŸèƒ½ï¼Ÿ

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMic89F6770xHiaYPJN48zJR2LB8A6aP3VfIgC0vVxibVlYicy2gwiaqXdSrPw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**ğŸ™‹ æˆ‘** ï¼šå¦‚å›¾ï¼Œæ˜¯ Redis Sentinelï¼ˆå“¨å…µï¼‰çš„æ¶æ„å›¾ã€‚Redis  Sentinelï¼ˆå“¨å…µï¼‰ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ä¸»èŠ‚ç‚¹å­˜æ´»æ£€æµ‹ã€ä¸»ä»è¿è¡Œæƒ…å†µæ£€æµ‹ã€è‡ªåŠ¨æ•…éšœè½¬ç§»ã€ä¸»ä»åˆ‡æ¢ã€‚Redis Sentinel  æœ€å°é…ç½®æ˜¯ä¸€ä¸»ä¸€ä»ã€‚Redis çš„ Sentinel ç³»ç»Ÿå¯ä»¥ç”¨æ¥ç®¡ç†å¤šä¸ª Redis æœåŠ¡å™¨ï¼Œè¯¥ç³»ç»Ÿå¯ä»¥æ‰§è¡Œä»¥ä¸‹å››ä¸ªä»»åŠ¡ï¼š

1. **ç›‘æ§** ï¼šä¸æ–­æ£€æŸ¥ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚
2. **é€šçŸ¥** ï¼šå½“è¢«ç›‘æ§çš„æŸä¸ª redis æœåŠ¡å™¨å‡ºç°é—®é¢˜ï¼ŒSentinel é€šè¿‡ API è„šæœ¬å‘ç®¡ç†å‘˜æˆ–è€…å…¶ä»–åº”ç”¨ç¨‹åºå‘å‡ºé€šçŸ¥ã€‚
3. **è‡ªåŠ¨æ•…éšœè½¬ç§»** ï¼šå½“ä¸»èŠ‚ç‚¹ä¸èƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼ŒSentinel ä¼šå¼€å§‹ä¸€æ¬¡è‡ªåŠ¨çš„æ•…éšœè½¬ç§»æ“ä½œï¼Œå®ƒä¼šå°†ä¸å¤±æ•ˆä¸»èŠ‚ç‚¹æ˜¯ä¸»ä»å…³ç³»çš„å…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†å…¶ä»–çš„ä»èŠ‚ç‚¹æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè¿™æ ·äººå·¥å¹²é¢„å°±å¯ä»¥å…äº†ã€‚
4. **é…ç½®æä¾›è€…** ï¼šåœ¨ Redis Sentinel æ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯åº”ç”¨åœ¨åˆå§‹åŒ–æ—¶è¿æ¥çš„æ˜¯ Sentinel èŠ‚ç‚¹é›†åˆï¼Œä»ä¸­è·å–ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚

**ğŸ™â€â™‚ï¸ é¢è¯•å®˜** ï¼šé‚£ä½ èƒ½è¯´ä¸‹å“¨å…µçš„å·¥ä½œåŸç†å—ï¼Ÿ

**ğŸ™‹ æˆ‘** ï¼šè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šå›¾ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicV4uRLib3FmS9KibcSMycB36MwicA3GTygLnQTl3VkAGb8mPE47pLzcz0g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

1ã€æ¯ä¸ª Sentinel èŠ‚ç‚¹éƒ½éœ€è¦å®šæœŸæ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼šæ¯ä¸ª Sentinel ä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œå‘å®ƒæ‰€çŸ¥çš„ä¸»æœåŠ¡å™¨ã€ä»æœåŠ¡å™¨ä»¥åŠå…¶ä»–çš„ Sentinel å®ä¾‹å‘é€ä¸€ä¸ª PING å‘½ä»¤ã€‚ï¼ˆå¦‚ä¸Šå›¾ï¼‰

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicexruL5YRczic7adyYa4eHvmDhTCYkdBsgia7wNExsIp3iaENcCwhYztYg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

2ã€å¦‚æœä¸€ä¸ªå®ä¾‹è·ç¦»æœ€åä¸€æ¬¡æœ‰æ•ˆå›å¤ PING å‘½ä»¤çš„æ—¶é—´è¶…è¿‡`down-after-milliseconds`æ‰€æŒ‡å®šçš„å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå®ä¾‹ä¼šè¢« Sentinel æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ã€‚ï¼ˆå¦‚ä¸Šå›¾ï¼‰

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMickrEiadYfFM6Fq55GTUCSibTzLMib5xn7200NFu2J56iadM1vSCiaHy04xXg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

3ã€å¦‚æœä¸€ä¸ªä¸»æœåŠ¡å™¨è¢«æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œé‚£ä¹ˆæ­£åœ¨ç›‘è§†è¿™ä¸ªæœåŠ¡å™¨çš„æ‰€æœ‰ Sentinel èŠ‚ç‚¹ï¼Œè¦ä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ç¡®è®¤ä¸»æœåŠ¡å™¨çš„ç¡®è¿›å…¥äº†ä¸»è§‚ä¸‹çº¿çŠ¶æ€ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicgeP6wxMBPbUyutWY0JXyADiaHXDNtZOkDX3NZqagTdcjiabBJ3TYwW5w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

4ã€å¦‚æœä¸€ä¸ªä¸»æœåŠ¡å™¨è¢«æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œå¹¶ä¸”æœ‰è¶³å¤Ÿæ•°é‡çš„ Sentinelï¼ˆè‡³å°‘è¦è¾¾åˆ°é…ç½®æ–‡ä»¶æŒ‡å®šçš„æ•°é‡ï¼‰åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…åŒæ„è¿™ä¸€åˆ¤æ–­ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸»æœåŠ¡å™¨è¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicyb8R8NQYSlO3HQ5Y1ZPpKVA0QkCt44eFIDSmAX1iczcsr8eKYPlfZgQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

5ã€ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ª Sentinel ä¼šä»¥æ¯ 10 ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘å®ƒå·²çŸ¥çš„æ‰€æœ‰ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å‘é€ INFO  å‘½ä»¤ï¼Œå½“ä¸€ä¸ªä¸»æœåŠ¡å™¨è¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼ŒSentinel å‘ä¸‹çº¿ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤çš„é¢‘ç‡ï¼Œä¼šä» 10  ç§’ä¸€æ¬¡æ”¹ä¸ºæ¯ç§’ä¸€æ¬¡ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMicFYTOiaPwr2eTzrOwBaFcSMqia8CGvpt20RLL0hoCXY08PI1z1dDG3S5Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

6ã€Sentinel å’Œå…¶ä»– Sentinel åå•†å®¢è§‚ä¸‹çº¿çš„ä¸»èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚æœå¤„äº SDOWN çŠ¶æ€ï¼Œåˆ™æŠ•ç¥¨è‡ªåŠ¨é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå°†å‰©ä½™ä»èŠ‚ç‚¹æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/iaIdQfEric9TzlTcnXg26t1Dia266foajMic6W1t4T0lTkkPmrm1ntavVFZFcCaTyMU4VqZLxGWias15icR40Bibh8GDA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

7ã€å½“æ²¡æœ‰è¶³å¤Ÿæ•°é‡çš„ Sentinel åŒæ„ä¸»æœåŠ¡å™¨ä¸‹çº¿æ—¶ï¼Œä¸»æœåŠ¡å™¨çš„å®¢è§‚ä¸‹çº¿çŠ¶æ€å°±ä¼šè¢«ç§»é™¤ã€‚å½“ä¸»æœåŠ¡å™¨é‡æ–°å‘ Sentinel çš„ PING å‘½ä»¤è¿”å›æœ‰æ•ˆå›å¤æ—¶ï¼Œä¸»æœåŠ¡å™¨çš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€å°±ä¼šè¢«ç§»é™¤ã€‚

**Rediså¸¸è§çš„å‡ ç§ä¸»è¦ä½¿ç”¨æ–¹å¼ï¼š**

- Redis å•å‰¯æœ¬
- Redis å¤šå‰¯æœ¬ï¼ˆä¸»ä»ï¼‰
- Redis Sentinelï¼ˆå“¨å…µï¼‰
- Redis Cluster
- Redis è‡ªç ”



## Rediså„ç§ä½¿ç”¨æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼š

1

Rediså•å‰¯æœ¬

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/6EJvicazJ6KzImNoKH1nofWM9rqIR6VUWtkGVXibFND01jgOkPqJ9iajeiby7jCO8tLFsZt4eNg9kcw8MNgqlzU19Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

Redis å•å‰¯æœ¬ï¼Œé‡‡ç”¨å•ä¸ªRedisèŠ‚ç‚¹éƒ¨ç½²æ¶æ„ï¼Œæ²¡æœ‰å¤‡ç”¨èŠ‚ç‚¹å®æ—¶åŒæ­¥æ•°æ®ï¼Œä¸æä¾›æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½ç­–ç•¥ï¼Œé€‚ç”¨äºæ•°æ®å¯é æ€§è¦æ±‚ä¸é«˜çš„çº¯ç¼“å­˜ä¸šåŠ¡åœºæ™¯ã€‚



**ä¼˜ç‚¹ï¼š**

1ã€æ¶æ„ç®€å•ã€éƒ¨ç½²æ–¹ä¾¿

 2ã€é«˜æ€§ä»·æ¯”ï¼Œå½“ç¼“å­˜ä½¿ç”¨æ—¶æ— éœ€å¤‡ç”¨èŠ‚ç‚¹ï¼ˆå•å®ä¾‹å¯ç”¨æ€§å¯ä»¥ç”¨supervisoræˆ–crontabä¿è¯ï¼‰ï¼Œå½“ç„¶ä¸ºäº†æ»¡è¶³ä¸šåŠ¡çš„é«˜å¯ç”¨æ€§ï¼Œä¹Ÿå¯ä»¥ç‰ºç‰²ä¸€ä¸ªå¤‡ç”¨èŠ‚ç‚¹ï¼Œä½†åŒæ—¶åˆ»åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹å¤–æä¾›æœåŠ¡ã€‚

 3ã€é«˜æ€§èƒ½



**ç¼ºç‚¹ï¼š**

1ã€ä¸ä¿è¯æ•°æ®çš„å¯é æ€§

 2ã€å½“ç¼“å­˜ä½¿ç”¨ï¼Œè¿›ç¨‹é‡å¯åï¼Œæ•°æ®ä¸¢å¤±ï¼Œå³ä½¿æœ‰å¤‡ç”¨çš„èŠ‚ç‚¹è§£å†³é«˜å¯ç”¨æ€§ï¼Œä½†æ˜¯ä»ç„¶ä¸èƒ½è§£å†³ç¼“å­˜é¢„çƒ­é—®é¢˜ï¼Œå› æ­¤ä¸é€‚ç”¨äºæ•°æ®å¯é æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡ã€‚

3ã€é«˜æ€§èƒ½å—é™äºå•æ ¸CPUçš„å¤„ç†èƒ½åŠ›ï¼ˆRedisæ˜¯å•çº¿ç¨‹æœºåˆ¶ï¼‰ï¼ŒCPUä¸ºä¸»è¦ç“¶é¢ˆï¼Œæ‰€ä»¥é€‚åˆæ“ä½œå‘½ä»¤ç®€å•ï¼Œæ’åºã€è®¡ç®—è¾ƒå°‘çš„åœºæ™¯ã€‚ä¹Ÿå¯ä»¥è€ƒè™‘ç”¨memcachedæ›¿ä»£ã€‚



2

Rediså¤šå‰¯æœ¬ï¼ˆä¸»ä»ï¼‰

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/6EJvicazJ6KzImNoKH1nofWM9rqIR6VUWeDxJHhJHIQgDFF9Hb5kRnGkNicM7KGfpad5VnUo0pOQjm2Fw7TGUs0Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)Redis å¤šå‰¯æœ¬ï¼Œé‡‡ç”¨ä¸»ä»ï¼ˆreplicationï¼‰éƒ¨ç½²ç»“æ„ï¼Œç›¸è¾ƒäºå•å‰¯æœ¬è€Œè¨€æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ä¸»ä»å®ä¾‹é—´æ•°æ®å®æ—¶åŒæ­¥ï¼Œå¹¶ä¸”æä¾›æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½ç­–ç•¥ã€‚ä¸»ä»å®ä¾‹éƒ¨ç½²åœ¨ä¸åŒçš„ç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œæ ¹æ®å…¬å¸çš„åŸºç¡€ç¯å¢ƒé…ç½®ï¼Œå¯ä»¥å®ç°åŒæ—¶å¯¹å¤–æä¾›æœåŠ¡å’Œè¯»å†™åˆ†ç¦»ç­–ç•¥ã€‚

ä¼˜ç‚¹ï¼š

1ã€é«˜å¯é æ€§ï¼Œä¸€æ–¹é¢ï¼Œé‡‡ç”¨åŒæœºä¸»å¤‡æ¶æ„ï¼Œèƒ½å¤Ÿåœ¨ä¸»åº“å‡ºç°æ•…éšœæ—¶è‡ªåŠ¨è¿›è¡Œä¸»å¤‡åˆ‡æ¢ï¼Œä»åº“æå‡ä¸ºä¸»åº“æä¾›æœåŠ¡ï¼Œä¿è¯æœåŠ¡å¹³ç¨³è¿è¡Œã€‚å¦ä¸€æ–¹é¢ï¼Œå¼€å¯æ•°æ®æŒä¹…åŒ–åŠŸèƒ½å’Œé…ç½®åˆç†çš„å¤‡ä»½ç­–ç•¥ï¼Œèƒ½æœ‰æ•ˆçš„è§£å†³æ•°æ®è¯¯æ“ä½œå’Œæ•°æ®å¼‚å¸¸ä¸¢å¤±çš„é—®é¢˜ã€‚

2ã€è¯»å†™åˆ†ç¦»ç­–ç•¥ï¼Œä»èŠ‚ç‚¹å¯ä»¥æ‰©å±•ä¸»åº“èŠ‚ç‚¹çš„è¯»èƒ½åŠ›ï¼Œæœ‰æ•ˆåº”å¯¹å¤§å¹¶å‘é‡çš„è¯»æ“ä½œã€‚



ç¼ºç‚¹ï¼š

1ã€æ•…éšœæ¢å¤å¤æ‚ï¼Œå¦‚æœæ²¡æœ‰RedisHAç³»ç»Ÿï¼ˆéœ€è¦å¼€å‘ï¼‰ï¼Œå½“ä¸»åº“èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨å°†ä¸€ä¸ªä»èŠ‚ç‚¹æ™‹å‡ä¸ºä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶éœ€è¦é€šçŸ¥ä¸šåŠ¡æ–¹å˜æ›´é…ç½®ï¼Œå¹¶ä¸”éœ€è¦è®©å…¶ä»–ä»åº“èŠ‚ç‚¹å»å¤åˆ¶æ–°ä¸»åº“èŠ‚ç‚¹ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦äººä¸ºå¹²é¢„ï¼Œæ¯”è¾ƒç¹çã€‚

2ã€ä¸»åº“çš„å†™èƒ½åŠ›å—åˆ°å•æœºçš„é™åˆ¶ï¼Œå¯ä»¥è€ƒè™‘åˆ†ç‰‡

3ã€ä¸»åº“çš„å­˜å‚¨èƒ½åŠ›å—åˆ°å•æœºçš„é™åˆ¶ï¼Œå¯ä»¥è€ƒè™‘Pika

4ã€åŸç”Ÿå¤åˆ¶çš„å¼Šç«¯åœ¨æ—©æœŸçš„ç‰ˆæœ¬ä¹Ÿä¼šæ¯”è¾ƒçªå‡ºï¼Œå¦‚ï¼šRediså¤åˆ¶ä¸­æ–­åï¼ŒSlaveä¼šå‘èµ·psyncï¼Œæ­¤æ—¶å¦‚æœåŒæ­¥ä¸æˆåŠŸï¼Œåˆ™ä¼šè¿›è¡Œå…¨é‡åŒæ­¥ï¼Œä¸»åº“æ‰§è¡Œå…¨é‡å¤‡ä»½çš„åŒæ—¶å¯èƒ½ä¼šé€ æˆæ¯«ç§’æˆ–ç§’çº§çš„å¡é¡¿ï¼›åˆç”±äºCOWæœºåˆ¶ï¼Œå¯¼è‡´æç«¯æƒ…å†µä¸‹çš„ä¸»åº“å†…å­˜æº¢å‡ºï¼Œç¨‹åºå¼‚å¸¸é€€å‡ºæˆ–å®•æœºï¼›ä¸»åº“èŠ‚ç‚¹ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å¯¼è‡´æœåŠ¡å™¨ç£ç›˜IOå’ŒCPUï¼ˆå‹ç¼©ï¼‰èµ„æºæ¶ˆè€—ï¼›å‘é€æ•°GBå¤§å°çš„å¤‡ä»½æ–‡ä»¶å¯¼è‡´æœåŠ¡å™¨å‡ºå£å¸¦å®½æš´å¢ï¼Œé˜»å¡è¯·æ±‚ã€‚å»ºè®®å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚



3

Redis Sentinelï¼ˆå“¨å…µï¼‰

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/6EJvicazJ6KzImNoKH1nofWM9rqIR6VUWfIC0vFhMAib4z10k7YqO8QJHTDxnujrrkvgjeibBmhV78vAAGzNfplCw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/6EJvicazJ6KzImNoKH1nofWM9rqIR6VUW1ibIW7Go066hNFQF5jUpkv5NN8RIA4McUSyRPVb82OTnpnWnmKyrDbA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

Redis Sentinelæ˜¯ç¤¾åŒºç‰ˆæœ¬æ¨å‡ºçš„åŸç”Ÿé«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼ŒRedis Sentineléƒ¨ç½²æ¶æ„ä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šRedis  Sentinelé›†ç¾¤å’ŒRedisæ•°æ®é›†ç¾¤ï¼Œå…¶ä¸­Redis  Sentinelé›†ç¾¤æ˜¯ç”±è‹¥å¹²SentinelèŠ‚ç‚¹ç»„æˆçš„åˆ†å¸ƒå¼é›†ç¾¤ã€‚å¯ä»¥å®ç°æ•…éšœå‘ç°ã€æ•…éšœè‡ªåŠ¨è½¬ç§»ã€é…ç½®ä¸­å¿ƒå’Œå®¢æˆ·ç«¯é€šçŸ¥ã€‚Redis  Sentinelçš„èŠ‚ç‚¹æ•°é‡è¦æ»¡è¶³2n+1ï¼ˆn>=1ï¼‰çš„å¥‡æ•°ä¸ªã€‚



ä¼˜ç‚¹ï¼š

1ã€Redis Sentinelé›†ç¾¤éƒ¨ç½²ç®€å•

2ã€èƒ½å¤Ÿè§£å†³Redisä¸»ä»æ¨¡å¼ä¸‹çš„é«˜å¯ç”¨åˆ‡æ¢é—®é¢˜

3ã€å¾ˆæ–¹ä¾¿å®ç°Redisæ•°æ®èŠ‚ç‚¹çš„çº¿å½¢æ‰©å±•ï¼Œè½»æ¾çªç ´Redisè‡ªèº«å•çº¿ç¨‹ç“¶é¢ˆï¼Œå¯æå¤§æ»¡è¶³å¯¹Rediså¤§å®¹é‡æˆ–é«˜æ€§èƒ½çš„ä¸šåŠ¡éœ€æ±‚ã€‚

4ã€å¯ä»¥å®ç°ä¸€å¥—Sentinelç›‘æ§ä¸€ç»„Redisæ•°æ®èŠ‚ç‚¹æˆ–å¤šç»„æ•°æ®èŠ‚ç‚¹



ç¼ºç‚¹ï¼š

1ã€éƒ¨ç½²ç›¸å¯¹Redis ä¸»ä»æ¨¡å¼è¦å¤æ‚ä¸€äº›ï¼ŒåŸç†ç†è§£æ›´ç¹ç

2ã€èµ„æºæµªè´¹ï¼ŒRedisæ•°æ®èŠ‚ç‚¹ä¸­slaveèŠ‚ç‚¹ä½œä¸ºå¤‡ä»½èŠ‚ç‚¹ä¸æä¾›æœåŠ¡

3ã€Redis Sentinelä¸»è¦æ˜¯é’ˆå¯¹Redisæ•°æ®èŠ‚ç‚¹ä¸­çš„ä¸»èŠ‚ç‚¹çš„é«˜å¯ç”¨åˆ‡æ¢ï¼Œå¯¹Redisçš„æ•°æ®èŠ‚ç‚¹åšå¤±è´¥åˆ¤å®šåˆ†ä¸ºä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿ä¸¤ç§ï¼Œå¯¹äºRedisçš„ä»èŠ‚ç‚¹æœ‰å¯¹èŠ‚ç‚¹åšä¸»è§‚ä¸‹çº¿æ“ä½œï¼Œå¹¶ä¸æ‰§è¡Œæ•…éšœè½¬ç§»ã€‚

4ã€ä¸èƒ½è§£å†³è¯»å†™åˆ†ç¦»é—®é¢˜ï¼Œå®ç°èµ·æ¥ç›¸å¯¹å¤æ‚



å»ºè®®ï¼š

1ã€å¦‚æœç›‘æ§åŒä¸€ä¸šåŠ¡ï¼Œå¯ä»¥é€‰æ‹©ä¸€å¥—Sentinelé›†ç¾¤ç›‘æ§å¤šç»„Redisæ•°æ®èŠ‚ç‚¹çš„æ–¹æ¡ˆï¼Œåä¹‹é€‰æ‹©ä¸€å¥—Sentinelç›‘æ§ä¸€ç»„Redisæ•°æ®èŠ‚ç‚¹çš„æ–¹æ¡ˆ

2ã€sentinel monitor <master-name> <ip> <port> <quorum>  é…ç½®ä¸­çš„<quorum>å»ºè®®è®¾ç½®æˆSentinelèŠ‚ç‚¹çš„ä¸€åŠåŠ 1ï¼Œå½“Sentineléƒ¨ç½²åœ¨å¤šä¸ªIDCçš„æ—¶å€™ï¼Œå•ä¸ªIDCéƒ¨ç½²çš„Sentinelæ•°é‡ä¸å»ºè®®è¶…è¿‡ï¼ˆSentinelæ•°é‡ â€“ quorumï¼‰ã€‚

3ã€åˆç†è®¾ç½®å‚æ•°ï¼Œé˜²æ­¢è¯¯åˆ‡ï¼Œæ§åˆ¶åˆ‡æ¢çµæ•åº¦æ§åˆ¶

1. quorum
2. down-after-milliseconds 30000
3. failover-timeout 180000
4. maxclient
5. timeout

4ã€éƒ¨ç½²çš„å„ä¸ªèŠ‚ç‚¹æœåŠ¡å™¨æ—¶é—´å°½é‡è¦åŒæ­¥ï¼Œå¦åˆ™æ—¥å¿—çš„æ—¶åºæ€§ä¼šæ··ä¹±

5ã€Rediså»ºè®®ä½¿ç”¨pipelineå’Œmulti-keysæ“ä½œï¼Œå‡å°‘RTTæ¬¡æ•°ï¼Œæé«˜è¯·æ±‚æ•ˆç‡

6ã€è‡ªè¡Œæå®šé…ç½®ä¸­å¿ƒï¼ˆzookeeperï¼‰ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯å¯¹å®ä¾‹çš„é“¾æ¥è®¿é—®



4

Redis Cluster

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/6EJvicazJ6KzImNoKH1nofWM9rqIR6VUWNSEC8dvIoHtWlm4OyK3KxaXc4sSzibK0nFC4hNKhhsPXibrQibFwLOglA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

Redis  Clusteræ˜¯ç¤¾åŒºç‰ˆæ¨å‡ºçš„Redisåˆ†å¸ƒå¼é›†ç¾¤è§£å†³æ–¹æ¡ˆï¼Œä¸»è¦è§£å†³Redisåˆ†å¸ƒå¼æ–¹é¢çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼Œå½“é‡åˆ°å•æœºå†…å­˜ï¼Œå¹¶å‘å’Œæµé‡ç­‰ç“¶é¢ˆçš„æ—¶å€™ï¼ŒRedis Clusterèƒ½èµ·åˆ°å¾ˆå¥½çš„è´Ÿè½½å‡è¡¡çš„ç›®çš„ã€‚Redis  Clusteré›†ç¾¤èŠ‚ç‚¹æœ€å°é…ç½®6ä¸ªèŠ‚ç‚¹ä»¥ä¸Šï¼ˆ3ä¸»3ä»ï¼‰ï¼Œå…¶ä¸­ä¸»èŠ‚ç‚¹æä¾›è¯»å†™æ“ä½œï¼Œä»èŠ‚ç‚¹ä½œä¸ºå¤‡ç”¨èŠ‚ç‚¹ï¼Œä¸æä¾›è¯·æ±‚ï¼Œåªä½œä¸ºæ•…éšœè½¬ç§»ä½¿ç”¨ã€‚Redis  Clusteré‡‡ç”¨è™šæ‹Ÿæ§½åˆ†åŒºï¼Œæ‰€æœ‰çš„é”®æ ¹æ®å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°0ï½16383ä¸ªæ•´æ•°æ§½å†…ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä¸€éƒ¨åˆ†æ§½ä»¥åŠæ§½æ‰€å°æ˜ å°„çš„é”®å€¼æ•°æ®ã€‚



ä¼˜ç‚¹ï¼š

1ã€æ— ä¸­å¿ƒæ¶æ„

2ã€æ•°æ®æŒ‰ç…§slotå­˜å‚¨åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹é—´æ•°æ®å…±äº«ï¼Œå¯åŠ¨æ€è°ƒæ•´æ•°æ®åˆ†å¸ƒã€‚

3ã€å¯æ‰©å±•æ€§ï¼Œå¯çº¿æ€§æ‰©å±•åˆ°1000å¤šä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹å¯åŠ¨æ€æ·»åŠ æˆ–åˆ é™¤ã€‚

4ã€é«˜å¯ç”¨æ€§ï¼Œéƒ¨åˆ†èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œé›†ç¾¤ä»å¯ç”¨ã€‚é€šè¿‡å¢åŠ Slaveåšstandbyæ•°æ®å‰¯æœ¬ï¼Œèƒ½å¤Ÿå®ç°æ•…éšœè‡ªåŠ¨failoverï¼ŒèŠ‚ç‚¹ä¹‹é—´é€šè¿‡gossipåè®®äº¤æ¢çŠ¶æ€ä¿¡æ¯ï¼Œç”¨æŠ•ç¥¨æœºåˆ¶å®ŒæˆSlaveåˆ°Masterçš„è§’è‰²æå‡ã€‚

5ã€é™ä½è¿ç»´æˆæœ¬ï¼Œæé«˜ç³»ç»Ÿçš„æ‰©å±•æ€§å’Œå¯ç”¨æ€§ã€‚



ç¼ºç‚¹ï¼š

1ã€Clientå®ç°å¤æ‚ï¼Œé©±åŠ¨è¦æ±‚å®ç°Smart Clientï¼Œç¼“å­˜slots  mappingä¿¡æ¯å¹¶åŠæ—¶æ›´æ–°ï¼Œæé«˜äº†å¼€å‘éš¾åº¦ï¼Œå®¢æˆ·ç«¯çš„ä¸æˆç†Ÿå½±å“ä¸šåŠ¡çš„ç¨³å®šæ€§ã€‚ç›®å‰ä»…JedisClusterç›¸å¯¹æˆç†Ÿï¼Œå¼‚å¸¸å¤„ç†éƒ¨åˆ†è¿˜ä¸å®Œå–„ï¼Œæ¯”å¦‚å¸¸è§çš„â€œmax redirect exceptionâ€ã€‚

2ã€èŠ‚ç‚¹ä¼šå› ä¸ºæŸäº›åŸå› å‘ç”Ÿé˜»å¡ï¼ˆé˜»å¡æ—¶é—´å¤§äºclutser-node-timeoutï¼‰ï¼Œè¢«åˆ¤æ–­ä¸‹çº¿ï¼Œè¿™ç§failoveræ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚

3ã€æ•°æ®é€šè¿‡å¼‚æ­¥å¤åˆ¶,ä¸ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚

4ã€å¤šä¸ªä¸šåŠ¡ä½¿ç”¨åŒä¸€å¥—é›†ç¾¤æ—¶ï¼Œæ— æ³•æ ¹æ®ç»Ÿè®¡åŒºåˆ†å†·çƒ­æ•°æ®ï¼Œèµ„æºéš”ç¦»æ€§è¾ƒå·®ï¼Œå®¹æ˜“å‡ºç°ç›¸äº’å½±å“çš„æƒ…å†µã€‚

5ã€Slaveåœ¨é›†ç¾¤ä¸­å……å½“â€œå†·å¤‡â€ï¼Œä¸èƒ½ç¼“è§£è¯»å‹åŠ›ï¼Œå½“ç„¶å¯ä»¥é€šè¿‡SDKçš„åˆç†è®¾è®¡æ¥æé«˜Slaveèµ„æºçš„åˆ©ç”¨ç‡ã€‚

6ã€keyæ‰¹é‡æ“ä½œé™åˆ¶ï¼Œå¦‚ä½¿ç”¨msetã€mgetç›®å‰åªæ”¯æŒå…·æœ‰ç›¸åŒslotå€¼çš„keyæ‰§è¡Œæ‰¹é‡æ“ä½œã€‚å¯¹äºæ˜ å°„ä¸ºä¸åŒslotå€¼çš„keyç”±äºkeys ä¸æ”¯æŒè·¨slotæŸ¥è¯¢ï¼Œæ‰€ä»¥æ‰§è¡Œmsetã€mgetã€sunionç­‰æ“ä½œæ”¯æŒä¸å‹å¥½ã€‚

7ã€keyäº‹åŠ¡æ“ä½œæ”¯æŒæœ‰é™ï¼Œåªæ”¯æŒå¤škeyåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šçš„äº‹åŠ¡æ“ä½œï¼Œå½“å¤šä¸ªkeyåˆ†å¸ƒäºä¸åŒçš„èŠ‚ç‚¹ä¸Šæ—¶æ— æ³•ä½¿ç”¨äº‹åŠ¡åŠŸèƒ½ã€‚

8ã€keyä½œä¸ºæ•°æ®åˆ†åŒºçš„æœ€å°ç²’åº¦ï¼Œå› æ­¤ä¸èƒ½å°†ä¸€ä¸ªå¾ˆå¤§çš„é”®å€¼å¯¹è±¡å¦‚hashã€listç­‰æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚

9ã€ä¸æ”¯æŒå¤šæ•°æ®åº“ç©ºé—´ï¼Œå•æœºä¸‹çš„rediså¯ä»¥æ”¯æŒåˆ°16ä¸ªæ•°æ®åº“ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹åªèƒ½ä½¿ç”¨1ä¸ªæ•°æ®åº“ç©ºé—´ï¼Œå³db 0ã€‚

10ã€å¤åˆ¶ç»“æ„åªæ”¯æŒä¸€å±‚ï¼Œä»èŠ‚ç‚¹åªèƒ½å¤åˆ¶ä¸»èŠ‚ç‚¹ï¼Œä¸æ”¯æŒåµŒå¥—æ ‘çŠ¶å¤åˆ¶ç»“æ„ã€‚

11ã€é¿å…äº§ç”Ÿhot-keyï¼Œå¯¼è‡´ä¸»åº“èŠ‚ç‚¹æˆä¸ºç³»ç»Ÿçš„çŸ­æ¿ã€‚

12ã€é¿å…äº§ç”Ÿbig-keyï¼Œå¯¼è‡´ç½‘å¡æ’‘çˆ†ã€æ…¢æŸ¥è¯¢ç­‰ã€‚

13ã€é‡è¯•æ—¶é—´åº”è¯¥å¤§äºcluster-node-timeæ—¶é—´

14ã€Redis Clusterä¸å»ºè®®ä½¿ç”¨pipelineå’Œmulti-keysæ“ä½œï¼Œå‡å°‘max redirectäº§ç”Ÿçš„åœºæ™¯ã€‚



5

Redisè‡ªç ” - æ¨è

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/6EJvicazJ6KzImNoKH1nofWM9rqIR6VUWF5ztvp6RiabrQWvWBPH2pVgibgaAPQ5FLddA0htYRy4kxgz7cgicvY4Rw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/6EJvicazJ6KzImNoKH1nofWM9rqIR6VUW2MdMwUDDibguJCWQrGFeJTE9znLEe1h7wsLFb94MRsjnmWwcdzWeHuA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

Redis è‡ªç ”çš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œä¸»è¦ä½“ç°åœ¨é…ç½®ä¸­å¿ƒã€æ•…éšœæ¢æµ‹å’Œfailoverçš„å¤„ç†æœºåˆ¶ä¸Šï¼Œé€šå¸¸éœ€è¦æ ¹æ®ä¼ä¸šä¸šåŠ¡çš„å®é™…çº¿ä¸Šç¯å¢ƒæ¥å®šåˆ¶åŒ–ã€‚



ä¼˜ç‚¹ï¼š

1ã€é«˜å¯é æ€§ã€é«˜å¯ç”¨æ€§

2ã€è‡ªä¸»å¯æ§æ€§é«˜

3ã€è´´åˆ‡ä¸šåŠ¡å®é™…éœ€æ±‚ï¼Œå¯ç¼©æ€§å¥½ï¼Œå…¼å®¹æ€§å¥½



ç¼ºç‚¹ï¼š

1ã€å®ç°å¤æ‚ï¼Œå¼€å‘æˆæœ¬é«˜

2ã€éœ€è¦å»ºç«‹é…å¥—çš„å‘¨è¾¹è®¾æ–½ï¼Œå¦‚ç›‘æ§ï¼ŒåŸŸåæœåŠ¡ï¼Œå­˜å‚¨å…ƒæ•°æ®ä¿¡æ¯çš„æ•°æ®åº“ç­‰ã€‚

3ã€ç»´æŠ¤æˆæœ¬é«˜



# ç§’æ€ç³»ç»Ÿè®¾è®¡            

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/16/16e72d24415cb009~tplv-t2oaga2asx-watermark.image)

#### åŸºäºå•RedisèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”





é¦–å…ˆï¼ŒRediså®¢æˆ·ç«¯ä¸ºäº†**è·å–é”**ï¼Œå‘RedisèŠ‚ç‚¹å‘é€å¦‚ä¸‹å‘½ä»¤ï¼š

```
SET resource_name my_random_value NX PX 30000
```

ä¸Šé¢çš„å‘½ä»¤å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œåˆ™å®¢æˆ·ç«¯æˆåŠŸè·å–åˆ°äº†é”ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥**è®¿é—®å…±äº«èµ„æº**äº†ï¼›è€Œå¦‚æœä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œåˆ™è¯´æ˜è·å–é”å¤±è´¥ã€‚

æ³¨æ„ï¼Œåœ¨ä¸Šé¢çš„`SET`å‘½ä»¤ä¸­ï¼š

- `my_random_value`æ˜¯ç”±å®¢æˆ·ç«¯ç”Ÿæˆçš„ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼Œå®ƒè¦ä¿è¯åœ¨è¶³å¤Ÿé•¿çš„ä¸€æ®µæ—¶é—´å†…åœ¨æ‰€æœ‰å®¢æˆ·ç«¯çš„æ‰€æœ‰è·å–é”çš„è¯·æ±‚ä¸­éƒ½æ˜¯å”¯ä¸€çš„ã€‚
- `NX`è¡¨ç¤ºåªæœ‰å½“`resource_name`å¯¹åº”çš„keyå€¼ä¸å­˜åœ¨çš„æ—¶å€™æ‰èƒ½`SET`æˆåŠŸã€‚è¿™ä¿è¯äº†åªæœ‰ç¬¬ä¸€ä¸ªè¯·æ±‚çš„å®¢æˆ·ç«¯æ‰èƒ½è·å¾—é”ï¼Œè€Œå…¶å®ƒå®¢æˆ·ç«¯åœ¨é”è¢«é‡Šæ”¾ä¹‹å‰éƒ½æ— æ³•è·å¾—é”ã€‚
- `PX 30000`è¡¨ç¤ºè¿™ä¸ªé”æœ‰ä¸€ä¸ª30ç§’çš„è‡ªåŠ¨è¿‡æœŸæ—¶é—´ã€‚å½“ç„¶ï¼Œè¿™é‡Œ30ç§’åªæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©åˆé€‚çš„è¿‡æœŸæ—¶é—´ã€‚

æœ€åï¼Œå½“å®¢æˆ·ç«¯å®Œæˆäº†å¯¹å…±äº«èµ„æºçš„æ“ä½œä¹‹åï¼Œæ‰§è¡Œä¸‹é¢çš„Redis Luaè„šæœ¬æ¥**é‡Šæ”¾é”**ï¼š

```
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```

è¿™æ®µLuaè„šæœ¬åœ¨æ‰§è¡Œçš„æ—¶å€™è¦æŠŠå‰é¢çš„`my_random_value`ä½œä¸º`ARGV[1]`çš„å€¼ä¼ è¿›å»ï¼ŒæŠŠ`resource_name`ä½œä¸º`KEYS[1]`çš„å€¼ä¼ è¿›å»ã€‚

è‡³æ­¤ï¼ŒåŸºäºå•RedisèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”çš„ç®—æ³•å°±æè¿°å®Œäº†ã€‚è¿™é‡Œé¢æœ‰å¥½å‡ ä¸ªé—®é¢˜éœ€è¦é‡ç‚¹åˆ†æä¸€ä¸‹ã€‚

é¦–å…ˆç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªé”å¿…é¡»è¦è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚å¦åˆ™çš„è¯ï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯è·å–é”æˆåŠŸä¹‹åï¼Œå‡å¦‚å®ƒå´©æºƒäº†ï¼Œæˆ–è€…ç”±äºå‘ç”Ÿäº†ç½‘ç»œåˆ†å‰²ï¼ˆnetwork  partitionï¼‰å¯¼è‡´å®ƒå†ä¹Ÿæ— æ³•å’ŒRedisèŠ‚ç‚¹é€šä¿¡äº†ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šä¸€ç›´æŒæœ‰è¿™ä¸ªé”ï¼Œè€Œå…¶å®ƒå®¢æˆ·ç«¯æ°¸è¿œæ— æ³•è·å¾—é”äº†ã€‚antirezåœ¨åé¢çš„åˆ†æä¸­ä¹Ÿç‰¹åˆ«å¼ºè°ƒäº†è¿™ä¸€ç‚¹ï¼Œè€Œä¸”æŠŠè¿™ä¸ªè¿‡æœŸæ—¶é—´ç§°ä¸ºé”çš„æœ‰æ•ˆæ—¶é—´(lock validity time)ã€‚è·å¾—é”çš„å®¢æˆ·ç«¯å¿…é¡»åœ¨è¿™ä¸ªæ—¶é—´ä¹‹å†…å®Œæˆå¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚

ç¬¬äºŒä¸ªé—®é¢˜ï¼Œç¬¬ä¸€æ­¥**è·å–é”**çš„æ“ä½œï¼Œç½‘ä¸Šä¸å°‘æ–‡ç« æŠŠå®ƒå®ç°æˆäº†ä¸¤ä¸ªRediså‘½ä»¤ï¼š

```
SETNX resource_name my_random_value
EXPIRE resource_name 30
```

è™½ç„¶è¿™ä¸¤ä¸ªå‘½ä»¤å’Œå‰é¢ç®—æ³•æè¿°ä¸­çš„ä¸€ä¸ª`SET`å‘½ä»¤æ‰§è¡Œæ•ˆæœç›¸åŒï¼Œä½†å´ä¸æ˜¯åŸå­çš„ã€‚å¦‚æœå®¢æˆ·ç«¯åœ¨æ‰§è¡Œå®Œ`SETNX`åå´©æºƒäº†ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰æœºä¼šæ‰§è¡Œ`EXPIRE`äº†ï¼Œå¯¼è‡´å®ƒä¸€ç›´æŒæœ‰è¿™ä¸ªé”ã€‚

ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œä¹Ÿæ˜¯antirezæŒ‡å‡ºçš„ï¼Œè®¾ç½®ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²`my_random_value`æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œå®ƒä¿è¯äº†ä¸€ä¸ªå®¢æˆ·ç«¯é‡Šæ”¾çš„é”å¿…é¡»æ˜¯è‡ªå·±æŒæœ‰çš„é‚£ä¸ªé”ã€‚å‡å¦‚è·å–é”æ—¶`SET`çš„ä¸æ˜¯ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‘ç”Ÿä¸‹é¢çš„æ‰§è¡Œåºåˆ—ï¼š

1. å®¢æˆ·ç«¯1è·å–é”æˆåŠŸã€‚
2. å®¢æˆ·ç«¯1åœ¨æŸä¸ªæ“ä½œä¸Šé˜»å¡äº†å¾ˆé•¿æ—¶é—´ã€‚
3. è¿‡æœŸæ—¶é—´åˆ°äº†ï¼Œé”è‡ªåŠ¨é‡Šæ”¾äº†ã€‚
4. å®¢æˆ·ç«¯2è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”ã€‚
5. å®¢æˆ·ç«¯1ä»é˜»å¡ä¸­æ¢å¤è¿‡æ¥ï¼Œé‡Šæ”¾æ‰äº†å®¢æˆ·ç«¯2æŒæœ‰çš„é”ã€‚

ä¹‹åï¼Œå®¢æˆ·ç«¯2åœ¨è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ï¼Œå°±æ²¡æœ‰é”ä¸ºå®ƒæä¾›ä¿æŠ¤äº†ã€‚

ç¬¬å››ä¸ªé—®é¢˜ï¼Œé‡Šæ”¾é”çš„æ“ä½œå¿…é¡»ä½¿ç”¨Luaè„šæœ¬æ¥å®ç°ã€‚é‡Šæ”¾é”å…¶å®åŒ…å«ä¸‰æ­¥æ“ä½œï¼š'GET'ã€åˆ¤æ–­å’Œ'DEL'ï¼Œç”¨Luaè„šæœ¬æ¥å®ç°èƒ½ä¿è¯è¿™ä¸‰æ­¥çš„åŸå­æ€§ã€‚å¦åˆ™ï¼Œå¦‚æœæŠŠè¿™ä¸‰æ­¥æ“ä½œæ”¾åˆ°å®¢æˆ·ç«¯é€»è¾‘ä¸­å»æ‰§è¡Œçš„è¯ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿä¸å‰é¢ç¬¬ä¸‰ä¸ªé—®é¢˜ç±»ä¼¼çš„æ‰§è¡Œåºåˆ—ï¼š

1. å®¢æˆ·ç«¯1è·å–é”æˆåŠŸã€‚
2. å®¢æˆ·ç«¯1è®¿é—®å…±äº«èµ„æºã€‚
3. å®¢æˆ·ç«¯1ä¸ºäº†é‡Šæ”¾é”ï¼Œå…ˆæ‰§è¡Œ'GET'æ“ä½œè·å–éšæœºå­—ç¬¦ä¸²çš„å€¼ã€‚
4. å®¢æˆ·ç«¯1åˆ¤æ–­éšæœºå­—ç¬¦ä¸²çš„å€¼ï¼Œä¸é¢„æœŸçš„å€¼ç›¸ç­‰ã€‚
5. å®¢æˆ·ç«¯1ç”±äºæŸä¸ªåŸå› é˜»å¡ä½äº†å¾ˆé•¿æ—¶é—´ã€‚
6. è¿‡æœŸæ—¶é—´åˆ°äº†ï¼Œé”è‡ªåŠ¨é‡Šæ”¾äº†ã€‚
7. å®¢æˆ·ç«¯2è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”ã€‚
8. å®¢æˆ·ç«¯1ä»é˜»å¡ä¸­æ¢å¤è¿‡æ¥ï¼Œæ‰§è¡Œ`DEL`æ“çºµï¼Œé‡Šæ”¾æ‰äº†å®¢æˆ·ç«¯2æŒæœ‰çš„é”ã€‚

å®é™…ä¸Šï¼Œåœ¨ä¸Šè¿°ç¬¬ä¸‰ä¸ªé—®é¢˜å’Œç¬¬å››ä¸ªé—®é¢˜çš„åˆ†æä¸­ï¼Œå¦‚æœä¸æ˜¯å®¢æˆ·ç«¯é˜»å¡ä½äº†ï¼Œè€Œæ˜¯å‡ºç°äº†å¤§çš„ç½‘ç»œå»¶è¿Ÿï¼Œä¹Ÿæœ‰å¯èƒ½å¯¼è‡´ç±»ä¼¼çš„æ‰§è¡Œåºåˆ—å‘ç”Ÿã€‚

å‰é¢çš„å››ä¸ªé—®é¢˜ï¼Œåªè¦å®ç°åˆ†å¸ƒå¼é”çš„æ—¶å€™åŠ ä»¥æ³¨æ„ï¼Œå°±éƒ½èƒ½å¤Ÿè¢«æ­£ç¡®å¤„ç†ã€‚ä½†é™¤æ­¤ä¹‹å¤–ï¼Œantirezè¿˜æŒ‡å‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯ç”±failoverå¼•èµ·çš„ï¼Œå´æ˜¯åŸºäºå•RedisèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”æ— æ³•è§£å†³çš„ã€‚æ­£æ˜¯è¿™ä¸ªé—®é¢˜å‚¬ç”Ÿäº†Redlockçš„å‡ºç°ã€‚

è¿™ä¸ªé—®é¢˜æ˜¯è¿™æ ·çš„ã€‚å‡å¦‚RedisèŠ‚ç‚¹å®•æœºäº†ï¼Œé‚£ä¹ˆæ‰€æœ‰å®¢æˆ·ç«¯å°±éƒ½æ— æ³•è·å¾—é”äº†ï¼ŒæœåŠ¡å˜å¾—ä¸å¯ç”¨ã€‚ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç»™è¿™ä¸ªRedisèŠ‚ç‚¹æŒ‚ä¸€ä¸ªSlaveï¼Œå½“MasterèŠ‚ç‚¹ä¸å¯ç”¨çš„æ—¶å€™ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ‡åˆ°Slaveä¸Šï¼ˆfailoverï¼‰ã€‚ä½†ç”±äºRedisçš„ä¸»ä»å¤åˆ¶ï¼ˆreplicationï¼‰æ˜¯å¼‚æ­¥çš„ï¼Œè¿™å¯èƒ½å¯¼è‡´åœ¨failoverè¿‡ç¨‹ä¸­ä¸§å¤±é”çš„å®‰å…¨æ€§ã€‚è€ƒè™‘ä¸‹é¢çš„æ‰§è¡Œåºåˆ—ï¼š

1. å®¢æˆ·ç«¯1ä»Masterè·å–äº†é”ã€‚
2. Masterå®•æœºäº†ï¼Œå­˜å‚¨é”çš„keyè¿˜æ²¡æœ‰æ¥å¾—åŠåŒæ­¥åˆ°Slaveä¸Šã€‚
3. Slaveå‡çº§ä¸ºMasterã€‚
4. å®¢æˆ·ç«¯2ä»æ–°çš„Masterè·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”ã€‚

äºæ˜¯ï¼Œå®¢æˆ·ç«¯1å’Œå®¢æˆ·ç«¯2åŒæ—¶æŒæœ‰äº†åŒä¸€ä¸ªèµ„æºçš„é”ã€‚é”çš„å®‰å…¨æ€§è¢«æ‰“ç ´ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œantirezè®¾è®¡äº†Redlockç®—æ³•ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šè®¨è®ºã€‚

#### åˆ†å¸ƒå¼é”Redlock





ç”±äºå‰é¢ä»‹ç»çš„åŸºäºå•RedisèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”åœ¨failoverçš„æ—¶å€™ä¼šäº§ç”Ÿè§£å†³ä¸äº†çš„å®‰å…¨æ€§é—®é¢˜ï¼Œå› æ­¤antirezæå‡ºäº†æ–°çš„åˆ†å¸ƒå¼é”çš„ç®—æ³•Redlockï¼Œå®ƒåŸºäºNä¸ªå®Œå…¨ç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼ˆé€šå¸¸æƒ…å†µä¸‹Nå¯ä»¥è®¾ç½®æˆ5ï¼‰ã€‚

è¿è¡ŒRedlockç®—æ³•çš„å®¢æˆ·ç«¯ä¾æ¬¡æ‰§è¡Œä¸‹é¢å„ä¸ªæ­¥éª¤ï¼Œæ¥å®Œæˆ**è·å–é”**çš„æ“ä½œï¼š

1. è·å–å½“å‰æ—¶é—´ï¼ˆæ¯«ç§’æ•°ï¼‰ã€‚
2. æŒ‰é¡ºåºä¾æ¬¡å‘Nä¸ªRedisèŠ‚ç‚¹æ‰§è¡Œ**è·å–é”**çš„æ“ä½œã€‚è¿™ä¸ªè·å–æ“ä½œè·Ÿå‰é¢åŸºäºå•RedisèŠ‚ç‚¹çš„**è·å–é”**çš„è¿‡ç¨‹ç›¸åŒï¼ŒåŒ…å«éšæœºå­—ç¬¦ä¸²`my_random_value`ï¼Œä¹ŸåŒ…å«è¿‡æœŸæ—¶é—´(æ¯”å¦‚`PX 30000`ï¼Œå³é”çš„æœ‰æ•ˆæ—¶é—´)ã€‚ä¸ºäº†ä¿è¯åœ¨æŸä¸ªRedisèŠ‚ç‚¹ä¸å¯ç”¨çš„æ—¶å€™ç®—æ³•èƒ½å¤Ÿç»§ç»­è¿è¡Œï¼Œè¿™ä¸ª**è·å–é”**çš„æ“ä½œè¿˜æœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´(time  out)ï¼Œå®ƒè¦è¿œå°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼ˆå‡ åæ¯«ç§’é‡çº§ï¼‰ã€‚å®¢æˆ·ç«¯åœ¨å‘æŸä¸ªRedisèŠ‚ç‚¹è·å–é”å¤±è´¥ä»¥åï¼Œåº”è¯¥ç«‹å³å°è¯•ä¸‹ä¸€ä¸ªRedisèŠ‚ç‚¹ã€‚è¿™é‡Œçš„å¤±è´¥ï¼Œåº”è¯¥åŒ…å«ä»»ä½•ç±»å‹çš„å¤±è´¥ï¼Œæ¯”å¦‚è¯¥RedisèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œæˆ–è€…è¯¥RedisèŠ‚ç‚¹ä¸Šçš„é”å·²ç»è¢«å…¶å®ƒå®¢æˆ·ç«¯æŒæœ‰ï¼ˆæ³¨ï¼šRedlockåŸæ–‡ä¸­è¿™é‡Œåªæåˆ°äº†RedisèŠ‚ç‚¹ä¸å¯ç”¨çš„æƒ…å†µï¼Œä½†ä¹Ÿåº”è¯¥åŒ…å«å…¶å®ƒçš„å¤±è´¥æƒ…å†µï¼‰ã€‚
3. è®¡ç®—æ•´ä¸ªè·å–é”çš„è¿‡ç¨‹æ€»å…±æ¶ˆè€—äº†å¤šé•¿æ—¶é—´ï¼Œè®¡ç®—æ–¹æ³•æ˜¯ç”¨å½“å‰æ—¶é—´å‡å»ç¬¬1æ­¥è®°å½•çš„æ—¶é—´ã€‚å¦‚æœå®¢æˆ·ç«¯ä»å¤§å¤šæ•°RedisèŠ‚ç‚¹ï¼ˆ>= N/2+1ï¼‰æˆåŠŸè·å–åˆ°äº†é”ï¼Œå¹¶ä¸”è·å–é”æ€»å…±æ¶ˆè€—çš„æ—¶é—´æ²¡æœ‰è¶…è¿‡é”çš„æœ‰æ•ˆæ—¶é—´(lock validity  time)ï¼Œé‚£ä¹ˆè¿™æ—¶å®¢æˆ·ç«¯æ‰è®¤ä¸ºæœ€ç»ˆè·å–é”æˆåŠŸï¼›å¦åˆ™ï¼Œè®¤ä¸ºæœ€ç»ˆè·å–é”å¤±è´¥ã€‚
4. å¦‚æœæœ€ç»ˆè·å–é”æˆåŠŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªé”çš„æœ‰æ•ˆæ—¶é—´åº”è¯¥é‡æ–°è®¡ç®—ï¼Œå®ƒç­‰äºæœ€åˆçš„é”çš„æœ‰æ•ˆæ—¶é—´å‡å»ç¬¬3æ­¥è®¡ç®—å‡ºæ¥çš„è·å–é”æ¶ˆè€—çš„æ—¶é—´ã€‚
5. å¦‚æœæœ€ç»ˆè·å–é”å¤±è´¥äº†ï¼ˆå¯èƒ½ç”±äºè·å–åˆ°é”çš„RedisèŠ‚ç‚¹ä¸ªæ•°å°‘äºN/2+1ï¼Œæˆ–è€…æ•´ä¸ªè·å–é”çš„è¿‡ç¨‹æ¶ˆè€—çš„æ—¶é—´è¶…è¿‡äº†é”çš„æœ€åˆæœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åº”è¯¥ç«‹å³å‘æ‰€æœ‰RedisèŠ‚ç‚¹å‘èµ·**é‡Šæ”¾é”**çš„æ“ä½œï¼ˆå³å‰é¢ä»‹ç»çš„Redis Luaè„šæœ¬ï¼‰ã€‚

å½“ç„¶ï¼Œä¸Šé¢æè¿°çš„åªæ˜¯**è·å–é”**çš„è¿‡ç¨‹ï¼Œè€Œ**é‡Šæ”¾é”**çš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼šå®¢æˆ·ç«¯å‘æ‰€æœ‰RedisèŠ‚ç‚¹å‘èµ·**é‡Šæ”¾é”**çš„æ“ä½œï¼Œä¸ç®¡è¿™äº›èŠ‚ç‚¹å½“æ—¶åœ¨è·å–é”çš„æ—¶å€™æˆåŠŸä¸å¦ã€‚

**watchdog**

ä¹Ÿå«åšçœ‹é—¨ç‹—ï¼Œä¹Ÿå°±æ˜¯è§£å†³äº†é”è¶…æ—¶å¯¼è‡´çš„é—®é¢˜ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œé»˜è®¤æ¯éš”10ç§’è‡ªåŠ¨å»¶é•¿é”çš„è¿‡æœŸæ—¶é—´ã€‚

é»˜è®¤çš„æ—¶é—´å°±æ˜¯`internalLockLeaseTime / 3`ï¼Œ`internalLockLeaseTime`é»˜è®¤ä¸º30ç§’ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUkr0NZvdnibzGXkPiaucEtNLZFJ9oEDU1MhjPp4NRG330YwQj242MfgxPImklxUVfcbWgU5dMMRuoKQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### æœ€åï¼Œå®é™…ç”Ÿäº§ä¸­å¯¹äºä¸åŒçš„åœºæ™¯è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ

ç”±äºNä¸ªRedisèŠ‚ç‚¹ä¸­çš„å¤§å¤šæ•°èƒ½æ­£å¸¸å·¥ä½œå°±èƒ½ä¿è¯Redlockæ­£å¸¸å·¥ä½œï¼Œå› æ­¤ç†è®ºä¸Šå®ƒçš„å¯ç”¨æ€§æ›´é«˜ã€‚æˆ‘ä»¬å‰é¢è®¨è®ºçš„å•RedisèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”åœ¨failoverçš„æ—¶å€™é”å¤±æ•ˆçš„é—®é¢˜ï¼Œåœ¨Redlockä¸­ä¸å­˜åœ¨äº†ï¼Œä½†å¦‚æœæœ‰èŠ‚ç‚¹å‘ç”Ÿå´©æºƒé‡å¯ï¼Œè¿˜æ˜¯ä¼šå¯¹é”çš„å®‰å…¨æ€§æœ‰å½±å“çš„ã€‚å…·ä½“çš„å½±å“ç¨‹åº¦è·ŸRediså¯¹æ•°æ®çš„æŒä¹…åŒ–ç¨‹åº¦æœ‰å…³ã€‚

å‡è®¾ä¸€å…±æœ‰5ä¸ªRedisèŠ‚ç‚¹ï¼šA, B, C, D, Eã€‚è®¾æƒ³å‘ç”Ÿäº†å¦‚ä¸‹çš„äº‹ä»¶åºåˆ—ï¼š

1. å®¢æˆ·ç«¯1æˆåŠŸé”ä½äº†A, B, Cï¼Œ**è·å–é”**æˆåŠŸï¼ˆä½†Då’ŒEæ²¡æœ‰é”ä½ï¼‰ã€‚
2. èŠ‚ç‚¹Cå´©æºƒé‡å¯äº†ï¼Œä½†å®¢æˆ·ç«¯1åœ¨Cä¸ŠåŠ çš„é”æ²¡æœ‰æŒä¹…åŒ–ä¸‹æ¥ï¼Œä¸¢å¤±äº†ã€‚
3. èŠ‚ç‚¹Cé‡å¯åï¼Œå®¢æˆ·ç«¯2é”ä½äº†C, D, Eï¼Œ**è·å–é”**æˆåŠŸã€‚

è¿™æ ·ï¼Œå®¢æˆ·ç«¯1å’Œå®¢æˆ·ç«¯2åŒæ—¶è·å¾—äº†é”ï¼ˆé’ˆå¯¹åŒä¸€èµ„æºï¼‰ã€‚

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒRedisçš„AOFæŒä¹…åŒ–æ–¹å¼æ˜¯æ¯ç§’å†™ä¸€æ¬¡ç£ç›˜ï¼ˆå³æ‰§è¡Œfsyncï¼‰ï¼Œå› æ­¤æœ€åæƒ…å†µä¸‹å¯èƒ½ä¸¢å¤±1ç§’çš„æ•°æ®ã€‚ä¸ºäº†å°½å¯èƒ½ä¸ä¸¢æ•°æ®ï¼ŒRediså…è®¸è®¾ç½®æˆæ¯æ¬¡ä¿®æ”¹æ•°æ®éƒ½è¿›è¡Œfsyncï¼Œä½†è¿™ä¼šé™ä½æ€§èƒ½ã€‚å½“ç„¶ï¼Œå³ä½¿æ‰§è¡Œäº†fsyncä¹Ÿä»ç„¶æœ‰å¯èƒ½ä¸¢å¤±æ•°æ®ï¼ˆè¿™å–å†³äºç³»ç»Ÿè€Œä¸æ˜¯Redisçš„å®ç°ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸Šé¢åˆ†æçš„ç”±äºèŠ‚ç‚¹é‡å¯å¼•å‘çš„é”å¤±æ•ˆé—®é¢˜ï¼Œæ€»æ˜¯æœ‰å¯èƒ½å‡ºç°çš„ã€‚ä¸ºäº†åº”å¯¹è¿™ä¸€é—®é¢˜ï¼Œantirezåˆæå‡ºäº†**å»¶è¿Ÿé‡å¯**(delayed restarts)çš„æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªèŠ‚ç‚¹å´©æºƒåï¼Œå…ˆä¸ç«‹å³é‡å¯å®ƒï¼Œè€Œæ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡å¯ï¼Œè¿™æ®µæ—¶é—´åº”è¯¥å¤§äºé”çš„æœ‰æ•ˆæ—¶é—´(lock  validity time)ã€‚è¿™æ ·çš„è¯ï¼Œè¿™ä¸ªèŠ‚ç‚¹åœ¨é‡å¯å‰æ‰€å‚ä¸çš„é”éƒ½ä¼šè¿‡æœŸï¼Œå®ƒåœ¨é‡å¯åå°±ä¸ä¼šå¯¹ç°æœ‰çš„é”é€ æˆå½±å“ã€‚

å…³äºRedlockè¿˜æœ‰ä¸€ç‚¹ç»†èŠ‚å€¼å¾—æ‹¿å‡ºæ¥åˆ†æä¸€ä¸‹ï¼šåœ¨æœ€å**é‡Šæ”¾é”**çš„æ—¶å€™ï¼Œantirezåœ¨ç®—æ³•æè¿°ä¸­ç‰¹åˆ«å¼ºè°ƒï¼Œå®¢æˆ·ç«¯åº”è¯¥å‘æ‰€æœ‰RedisèŠ‚ç‚¹å‘èµ·**é‡Šæ”¾é”**çš„æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿å½“æ—¶å‘æŸä¸ªèŠ‚ç‚¹è·å–é”æ²¡æœ‰æˆåŠŸï¼Œåœ¨é‡Šæ”¾é”çš„æ—¶å€™ä¹Ÿä¸åº”è¯¥æ¼æ‰è¿™ä¸ªèŠ‚ç‚¹ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè®¾æƒ³è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå®¢æˆ·ç«¯å‘ç»™æŸä¸ªRedisèŠ‚ç‚¹çš„**è·å–é”**çš„è¯·æ±‚æˆåŠŸåˆ°è¾¾äº†è¯¥RedisèŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¹ŸæˆåŠŸæ‰§è¡Œäº†`SET`æ“ä½œï¼Œä½†æ˜¯å®ƒè¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”åŒ…å´ä¸¢å¤±äº†ã€‚è¿™åœ¨å®¢æˆ·ç«¯çœ‹æ¥ï¼Œè·å–é”çš„è¯·æ±‚ç”±äºè¶…æ—¶è€Œå¤±è´¥äº†ï¼Œä½†åœ¨Redisè¿™è¾¹çœ‹æ¥ï¼ŒåŠ é”å·²ç»æˆåŠŸäº†ã€‚å› æ­¤ï¼Œé‡Šæ”¾é”çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¹Ÿåº”è¯¥å¯¹å½“æ—¶è·å–é”å¤±è´¥çš„é‚£äº›RedisèŠ‚ç‚¹åŒæ ·å‘èµ·è¯·æ±‚ã€‚å®é™…ä¸Šï¼Œè¿™ç§æƒ…å†µåœ¨å¼‚æ­¥é€šä¿¡æ¨¡å‹ä¸­æ˜¯æœ‰å¯èƒ½å‘ç”Ÿçš„ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡å™¨é€šä¿¡æ˜¯æ­£å¸¸çš„ï¼Œä½†åæ–¹å‘å´æ˜¯æœ‰é—®é¢˜çš„ã€‚

ã€***å…¶å®ƒç–‘é—®\***ã€‘

å‰é¢åœ¨è®¨è®ºå•RedisèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”çš„æ—¶å€™ï¼Œæœ€åæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªç–‘é—®ï¼Œå¦‚æœå®¢æˆ·ç«¯é•¿æœŸé˜»å¡å¯¼è‡´é”è¿‡æœŸï¼Œé‚£ä¹ˆå®ƒæ¥ä¸‹æ¥è®¿é—®å…±äº«èµ„æºå°±ä¸å®‰å…¨äº†ï¼ˆæ²¡æœ‰äº†é”çš„ä¿æŠ¤ï¼‰ã€‚è¿™ä¸ªé—®é¢˜åœ¨Redlockä¸­æ˜¯å¦æœ‰æ‰€æ”¹å–„å‘¢ï¼Ÿæ˜¾ç„¶ï¼Œè¿™æ ·çš„é—®é¢˜åœ¨Redlockä¸­æ˜¯ä¾ç„¶å­˜åœ¨çš„ã€‚

å¦å¤–ï¼Œåœ¨ç®—æ³•ç¬¬4æ­¥æˆåŠŸè·å–äº†é”ä¹‹åï¼Œå¦‚æœç”±äºè·å–é”çš„è¿‡ç¨‹æ¶ˆè€—äº†è¾ƒé•¿æ—¶é—´ï¼Œé‡æ–°è®¡ç®—å‡ºæ¥çš„å‰©ä½™çš„é”æœ‰æ•ˆæ—¶é—´å¾ˆçŸ­äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜æ¥å¾—åŠå»å®Œæˆå…±äº«èµ„æºè®¿é—®å—ï¼Ÿå¦‚æœæˆ‘ä»¬è®¤ä¸ºå¤ªçŸ­ï¼Œæ˜¯ä¸æ˜¯åº”è¯¥ç«‹å³è¿›è¡Œé”çš„é‡Šæ”¾æ“ä½œï¼Ÿé‚£åˆ°åº•å¤šçŸ­æ‰ç®—å‘¢ï¼Ÿåˆæ˜¯ä¸€ä¸ªé€‰æ‹©éš¾é¢˜ã€‚



### Martinçš„åˆ†æ





Martin Kleppmannåœ¨2016-02-08è¿™ä¸€å¤©å‘è¡¨äº†ä¸€ç¯‡blogï¼Œåå­—å«"How to do distributed locking"ï¼Œåœ°å€å¦‚ä¸‹ï¼š

- https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html

Martinåœ¨è¿™ç¯‡æ–‡ç« ä¸­è°ˆåŠäº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¾ˆå¤šåŸºç¡€æ€§çš„é—®é¢˜ï¼ˆç‰¹åˆ«æ˜¯åˆ†å¸ƒå¼è®¡ç®—çš„å¼‚æ­¥æ¨¡å‹ï¼‰ï¼Œå¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä»ä¸šè€…æ¥è¯´éå¸¸å€¼å¾—ä¸€è¯»ã€‚è¿™ç¯‡æ–‡ç« å¤§ä½“å¯ä»¥åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

- å‰åŠéƒ¨åˆ†ï¼Œä¸Redlockæ— å…³ã€‚MartinæŒ‡å‡ºï¼Œå³ä½¿æˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªå®Œç¾å®ç°çš„åˆ†å¸ƒå¼é”ï¼ˆå¸¦è‡ªåŠ¨è¿‡æœŸåŠŸèƒ½ï¼‰ï¼Œåœ¨æ²¡æœ‰å…±äº«èµ„æºå‚ä¸è¿›æ¥æä¾›æŸç§fencingæœºåˆ¶çš„å‰æä¸‹ï¼Œæˆ‘ä»¬ä»ç„¶ä¸å¯èƒ½è·å¾—è¶³å¤Ÿçš„å®‰å…¨æ€§ã€‚
- ååŠéƒ¨åˆ†ï¼Œæ˜¯å¯¹Redlockæœ¬èº«çš„æ‰¹è¯„ã€‚MartinæŒ‡å‡ºï¼Œç”±äºRedlockæœ¬è´¨ä¸Šæ˜¯å»ºç«‹åœ¨ä¸€ä¸ªåŒæ­¥æ¨¡å‹ä¹‹ä¸Šï¼Œå¯¹ç³»ç»Ÿçš„è®°æ—¶å‡è®¾(timing assumption)æœ‰å¾ˆå¼ºçš„è¦æ±‚ï¼Œå› æ­¤æœ¬èº«çš„å®‰å…¨æ€§æ˜¯ä¸å¤Ÿçš„ã€‚

é¦–å…ˆæˆ‘ä»¬è®¨è®ºä¸€ä¸‹å‰åŠéƒ¨åˆ†çš„å…³é”®ç‚¹ã€‚Martinç»™å‡ºäº†ä¸‹é¢è¿™æ ·ä¸€ä»½æ—¶åºå›¾ï¼š

![å›¾ç‰‡](http://mmbiz.qpic.cn/mmbiz_png/qR4rtg9Wfej8vSic8l7ICJyXuU2PwibtddBsbjPwOt2xod1YtoicVoVibbo8Jiaw2QdXmM2zBCbCcghrK8VGENIicZ6w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

åœ¨ä¸Šé¢çš„æ—¶åºå›¾ä¸­ï¼Œå‡è®¾é”æœåŠ¡æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå®ƒæ€»æ˜¯èƒ½ä¿è¯ä»»ä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è·å¾—é”ã€‚ä¸Šå›¾ä¸­å‡ºç°çš„leaseè¿™ä¸ªè¯å¯ä»¥æš‚ä¸”è®¤ä¸ºå°±ç­‰åŒäºä¸€ä¸ªå¸¦æœ‰è‡ªåŠ¨è¿‡æœŸåŠŸèƒ½çš„é”ã€‚å®¢æˆ·ç«¯1åœ¨è·å¾—é”ä¹‹åå‘ç”Ÿäº†å¾ˆé•¿æ—¶é—´çš„GC pauseï¼Œåœ¨æ­¤æœŸé—´ï¼Œå®ƒè·å¾—çš„é”è¿‡æœŸäº†ï¼Œè€Œå®¢æˆ·ç«¯2è·å¾—äº†é”ã€‚å½“å®¢æˆ·ç«¯1ä»GC  pauseä¸­æ¢å¤è¿‡æ¥çš„æ—¶å€™ï¼Œå®ƒä¸çŸ¥é“è‡ªå·±æŒæœ‰çš„é”å·²ç»è¿‡æœŸäº†ï¼Œå®ƒä¾ç„¶å‘å…±äº«èµ„æºï¼ˆä¸Šå›¾ä¸­æ˜¯ä¸€ä¸ªå­˜å‚¨æœåŠ¡ï¼‰å‘èµ·äº†å†™æ•°æ®è¯·æ±‚ï¼Œè€Œè¿™æ—¶é”å®é™…ä¸Šè¢«å®¢æˆ·ç«¯2æŒæœ‰ï¼Œå› æ­¤ä¸¤ä¸ªå®¢æˆ·ç«¯çš„å†™è¯·æ±‚å°±æœ‰å¯èƒ½å†²çªï¼ˆé”çš„äº’æ–¥ä½œç”¨å¤±æ•ˆäº†ï¼‰ã€‚

åˆçœ‹ä¸Šå»ï¼Œæœ‰äººå¯èƒ½ä¼šè¯´ï¼Œæ—¢ç„¶å®¢æˆ·ç«¯1ä»GC pauseä¸­æ¢å¤è¿‡æ¥ä»¥åä¸çŸ¥é“è‡ªå·±æŒæœ‰çš„é”å·²ç»è¿‡æœŸäº†ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥åœ¨è®¿é—®å…±äº«èµ„æºä¹‹å‰å…ˆåˆ¤æ–­ä¸€ä¸‹é”æ˜¯å¦è¿‡æœŸã€‚ä½†ä»”ç»†æƒ³æƒ³ï¼Œè¿™ä¸æ¯«ä¹Ÿæ²¡æœ‰å¸®åŠ©ã€‚å› ä¸ºGC pauseå¯èƒ½å‘ç”Ÿåœ¨ä»»æ„æ—¶åˆ»ï¼Œä¹Ÿè®¸æ°å¥½åœ¨åˆ¤æ–­å®Œä¹‹åã€‚

ä¹Ÿæœ‰äººä¼šè¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨æ²¡æœ‰GCçš„è¯­è¨€æ¥å®ç°ï¼Œæ˜¯ä¸æ˜¯å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜å‘¢ï¼ŸMartinæŒ‡å‡ºï¼Œç³»ç»Ÿç¯å¢ƒå¤ªå¤æ‚ï¼Œä»ç„¶æœ‰å¾ˆå¤šåŸå› å¯¼è‡´è¿›ç¨‹çš„pauseï¼Œæ¯”å¦‚è™šå­˜é€ æˆçš„ç¼ºé¡µæ•…éšœ(page fault)ï¼Œå†æ¯”å¦‚CPUèµ„æºçš„ç«äº‰ã€‚å³ä½¿ä¸è€ƒè™‘è¿›ç¨‹pauseçš„æƒ…å†µï¼Œç½‘ç»œå»¶è¿Ÿä¹Ÿä»ç„¶ä¼šé€ æˆç±»ä¼¼çš„ç»“æœã€‚

æ€»ç»“èµ·æ¥å°±æ˜¯è¯´ï¼Œå³ä½¿é”æœåŠ¡æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œè€Œä»…ä»…æ˜¯å®¢æˆ·ç«¯æœ‰é•¿æ—¶é—´çš„pauseæˆ–ç½‘ç»œå»¶è¿Ÿï¼Œä»ç„¶ä¼šé€ æˆä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„å†²çªæƒ…å†µå‘ç”Ÿã€‚è€Œè¿™ç§æƒ…å†µå…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨å‰é¢å·²ç»æå‡ºæ¥çš„â€œå®¢æˆ·ç«¯é•¿æœŸé˜»å¡å¯¼è‡´é”è¿‡æœŸâ€çš„é‚£ä¸ªç–‘é—®ã€‚

é‚£æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼ŸMartinç»™å‡ºäº†ä¸€ç§æ–¹æ³•ï¼Œç§°ä¸ºfencing tokenã€‚fencing  tokenæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„æ•°å­—ï¼Œå½“å®¢æˆ·ç«¯æˆåŠŸè·å–é”çš„æ—¶å€™å®ƒéšåŒé”ä¸€èµ·è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è€Œå®¢æˆ·ç«¯è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™å¸¦ç€è¿™ä¸ªfencing  tokenï¼Œè¿™æ ·æä¾›å…±äº«èµ„æºçš„æœåŠ¡å°±èƒ½æ ¹æ®å®ƒè¿›è¡Œæ£€æŸ¥ï¼Œæ‹’ç»æ‰å»¶è¿Ÿåˆ°æ¥çš„è®¿é—®è¯·æ±‚ï¼ˆé¿å…äº†å†²çªï¼‰ã€‚å¦‚ä¸‹å›¾ï¼š

![å›¾ç‰‡](http://mmbiz.qpic.cn/mmbiz_png/qR4rtg9Wfej8vSic8l7ICJyXuU2PwibtddYe5ALGjZntmclabVY714kNdRfTKtECXhibZVKlEIGseClQiaRLRUDRnA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

åœ¨ä¸Šå›¾ä¸­ï¼Œå®¢æˆ·ç«¯1å…ˆè·å–åˆ°çš„é”ï¼Œå› æ­¤æœ‰ä¸€ä¸ªè¾ƒå°çš„fencing tokenï¼Œç­‰äº33ï¼Œè€Œå®¢æˆ·ç«¯2åè·å–åˆ°çš„é”ï¼Œæœ‰ä¸€ä¸ªè¾ƒå¤§çš„fencing tokenï¼Œç­‰äº34ã€‚å®¢æˆ·ç«¯1ä»GC  pauseä¸­æ¢å¤è¿‡æ¥ä¹‹åï¼Œä¾ç„¶æ˜¯å‘å­˜å‚¨æœåŠ¡å‘é€è®¿é—®è¯·æ±‚ï¼Œä½†æ˜¯å¸¦äº†fencing token =  33ã€‚å­˜å‚¨æœåŠ¡å‘ç°å®ƒä¹‹å‰å·²ç»å¤„ç†è¿‡34çš„è¯·æ±‚ï¼Œæ‰€ä»¥ä¼šæ‹’ç»æ‰è¿™æ¬¡33çš„è¯·æ±‚ã€‚è¿™æ ·å°±é¿å…äº†å†²çªã€‚

ç°åœ¨æˆ‘ä»¬å†è®¨è®ºä¸€ä¸‹Martinçš„æ–‡ç« çš„ååŠéƒ¨åˆ†ã€‚

Martinåœ¨æ–‡ä¸­æ„é€ äº†ä¸€äº›äº‹ä»¶åºåˆ—ï¼Œèƒ½å¤Ÿè®©Redlockå¤±æ•ˆï¼ˆä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶æŒæœ‰é”ï¼‰ã€‚ä¸ºäº†è¯´æ˜Redlockå¯¹ç³»ç»Ÿè®°æ—¶(timing)çš„è¿‡åˆ†ä¾èµ–ï¼Œä»–é¦–å…ˆç»™å‡ºäº†ä¸‹é¢çš„ä¸€ä¸ªä¾‹å­ï¼ˆè¿˜æ˜¯å‡è®¾æœ‰5ä¸ªRedisèŠ‚ç‚¹A, B, C, D, Eï¼‰ï¼š

1. å®¢æˆ·ç«¯1ä»RedisèŠ‚ç‚¹A, B, CæˆåŠŸè·å–äº†é”ï¼ˆå¤šæ•°èŠ‚ç‚¹ï¼‰ã€‚ç”±äºç½‘ç»œé—®é¢˜ï¼Œä¸Då’ŒEé€šä¿¡å¤±è´¥ã€‚
2. èŠ‚ç‚¹Cä¸Šçš„æ—¶é’Ÿå‘ç”Ÿäº†å‘å‰è·³è·ƒï¼Œå¯¼è‡´å®ƒä¸Šé¢ç»´æŠ¤çš„é”å¿«é€Ÿè¿‡æœŸã€‚
3. å®¢æˆ·ç«¯2ä»RedisèŠ‚ç‚¹C, D, EæˆåŠŸè·å–äº†åŒä¸€ä¸ªèµ„æºçš„é”ï¼ˆå¤šæ•°èŠ‚ç‚¹ï¼‰ã€‚
4. å®¢æˆ·ç«¯1å’Œå®¢æˆ·ç«¯2ç°åœ¨éƒ½è®¤ä¸ºè‡ªå·±æŒæœ‰äº†é”ã€‚

ä¸Šé¢è¿™ç§æƒ…å†µä¹‹æ‰€ä»¥æœ‰å¯èƒ½å‘ç”Ÿï¼Œæœ¬è´¨ä¸Šæ˜¯å› ä¸ºRedlockçš„å®‰å…¨æ€§(safety  property)å¯¹ç³»ç»Ÿçš„æ—¶é’Ÿæœ‰æ¯”è¾ƒå¼ºçš„ä¾èµ–ï¼Œä¸€æ—¦ç³»ç»Ÿçš„æ—¶é’Ÿå˜å¾—ä¸å‡†ç¡®ï¼Œç®—æ³•çš„å®‰å…¨æ€§ä¹Ÿå°±ä¿è¯ä¸äº†äº†ã€‚Martinåœ¨è¿™é‡Œå…¶å®æ˜¯è¦æŒ‡å‡ºåˆ†å¸ƒå¼ç®—æ³•ç ”ç©¶ä¸­çš„ä¸€äº›åŸºç¡€æ€§é—®é¢˜ï¼Œæˆ–è€…è¯´ä¸€äº›å¸¸è¯†é—®é¢˜ï¼Œå³å¥½çš„åˆ†å¸ƒå¼ç®—æ³•åº”è¯¥åŸºäºå¼‚æ­¥æ¨¡å‹(asynchronous model)ï¼Œç®—æ³•çš„å®‰å…¨æ€§ä¸åº”è¯¥ä¾èµ–äºä»»ä½•è®°æ—¶å‡è®¾(timing  assumption)ã€‚åœ¨å¼‚æ­¥æ¨¡å‹ä¸­ï¼šè¿›ç¨‹å¯èƒ½pauseä»»æ„é•¿çš„æ—¶é—´ï¼Œæ¶ˆæ¯å¯èƒ½åœ¨ç½‘ç»œä¸­å»¶è¿Ÿä»»æ„é•¿çš„æ—¶é—´ï¼Œç”šè‡³ä¸¢å¤±ï¼Œç³»ç»Ÿæ—¶é’Ÿä¹Ÿå¯èƒ½ä»¥ä»»æ„æ–¹å¼å‡ºé”™ã€‚ä¸€ä¸ªå¥½çš„åˆ†å¸ƒå¼ç®—æ³•ï¼Œè¿™äº›å› ç´ ä¸åº”è¯¥å½±å“å®ƒçš„å®‰å…¨æ€§(safety property)ï¼Œåªå¯èƒ½å½±å“åˆ°å®ƒçš„æ´»æ€§(liveness  property)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿åœ¨éå¸¸æç«¯çš„æƒ…å†µä¸‹ï¼ˆæ¯”å¦‚ç³»ç»Ÿæ—¶é’Ÿä¸¥é‡é”™è¯¯ï¼‰ï¼Œç®—æ³•é¡¶å¤šæ˜¯ä¸èƒ½åœ¨æœ‰é™çš„æ—¶é—´å†…ç»™å‡ºç»“æœè€Œå·²ï¼Œè€Œä¸åº”è¯¥ç»™å‡ºé”™è¯¯çš„ç»“æœã€‚è¿™æ ·çš„ç®—æ³•åœ¨ç°å®ä¸­æ˜¯å­˜åœ¨çš„ï¼Œåƒæ¯”è¾ƒè‘—åçš„Paxosï¼Œæˆ–Raftã€‚ä½†æ˜¾ç„¶æŒ‰è¿™ä¸ªæ ‡å‡†çš„è¯ï¼ŒRedlockçš„å®‰å…¨æ€§çº§åˆ«æ˜¯è¾¾ä¸åˆ°çš„ã€‚

éšåï¼ŒMartinè§‰å¾—å‰é¢è¿™ä¸ªæ—¶é’Ÿè·³è·ƒçš„ä¾‹å­è¿˜ä¸å¤Ÿï¼Œåˆç»™å‡ºäº†ä¸€ä¸ªç”±å®¢æˆ·ç«¯GC pauseå¼•å‘Redlockå¤±æ•ˆçš„ä¾‹å­ã€‚å¦‚ä¸‹ï¼š

1. å®¢æˆ·ç«¯1å‘RedisèŠ‚ç‚¹A, B, C, D, Eå‘èµ·é”è¯·æ±‚ã€‚
2. å„ä¸ªRedisèŠ‚ç‚¹å·²ç»æŠŠè¯·æ±‚ç»“æœè¿”å›ç»™äº†å®¢æˆ·ç«¯1ï¼Œä½†å®¢æˆ·ç«¯1åœ¨æ”¶åˆ°è¯·æ±‚ç»“æœä¹‹å‰è¿›å…¥äº†é•¿æ—¶é—´çš„GC pauseã€‚
3. åœ¨æ‰€æœ‰çš„RedisèŠ‚ç‚¹ä¸Šï¼Œé”è¿‡æœŸäº†ã€‚
4. å®¢æˆ·ç«¯2åœ¨A, B, C, D, Eä¸Šè·å–åˆ°äº†é”ã€‚
5. å®¢æˆ·ç«¯1ä»GC pauseä»æ¢å¤ï¼Œæ”¶åˆ°äº†å‰é¢ç¬¬2æ­¥æ¥è‡ªå„ä¸ªRedisèŠ‚ç‚¹çš„è¯·æ±‚ç»“æœã€‚å®¢æˆ·ç«¯1è®¤ä¸ºè‡ªå·±æˆåŠŸè·å–åˆ°äº†é”ã€‚
6. å®¢æˆ·ç«¯1å’Œå®¢æˆ·ç«¯2ç°åœ¨éƒ½è®¤ä¸ºè‡ªå·±æŒæœ‰äº†é”ã€‚

Martinç»™å‡ºçš„è¿™ä¸ªä¾‹å­å…¶å®æœ‰ç‚¹å°é—®é¢˜ã€‚åœ¨Redlockç®—æ³•ä¸­ï¼Œå®¢æˆ·ç«¯åœ¨å®Œæˆå‘å„ä¸ªRedisèŠ‚ç‚¹çš„è·å–é”çš„è¯·æ±‚ä¹‹åï¼Œä¼šè®¡ç®—è¿™ä¸ªè¿‡ç¨‹æ¶ˆè€—çš„æ—¶é—´ï¼Œç„¶åæ£€æŸ¥æ˜¯ä¸æ˜¯è¶…è¿‡äº†é”çš„æœ‰æ•ˆæ—¶é—´(lock validity time)ã€‚ä¹Ÿå°±æ˜¯ä¸Šé¢çš„ä¾‹å­ä¸­ç¬¬5æ­¥ï¼Œå®¢æˆ·ç«¯1ä»GC  pauseä¸­æ¢å¤è¿‡æ¥ä»¥åï¼Œå®ƒä¼šé€šè¿‡è¿™ä¸ªæ£€æŸ¥å‘ç°é”å·²ç»è¿‡æœŸäº†ï¼Œä¸ä¼šå†è®¤ä¸ºè‡ªå·±æˆåŠŸè·å–åˆ°é”äº†ã€‚éšåantirezåœ¨ä»–çš„åé©³æ–‡ç« ä¸­å°±æŒ‡å‡ºæ¥äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†Martinè®¤ä¸ºè¿™ä¸ªç»†èŠ‚å¯¹Redlockæ•´ä½“çš„å®‰å…¨æ€§æ²¡æœ‰æœ¬è´¨çš„å½±å“ã€‚

æŠ›å¼€è¿™ä¸ªç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æä¸€ä¸‹Martinä¸¾è¿™ä¸ªä¾‹å­çš„æ„å›¾åœ¨å“ªã€‚åˆçœ‹èµ·æ¥ï¼Œè¿™ä¸ªä¾‹å­è·Ÿæ–‡ç« å‰åŠéƒ¨åˆ†åˆ†æé€šç”¨çš„åˆ†å¸ƒå¼é”æ—¶ç»™å‡ºçš„GC pauseçš„æ—¶åºå›¾æ˜¯åŸºæœ¬ä¸€æ ·çš„ï¼Œåªä¸è¿‡é‚£é‡Œçš„GC pauseå‘ç”Ÿåœ¨å®¢æˆ·ç«¯1è·å¾—äº†é”ä¹‹åï¼Œè€Œè¿™é‡Œçš„GC  pauseå‘ç”Ÿåœ¨å®¢æˆ·ç«¯1è·å¾—é”ä¹‹å‰ã€‚ä½†ä¸¤ä¸ªä¾‹å­çš„ä¾§é‡ç‚¹ä¸å¤ªä¸€æ ·ã€‚Martinæ„é€ è¿™é‡Œçš„è¿™ä¸ªä¾‹å­ï¼Œæ˜¯ä¸ºäº†å¼ºè°ƒåœ¨ä¸€ä¸ªåˆ†å¸ƒå¼çš„å¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œé•¿æ—¶é—´çš„GC pauseæˆ–æ¶ˆæ¯å»¶è¿Ÿï¼ˆä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼ŒæŠŠGC  pauseæ¢æˆRedisèŠ‚ç‚¹å’Œå®¢æˆ·ç«¯1ä¹‹é—´çš„æ¶ˆæ¯å»¶è¿Ÿï¼Œé€»è¾‘ä¸å˜ï¼‰ï¼Œä¼šè®©å®¢æˆ·ç«¯è·å¾—ä¸€ä¸ªå·²ç»è¿‡æœŸçš„é”ã€‚ä»å®¢æˆ·ç«¯1çš„è§’åº¦çœ‹ï¼ŒRedlockçš„å®‰å…¨æ€§è¢«æ‰“ç ´äº†ï¼Œå› ä¸ºå®¢æˆ·ç«¯1æ”¶åˆ°é”çš„æ—¶å€™ï¼Œè¿™ä¸ªé”å·²ç»å¤±æ•ˆäº†ï¼Œè€ŒRedlockåŒæ—¶è¿˜æŠŠè¿™ä¸ªé”åˆ†é…ç»™äº†å®¢æˆ·ç«¯2ã€‚æ¢å¥è¯è¯´ï¼ŒRedisæœåŠ¡å™¨åœ¨æŠŠé”åˆ†å‘ç»™å®¢æˆ·ç«¯çš„é€”ä¸­ï¼Œé”å°±è¿‡æœŸäº†ï¼Œä½†åˆæ²¡æœ‰æœ‰æ•ˆçš„æœºåˆ¶è®©å®¢æˆ·ç«¯æ˜ç¡®çŸ¥é“è¿™ä¸ªé—®é¢˜ã€‚è€Œåœ¨ä¹‹å‰çš„é‚£ä¸ªä¾‹å­ä¸­ï¼Œå®¢æˆ·ç«¯1æ”¶åˆ°é”çš„æ—¶å€™é”è¿˜æ˜¯æœ‰æ•ˆçš„ï¼Œé”æœåŠ¡æœ¬èº«çš„å®‰å…¨æ€§å¯ä»¥è®¤ä¸ºæ²¡æœ‰è¢«æ‰“ç ´ï¼Œåé¢è™½ç„¶ä¹Ÿå‡ºäº†é—®é¢˜ï¼Œä½†é—®é¢˜æ˜¯å‡ºåœ¨å®¢æˆ·ç«¯1å’Œå…±äº«èµ„æºæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’ä¸Šã€‚

åœ¨Martinçš„è¿™ç¯‡æ–‡ç« ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆæœ‰è§åœ°çš„è§‚ç‚¹ï¼Œå°±æ˜¯å¯¹é”çš„ç”¨é€”çš„åŒºåˆ†ã€‚ä»–æŠŠé”çš„ç”¨é€”åˆ†ä¸ºä¸¤ç§ï¼š

- ä¸ºäº†æ•ˆç‡(efficiency)ï¼Œåè°ƒå„ä¸ªå®¢æˆ·ç«¯é¿å…åšé‡å¤çš„å·¥ä½œã€‚å³ä½¿é”å¶å°”å¤±æ•ˆäº†ï¼Œåªæ˜¯å¯èƒ½æŠŠæŸäº›æ“ä½œå¤šåšä¸€éè€Œå·²ï¼Œä¸ä¼šäº§ç”Ÿå…¶å®ƒçš„ä¸è‰¯åæœã€‚æ¯”å¦‚é‡å¤å‘é€äº†ä¸€å°åŒæ ·çš„emailã€‚
- ä¸ºäº†æ­£ç¡®æ€§(correctness)ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å…è®¸é”å¤±æ•ˆçš„æƒ…å†µå‘ç”Ÿï¼Œå› ä¸ºä¸€æ—¦å‘ç”Ÿï¼Œå°±å¯èƒ½æ„å‘³ç€æ•°æ®ä¸ä¸€è‡´(inconsistency)ï¼Œæ•°æ®ä¸¢å¤±ï¼Œæ–‡ä»¶æŸåï¼Œæˆ–è€…å…¶å®ƒä¸¥é‡çš„é—®é¢˜ã€‚

æœ€åï¼ŒMartinå¾—å‡ºäº†å¦‚ä¸‹çš„ç»“è®ºï¼š

- å¦‚æœæ˜¯ä¸ºäº†æ•ˆç‡(efficiency)è€Œä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œå…è®¸é”çš„å¶å°”å¤±æ•ˆï¼Œé‚£ä¹ˆä½¿ç”¨å•RedisèŠ‚ç‚¹çš„é”æ–¹æ¡ˆå°±è¶³å¤Ÿäº†ï¼Œç®€å•è€Œä¸”æ•ˆç‡é«˜ã€‚Redlockåˆ™æ˜¯ä¸ªè¿‡é‡çš„å®ç°(heavyweight)ã€‚
- å¦‚æœæ˜¯ä¸ºäº†æ­£ç¡®æ€§(correctness)åœ¨å¾ˆä¸¥è‚ƒçš„åœºåˆä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œé‚£ä¹ˆä¸è¦ä½¿ç”¨Redlockã€‚å®ƒä¸æ˜¯å»ºç«‹åœ¨å¼‚æ­¥æ¨¡å‹ä¸Šçš„ä¸€ä¸ªè¶³å¤Ÿå¼ºçš„ç®—æ³•ï¼Œå®ƒå¯¹äºç³»ç»Ÿæ¨¡å‹çš„å‡è®¾ä¸­åŒ…å«å¾ˆå¤šå±é™©çš„æˆåˆ†(å¯¹äºtiming)ã€‚è€Œä¸”ï¼Œå®ƒæ²¡æœ‰ä¸€ä¸ªæœºåˆ¶èƒ½å¤Ÿæä¾›fencing tokenã€‚é‚£åº”è¯¥ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯å‘¢ï¼ŸMartinè®¤ä¸ºï¼Œåº”è¯¥è€ƒè™‘ç±»ä¼¼Zookeeperçš„æ–¹æ¡ˆï¼Œæˆ–è€…æ”¯æŒäº‹åŠ¡çš„æ•°æ®åº“ã€‚

Martinå¯¹Redlockç®—æ³•çš„å½¢å®¹æ˜¯ï¼š

> neither fish nor fowl ï¼ˆéé©´éé©¬ï¼‰

ã€***å…¶å®ƒç–‘é—®\***ã€‘

- Martinæå‡ºçš„fencing tokençš„æ–¹æ¡ˆï¼Œéœ€è¦å¯¹æä¾›å…±äº«èµ„æºçš„æœåŠ¡è¿›è¡Œä¿®æ”¹ï¼Œè¿™åœ¨ç°å®ä¸­å¯è¡Œå—ï¼Ÿ
- æ ¹æ®Martinçš„è¯´æ³•ï¼Œçœ‹èµ·æ¥ï¼Œå¦‚æœèµ„æºæœåŠ¡å™¨å®ç°äº†fencing tokenï¼Œå®ƒåœ¨åˆ†å¸ƒå¼é”å¤±æ•ˆçš„æƒ…å†µä¸‹ä¹Ÿä»ç„¶èƒ½ä¿æŒèµ„æºçš„äº’æ–¥è®¿é—®ã€‚è¿™æ˜¯ä¸æ˜¯æ„å‘³ç€åˆ†å¸ƒå¼é”æ ¹æœ¬æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰äº†ï¼Ÿ
- èµ„æºæœåŠ¡å™¨éœ€è¦æ£€æŸ¥fencing tokençš„å¤§å°ï¼Œå¦‚æœæä¾›èµ„æºè®¿é—®çš„æœåŠ¡ä¹Ÿæ˜¯åŒ…å«å¤šä¸ªèŠ‚ç‚¹çš„ï¼ˆåˆ†å¸ƒå¼çš„ï¼‰ï¼Œé‚£ä¹ˆè¿™é‡Œæ€ä¹ˆæ£€æŸ¥æ‰èƒ½ä¿è¯fencing tokenåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šæ˜¯é€’å¢çš„å‘¢ï¼Ÿ
- Martinå¯¹äºfencing tokençš„ä¸¾ä¾‹ä¸­ï¼Œä¸¤ä¸ªfencing tokenåˆ°è¾¾èµ„æºæœåŠ¡å™¨çš„é¡ºåºé¢ å€’äº†ï¼ˆå°çš„fencing  tokenååˆ°äº†ï¼‰ï¼Œè¿™æ—¶èµ„æºæœåŠ¡å™¨æ£€æŸ¥å‡ºäº†è¿™ä¸€é—®é¢˜ã€‚å¦‚æœå®¢æˆ·ç«¯1å’Œå®¢æˆ·ç«¯2éƒ½å‘ç”Ÿäº†GC pauseï¼Œä¸¤ä¸ªfencing  tokenéƒ½å»¶è¿Ÿäº†ï¼Œå®ƒä»¬å‡ ä¹åŒæ—¶è¾¾åˆ°äº†èµ„æºæœåŠ¡å™¨ï¼Œä½†ä¿æŒäº†é¡ºåºï¼Œé‚£ä¹ˆèµ„æºæœåŠ¡å™¨æ˜¯ä¸æ˜¯å°±æ£€æŸ¥ä¸å‡ºé—®é¢˜äº†ï¼Ÿè¿™æ—¶å¯¹äºèµ„æºçš„è®¿é—®æ˜¯ä¸æ˜¯å°±å‘ç”Ÿå†²çªäº†ï¼Ÿ
- åˆ†å¸ƒå¼é”+fencingçš„æ–¹æ¡ˆæ˜¯ç»å¯¹æ­£ç¡®çš„å—ï¼Ÿèƒ½è¯æ˜å—ï¼Ÿ

### antirezçš„åé©³





Martinåœ¨å‘è¡¨äº†é‚£ç¯‡åˆ†æåˆ†å¸ƒå¼é”çš„blog (How to do distributed locking)ä¹‹åï¼Œè¯¥æ–‡ç« åœ¨Twitterå’ŒHacker Newsä¸Šå¼•å‘äº†å¹¿æ³›çš„è®¨è®ºã€‚ä½†äººä»¬æ›´æƒ³å¬åˆ°çš„æ˜¯Redlockçš„ä½œè€…antirezå¯¹æ­¤ä¼šå‘è¡¨ä»€ä¹ˆæ ·çš„çœ‹æ³•ã€‚

Martinçš„é‚£ç¯‡æ–‡ç« æ˜¯åœ¨2016-02-08è¿™ä¸€å¤©å‘è¡¨çš„ï¼Œä½†æ®Martinè¯´ï¼Œä»–åœ¨å…¬å¼€å‘è¡¨æ–‡ç« çš„ä¸€æ˜ŸæœŸä¹‹å‰å°±æŠŠè‰ç¨¿å‘ç»™äº†antirezè¿›è¡Œreviewï¼Œè€Œä¸”ä»–ä»¬ä¹‹é—´é€šè¿‡emailè¿›è¡Œäº†è®¨è®ºã€‚ä¸çŸ¥é“Martinæœ‰æ²¡æœ‰æ„æ–™åˆ°ï¼Œantirezå¯¹äºæ­¤äº‹çš„ååº”å¾ˆå¿«ï¼Œå°±åœ¨Martinçš„æ–‡ç« å‘è¡¨å‡ºæ¥çš„ç¬¬äºŒå¤©ï¼Œantirezå°±åœ¨ä»–çš„åšå®¢ä¸Šè´´å‡ºäº†ä»–å¯¹äºæ­¤äº‹çš„åé©³æ–‡ç« ï¼Œåå­—å«"Is Redlock safe?"ï¼Œåœ°å€å¦‚ä¸‹:

- http://antirez.com/news/101

è¿™æ˜¯é«˜æ‰‹ä¹‹é—´çš„è¿‡æ‹›ã€‚antirezè¿™ç¯‡æ–‡ç« ä¹Ÿæ¡ä¾‹éå¸¸æ¸…æ™°ï¼Œå¹¶ä¸”ä¸­é—´æ¶‰åŠåˆ°å¤§é‡çš„ç»†èŠ‚ã€‚antirezè®¤ä¸ºï¼ŒMartinçš„æ–‡ç« å¯¹äºRedlockçš„æ‰¹è¯„å¯ä»¥æ¦‚æ‹¬ä¸ºä¸¤ä¸ªæ–¹é¢ï¼ˆä¸Martinæ–‡ç« çš„å‰åä¸¤éƒ¨åˆ†å¯¹åº”ï¼‰ï¼š

- å¸¦æœ‰è‡ªåŠ¨è¿‡æœŸåŠŸèƒ½çš„åˆ†å¸ƒå¼é”ï¼Œå¿…é¡»æä¾›æŸç§fencingæœºåˆ¶æ¥ä¿è¯å¯¹å…±äº«èµ„æºçš„çœŸæ­£çš„äº’æ–¥ä¿æŠ¤ã€‚Redlockæä¾›ä¸äº†è¿™æ ·ä¸€ç§æœºåˆ¶ã€‚
- Redlockæ„å»ºåœ¨ä¸€ä¸ªä¸å¤Ÿå®‰å…¨çš„ç³»ç»Ÿæ¨¡å‹ä¹‹ä¸Šã€‚å®ƒå¯¹äºç³»ç»Ÿçš„è®°æ—¶å‡è®¾(timing assumption)æœ‰æ¯”è¾ƒå¼ºçš„è¦æ±‚ï¼Œè€Œè¿™äº›è¦æ±‚åœ¨ç°å®çš„ç³»ç»Ÿä¸­æ˜¯æ— æ³•ä¿è¯çš„ã€‚

antirezå¯¹è¿™ä¸¤æ–¹é¢åˆ†åˆ«è¿›è¡Œäº†åé©³ã€‚

é¦–å…ˆï¼Œå…³äºfencingæœºåˆ¶ã€‚antirezå¯¹äºMartinçš„è¿™ç§è®ºè¯æ–¹å¼æå‡ºäº†è´¨ç–‘ï¼šæ—¢ç„¶åœ¨é”å¤±æ•ˆçš„æƒ…å†µä¸‹å·²ç»å­˜åœ¨ä¸€ç§fencingæœºåˆ¶èƒ½ç»§ç»­ä¿æŒèµ„æºçš„äº’æ–¥è®¿é—®äº†ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨ä¸€ä¸ªåˆ†å¸ƒå¼é”å¹¶ä¸”è¿˜è¦æ±‚å®ƒæä¾›é‚£ä¹ˆå¼ºçš„å®‰å…¨æ€§ä¿è¯å‘¢ï¼Ÿå³ä½¿é€€ä¸€æ­¥è®²ï¼ŒRedlockè™½ç„¶æä¾›ä¸äº†Martinæ‰€è®²çš„é€’å¢çš„fencing tokenï¼Œä½†åˆ©ç”¨Redlockäº§ç”Ÿçš„éšæœºå­—ç¬¦ä¸²(`my_random_value`)å¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚è¿™ä¸ªéšæœºå­—ç¬¦ä¸²è™½ç„¶ä¸æ˜¯é€’å¢çš„ï¼Œä½†å´æ˜¯å”¯ä¸€çš„ï¼Œå¯ä»¥ç§°ä¹‹ä¸ºunique tokenã€‚antirezä¸¾äº†ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥å®ç°â€œCheck and Setâ€æ“ä½œï¼ŒåŸè¯æ˜¯ï¼š

> When starting to work with a shared resource, we set its state to â€œ`<token>`â€, then we operate the read-modify-write only if the token is still the same when we write.ï¼ˆè¯‘æ–‡ï¼šå½“å¼€å§‹å’Œå…±äº«èµ„æºäº¤äº’çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†å®ƒçš„çŠ¶æ€è®¾ç½®æˆâ€œ`<token>`â€ï¼Œç„¶åä»…åœ¨tokenæ²¡æ”¹å˜çš„æƒ…å†µä¸‹æˆ‘ä»¬æ‰æ‰§è¡Œâ€œè¯»å–-ä¿®æ”¹-å†™å›â€æ“ä½œã€‚ï¼‰

ç¬¬ä¸€éçœ‹åˆ°è¿™ä¸ªæè¿°çš„æ—¶å€™ï¼Œæˆ‘ä¸ªäººæ˜¯æ„Ÿè§‰æ²¡å¤ªçœ‹æ‡‚çš„ã€‚â€œCheck and Setâ€åº”è¯¥å°±æ˜¯æˆ‘ä»¬å¹³å¸¸å¬åˆ°è¿‡çš„CASæ“ä½œäº†ï¼Œä½†å®ƒå¦‚ä½•åœ¨è¿™ä¸ªåœºæ™¯ä¸‹å·¥ä½œï¼Œantirezå¹¶æ²¡æœ‰å±•å¼€è¯´ï¼ˆåœ¨åé¢è®²åˆ°Hacker Newsä¸Šçš„è®¨è®ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜ä¼šæåˆ°ï¼‰ã€‚

ç„¶åï¼Œantirezçš„åé©³å°±é›†ä¸­åœ¨ç¬¬äºŒä¸ªæ–¹é¢ä¸Šï¼šå…³äºç®—æ³•åœ¨è®°æ—¶(timing)æ–¹é¢çš„æ¨¡å‹å‡è®¾ã€‚åœ¨æˆ‘ä»¬å‰é¢åˆ†æMartinçš„æ–‡ç« æ—¶ä¹Ÿæåˆ°è¿‡ï¼ŒMartinè®¤ä¸ºRedlockä¼šå¤±æ•ˆçš„æƒ…å†µä¸»è¦æœ‰ä¸‰ç§ï¼š

- æ—¶é’Ÿå‘ç”Ÿè·³è·ƒã€‚
- é•¿æ—¶é—´çš„GC pauseã€‚
- é•¿æ—¶é—´çš„ç½‘ç»œå»¶è¿Ÿã€‚

antirezè‚¯å®šæ„è¯†åˆ°äº†è¿™ä¸‰ç§æƒ…å†µå¯¹Redlockæœ€è‡´å‘½çš„å…¶å®æ˜¯ç¬¬ä¸€ç‚¹ï¼šæ—¶é’Ÿå‘ç”Ÿè·³è·ƒã€‚è¿™ç§æƒ…å†µä¸€æ—¦å‘ç”Ÿï¼ŒRedlockæ˜¯æ²¡æ³•æ­£å¸¸å·¥ä½œçš„ã€‚è€Œå¯¹äºåä¸¤ç§æƒ…å†µæ¥è¯´ï¼ŒRedlockåœ¨å½“åˆè®¾è®¡çš„æ—¶å€™å·²ç»è€ƒè™‘åˆ°äº†ï¼Œå¯¹å®ƒä»¬å¼•èµ·çš„åæœæœ‰ä¸€å®šçš„å…ç–«åŠ›ã€‚æ‰€ä»¥ï¼Œantirezæ¥ä¸‹æ¥é›†ä¸­ç²¾åŠ›æ¥è¯´æ˜é€šè¿‡æ°å½“çš„è¿ç»´ï¼Œå®Œå…¨å¯ä»¥é¿å…æ—¶é’Ÿå‘ç”Ÿå¤§çš„è·³åŠ¨ï¼Œè€ŒRedlockå¯¹äºæ—¶é’Ÿçš„è¦æ±‚åœ¨ç°å®ç³»ç»Ÿä¸­æ˜¯å®Œå…¨å¯ä»¥æ»¡è¶³çš„ã€‚

Martinåœ¨æåˆ°æ—¶é’Ÿè·³è·ƒçš„æ—¶å€™ï¼Œä¸¾äº†ä¸¤ä¸ªå¯èƒ½é€ æˆæ—¶é’Ÿè·³è·ƒçš„å…·ä½“ä¾‹å­ï¼š

- ç³»ç»Ÿç®¡ç†å‘˜æ‰‹åŠ¨ä¿®æ”¹äº†æ—¶é’Ÿã€‚
- ä»NTPæœåŠ¡æ”¶åˆ°äº†ä¸€ä¸ªå¤§çš„æ—¶é’Ÿæ›´æ–°äº‹ä»¶ã€‚

antirezåé©³è¯´ï¼š

- æ‰‹åŠ¨ä¿®æ”¹æ—¶é’Ÿè¿™ç§äººä¸ºåŸå› ï¼Œä¸è¦é‚£ä¹ˆåšå°±æ˜¯äº†ã€‚å¦åˆ™çš„è¯ï¼Œå¦‚æœæœ‰äººæ‰‹åŠ¨ä¿®æ”¹Raftåè®®çš„æŒä¹…åŒ–æ—¥å¿—ï¼Œé‚£ä¹ˆå°±ç®—æ˜¯Raftåè®®å®ƒä¹Ÿæ²¡æ³•æ­£å¸¸å·¥ä½œäº†ã€‚
- ä½¿ç”¨ä¸€ä¸ªä¸ä¼šè¿›è¡Œâ€œè·³è·ƒâ€å¼è°ƒæ•´ç³»ç»Ÿæ—¶é’Ÿçš„ntpdç¨‹åºï¼ˆå¯èƒ½æ˜¯é€šè¿‡æ°å½“çš„é…ç½®ï¼‰ï¼Œå¯¹äºæ—¶é’Ÿçš„ä¿®æ”¹é€šè¿‡å¤šæ¬¡å¾®å°çš„è°ƒæ•´æ¥å®Œæˆã€‚

è€ŒRedlockå¯¹æ—¶é’Ÿçš„è¦æ±‚ï¼Œå¹¶ä¸éœ€è¦å®Œå…¨ç²¾ç¡®ï¼Œå®ƒåªéœ€è¦æ—¶é’Ÿå·®ä¸å¤šç²¾ç¡®å°±å¯ä»¥äº†ã€‚æ¯”å¦‚ï¼Œè¦è®°æ—¶5ç§’ï¼Œä½†å¯èƒ½å®é™…è®°äº†4.5ç§’ï¼Œç„¶ååˆè®°äº†5.5ç§’ï¼Œæœ‰ä¸€å®šçš„è¯¯å·®ã€‚ä¸è¿‡åªè¦è¯¯å·®ä¸è¶…è¿‡ä¸€å®šèŒƒå›´ï¼Œè¿™å¯¹Redlockä¸ä¼šäº§ç”Ÿå½±å“ã€‚antirezè®¤ä¸ºå‘¢ï¼Œåƒè¿™æ ·å¯¹æ—¶é’Ÿç²¾åº¦å¹¶ä¸æ˜¯å¾ˆé«˜çš„è¦æ±‚ï¼Œåœ¨å®é™…ç¯å¢ƒä¸­æ˜¯å®Œå…¨åˆç†çš„ã€‚

å¥½äº†ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œå¦‚æœä½ ç›¸ä¿¡antirezè¿™é‡Œå…³äºæ—¶é’Ÿçš„è®ºæ–­ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥antirezçš„åˆ†æå°±åŸºæœ¬ä¸Šé¡ºç†æˆç« äº†ã€‚

å…³äºMartinæåˆ°çš„èƒ½ä½¿Redlockå¤±æ•ˆçš„åä¸¤ç§æƒ…å†µï¼ŒMartinåœ¨åˆ†æçš„æ—¶å€™æ°å¥½çŠ¯äº†ä¸€ä¸ªé”™è¯¯ï¼ˆåœ¨[æœ¬æ–‡ä¸ŠåŠéƒ¨åˆ†](http://mp.weixin.qq.com/s?__biz=MzA4NTg1MjM0Mg==&mid=2657261514&idx=1&sn=47b1a63f065347943341910dddbb785d&chksm=84479e13b3301705ea29c86f457ad74010eba8a8a5c12a7f54bcf264a4a8c9d6adecbe32ad0b&scene=21#wechat_redirect)å·²ç»æåˆ°è¿‡ï¼‰ã€‚åœ¨Martinç»™å‡ºçš„é‚£ä¸ªç”±å®¢æˆ·ç«¯GC pauseå¼•å‘Redlockå¤±æ•ˆçš„ä¾‹å­ä¸­ï¼Œè¿™ä¸ªGC  pauseå¼•å‘çš„åæœç›¸å½“äºåœ¨é”æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´å‘ç”Ÿäº†é•¿æ—¶é—´çš„æ¶ˆæ¯å»¶è¿Ÿã€‚Redlockå¯¹äºè¿™ä¸ªæƒ…å†µæ˜¯èƒ½å¤„ç†çš„ã€‚å›æƒ³ä¸€ä¸‹Redlockç®—æ³•çš„å…·ä½“è¿‡ç¨‹ï¼Œå®ƒä½¿ç”¨èµ·æ¥çš„è¿‡ç¨‹å¤§ä½“å¯ä»¥åˆ†æˆ5æ­¥ï¼š

1. è·å–å½“å‰æ—¶é—´ã€‚
2. å®Œæˆ**è·å–é”**çš„æ•´ä¸ªè¿‡ç¨‹ï¼ˆä¸Nä¸ªRedisèŠ‚ç‚¹äº¤äº’ï¼‰ã€‚
3. å†æ¬¡è·å–å½“å‰æ—¶é—´ã€‚
4. æŠŠä¸¤ä¸ªæ—¶é—´ç›¸å‡ï¼Œè®¡ç®—**è·å–é”**çš„è¿‡ç¨‹æ˜¯å¦æ¶ˆè€—äº†å¤ªé•¿æ—¶é—´ï¼Œå¯¼è‡´é”å·²ç»è¿‡æœŸäº†ã€‚å¦‚æœæ²¡è¿‡æœŸï¼Œ
5. å®¢æˆ·ç«¯æŒæœ‰é”å»è®¿é—®å…±äº«èµ„æºã€‚

åœ¨Martinä¸¾çš„ä¾‹å­ä¸­ï¼ŒGC  pauseæˆ–ç½‘ç»œå»¶è¿Ÿï¼Œå®é™…å‘ç”Ÿåœ¨ä¸Šè¿°ç¬¬1æ­¥å’Œç¬¬3æ­¥ä¹‹é—´ã€‚è€Œä¸ç®¡åœ¨ç¬¬1æ­¥å’Œç¬¬3æ­¥ä¹‹é—´ç”±äºä»€ä¹ˆåŸå› ï¼ˆè¿›ç¨‹åœé¡¿æˆ–ç½‘ç»œå»¶è¿Ÿç­‰ï¼‰å¯¼è‡´äº†å¤§çš„å»¶è¿Ÿå‡ºç°ï¼Œåœ¨ç¬¬4æ­¥éƒ½èƒ½è¢«æ£€æŸ¥å‡ºæ¥ï¼Œä¸ä¼šè®©å®¢æˆ·ç«¯æ‹¿åˆ°ä¸€ä¸ªå®ƒè®¤ä¸ºæœ‰æ•ˆè€Œå®é™…å´å·²ç»è¿‡æœŸçš„é”ã€‚å½“ç„¶ï¼Œè¿™ä¸ªæ£€æŸ¥ä¾èµ–ç³»ç»Ÿæ—¶é’Ÿæ²¡æœ‰å¤§çš„è·³è·ƒã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆantirezåœ¨å‰é¢è¦å¯¹æ—¶é’Ÿæ¡ä»¶è¿›è¡Œè¾©æŠ¤çš„åŸå› ã€‚

æœ‰äººä¼šè¯´ï¼Œåœ¨ç¬¬3æ­¥ä¹‹åï¼Œä»ç„¶å¯èƒ½ä¼šå‘ç”Ÿå»¶è¿Ÿå•Šã€‚æ²¡é”™ï¼Œantirezæ‰¿è®¤è¿™ä¸€ç‚¹ï¼Œä»–å¯¹æ­¤æœ‰ä¸€æ®µå¾ˆæœ‰æ„æ€çš„è®ºè¯ï¼ŒåŸè¯å¦‚ä¸‹ï¼š

> The delay can only happen after steps 3, resulting into the lock to be  considered ok while actually expired, that is, we are back at the first  problem Martin identified of distributed locks where the client fails to stop working to the shared resource before the lock validity expires.  Let me tell again how this problem is common with *all the distributed locks implementations*, and how the token as a solution is both unrealistic and can be used with Redlock as well.ï¼ˆè¯‘æ–‡ï¼šå»¶è¿Ÿåªèƒ½å‘ç”Ÿåœ¨ç¬¬3æ­¥ä¹‹åï¼Œè¿™å¯¼è‡´é”è¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„è€Œå®é™…ä¸Šå·²ç»è¿‡æœŸäº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å›åˆ°äº†MartinæŒ‡å‡ºçš„ç¬¬ä¸€ä¸ªé—®é¢˜ä¸Šï¼Œå®¢æˆ·ç«¯æ²¡èƒ½å¤Ÿåœ¨é”çš„æœ‰æ•ˆæ€§è¿‡æœŸä¹‹å‰å®Œæˆä¸å…±äº«èµ„æºçš„äº¤äº’ã€‚è®©æˆ‘å†æ¬¡ç”³æ˜ä¸€ä¸‹ï¼Œè¿™ä¸ªé—®é¢˜å¯¹äº*æ‰€æœ‰çš„åˆ†å¸ƒå¼é”çš„å®ç°*æ˜¯æ™®éå­˜åœ¨çš„ï¼Œè€Œä¸”åŸºäºtokençš„è¿™ç§è§£å†³æ–¹æ¡ˆæ˜¯ä¸åˆ‡å®é™…çš„ï¼Œä½†ä¹Ÿèƒ½å’ŒRedlockä¸€èµ·ç”¨ã€‚ï¼‰

è¿™é‡Œantirezæ‰€è¯´çš„â€œMartinæŒ‡å‡ºçš„ç¬¬ä¸€ä¸ªé—®é¢˜â€å…·ä½“æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåœ¨[æœ¬æ–‡ä¸ŠåŠéƒ¨åˆ†](http://mp.weixin.qq.com/s?__biz=MzA4NTg1MjM0Mg==&mid=2657261514&idx=1&sn=47b1a63f065347943341910dddbb785d&chksm=84479e13b3301705ea29c86f457ad74010eba8a8a5c12a7f54bcf264a4a8c9d6adecbe32ad0b&scene=21#wechat_redirect)æˆ‘ä»¬æåˆ°è¿‡ï¼ŒMartinçš„æ–‡ç« åˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼Œå…¶ä¸­å‰åŠéƒ¨åˆ†ä¸Redlockæ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œè€Œæ˜¯æŒ‡å‡ºäº†ä»»ä½•ä¸€ç§å¸¦è‡ªåŠ¨è¿‡æœŸåŠŸèƒ½çš„åˆ†å¸ƒå¼é”åœ¨æ²¡æœ‰æä¾›fencingæœºåˆ¶çš„å‰æä¸‹éƒ½æœ‰å¯èƒ½å¤±æ•ˆã€‚è¿™é‡Œantirezæ‰€è¯´çš„å°±æ˜¯æŒ‡çš„Martinçš„æ–‡ç« çš„å‰åŠéƒ¨åˆ†ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºå¤§å»¶è¿Ÿç»™Redlockå¸¦æ¥çš„å½±å“ï¼Œæ°å¥½ä¸Martinåœ¨æ–‡ç« çš„å‰åŠéƒ¨åˆ†é’ˆå¯¹æ‰€æœ‰çš„åˆ†å¸ƒå¼é”æ‰€åšçš„åˆ†ææ˜¯ä¸€è‡´çš„ï¼Œè€Œè¿™ç§å½±å“ä¸å•å•é’ˆå¯¹Redlockã€‚Redlockçš„å®ç°å·²ç»ä¿è¯äº†å®ƒæ˜¯å’Œå…¶å®ƒä»»ä½•åˆ†å¸ƒå¼é”çš„å®‰å…¨æ€§æ˜¯ä¸€æ ·çš„ã€‚å½“ç„¶ï¼Œä¸å…¶å®ƒâ€œæ›´å®Œç¾â€çš„åˆ†å¸ƒå¼é”ç›¸æ¯”ï¼ŒRedlockä¼¼ä¹æä¾›ä¸äº†Martinæå‡ºçš„é‚£ç§é€’å¢çš„tokenï¼Œä½†antirezåœ¨å‰é¢å·²ç»åˆ†æè¿‡äº†ï¼Œå…³äºtokençš„è¿™ç§è®ºè¯æ–¹å¼æœ¬èº«å°±æ˜¯â€œä¸åˆ‡å®é™…â€çš„ï¼Œæˆ–è€…é€€ä¸€æ­¥è®²ï¼ŒRedlockèƒ½æä¾›çš„unique tokenä¹Ÿèƒ½å¤Ÿæä¾›å®Œå…¨ä¸€æ ·çš„æ•ˆæœã€‚

å¦å¤–ï¼Œå…³äºå¤§å»¶è¿Ÿå¯¹Redlockçš„å½±å“ï¼Œantirezå’ŒMartinåœ¨Twitterä¸Šæœ‰ä¸‹é¢çš„å¯¹è¯ï¼š

> **antirez**:@martinkl so I wonder if after my reply, we can at least agree about unbound messages delay to donâ€™t cause any harm.
>
> **Martin**:@antirez Agree about message delay between app and lock server. Delay between  app and resource being accessed is still problematic.
>
> ï¼ˆè¯‘æ–‡ï¼š**antirez**é—®ï¼šæˆ‘æƒ³çŸ¥é“ï¼Œåœ¨æˆ‘å‘æ–‡å›å¤ä¹‹åï¼Œæˆ‘ä»¬èƒ½å¦åœ¨ä¸€ç‚¹ä¸Šè¾¾æˆä¸€è‡´ï¼Œå°±æ˜¯å¤§çš„æ¶ˆæ¯å»¶è¿Ÿä¸ä¼šç»™Redlockçš„è¿è¡Œé€ æˆæŸå®³ã€‚**Martin**ç­”ï¼šå¯¹äºå®¢æˆ·ç«¯å’Œé”æœåŠ¡å™¨ä¹‹é—´çš„æ¶ˆæ¯å»¶è¿Ÿï¼Œæˆ‘åŒæ„ä½ çš„è§‚ç‚¹ã€‚ä½†å®¢æˆ·ç«¯å’Œè¢«è®¿é—®èµ„æºä¹‹é—´çš„å»¶è¿Ÿè¿˜æ˜¯æœ‰é—®é¢˜çš„ã€‚ï¼‰

é€šè¿‡è¿™æ®µå¯¹è¯å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºRedlockåœ¨ç¬¬4æ­¥æ‰€åšçš„é”æœ‰æ•ˆæ€§çš„æ£€æŸ¥ï¼ŒMartinæ˜¯äºˆä»¥è‚¯å®šçš„ã€‚ä½†ä»–è®¤ä¸ºå®¢æˆ·ç«¯å’Œèµ„æºæœåŠ¡å™¨ä¹‹é—´çš„å»¶è¿Ÿè¿˜æ˜¯ä¼šå¸¦æ¥é—®é¢˜çš„ã€‚Martinåœ¨è¿™é‡Œè¯´çš„æœ‰ç‚¹æ¨¡ç³Šã€‚å°±åƒantirezå‰é¢åˆ†æçš„ï¼Œå®¢æˆ·ç«¯å’Œèµ„æºæœåŠ¡å™¨ä¹‹é—´çš„å»¶è¿Ÿï¼Œå¯¹æ‰€æœ‰çš„åˆ†å¸ƒå¼é”çš„å®ç°éƒ½ä¼šå¸¦æ¥å½±å“ï¼Œè¿™ä¸å•å•æ˜¯Redlockçš„é—®é¢˜äº†ã€‚

ä»¥ä¸Šå°±æ˜¯antirezåœ¨blogä¸­æ‰€è¯´çš„ä¸»è¦å†…å®¹ã€‚æœ‰ä¸€äº›ç‚¹å€¼å¾—æˆ‘ä»¬æ³¨æ„ä¸€ä¸‹ï¼š

- antirezæ˜¯åŒæ„å¤§çš„ç³»ç»Ÿæ—¶é’Ÿè·³è·ƒä¼šé€ æˆRedlockå¤±æ•ˆçš„ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä»–ä¸Martinçš„è§‚ç‚¹çš„ä¸åŒåœ¨äºï¼Œä»–è®¤ä¸ºåœ¨å®é™…ç³»ç»Ÿä¸­æ˜¯å¯ä»¥é¿å…å¤§çš„æ—¶é’Ÿè·³è·ƒçš„ã€‚å½“ç„¶ï¼Œè¿™å–å†³äºåŸºç¡€è®¾æ–½å’Œè¿ç»´æ–¹å¼ã€‚
- antirezåœ¨è®¾è®¡Redlockçš„æ—¶å€™ï¼Œæ˜¯å……åˆ†è€ƒè™‘äº†ç½‘ç»œå»¶è¿Ÿå’Œç¨‹åºåœé¡¿æ‰€å¸¦æ¥çš„å½±å“çš„ã€‚ä½†æ˜¯ï¼Œå¯¹äºå®¢æˆ·ç«¯å’Œèµ„æºæœåŠ¡å™¨ä¹‹é—´çš„å»¶è¿Ÿï¼ˆå³å‘ç”Ÿåœ¨ç®—æ³•ç¬¬3æ­¥ä¹‹åçš„å»¶è¿Ÿï¼‰ï¼Œantirezæ˜¯æ‰¿è®¤æ‰€æœ‰çš„åˆ†å¸ƒå¼é”çš„å®ç°ï¼ŒåŒ…æ‹¬Redlockï¼Œæ˜¯æ²¡æœ‰ä»€ä¹ˆå¥½åŠæ³•æ¥åº”å¯¹çš„ã€‚

è®¨è®ºè¿›è¡Œåˆ°è¿™ï¼ŒMartinå’Œantirezä¹‹é—´è°å¯¹è°é”™å…¶å®å¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦äº†ã€‚åªè¦æˆ‘ä»¬èƒ½å¤Ÿå¯¹Redlockï¼ˆæˆ–è€…å…¶å®ƒåˆ†å¸ƒå¼é”ï¼‰æ‰€èƒ½æä¾›çš„å®‰å…¨æ€§çš„ç¨‹åº¦æœ‰å……åˆ†çš„äº†è§£ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½åšå‡ºè‡ªå·±çš„é€‰æ‹©äº†ã€‚



### Hacker Newsä¸Šçš„ä¸€äº›è®¨è®º





é’ˆå¯¹Martinå’Œantirezçš„ä¸¤ç¯‡blogï¼Œå¾ˆå¤šæŠ€æœ¯äººå‘˜åœ¨Hacker Newsä¸Šå±•å¼€äº†æ¿€çƒˆçš„è®¨è®ºã€‚è¿™äº›è®¨è®ºæ‰€åœ¨åœ°å€å¦‚ä¸‹ï¼š

- é’ˆå¯¹Martinçš„blogçš„è®¨è®ºï¼šhttps://news.ycombinator.com/item?id=11059738
- é’ˆå¯¹antirezçš„blogçš„è®¨è®ºï¼šhttps://news.ycombinator.com/item?id=11065933

åœ¨Hacker Newsä¸Šï¼Œantirezç§¯æå‚ä¸äº†è®¨è®ºï¼Œè€ŒMartinåˆ™å§‹ç»ˆç½®èº«äº‹å¤–ã€‚

ä¸‹é¢æˆ‘æŠŠè¿™äº›è®¨è®ºä¸­ä¸€äº›æœ‰æ„æ€çš„ç‚¹æ‹¿å‡ºæ¥ä¸å¤§å®¶ä¸€èµ·åˆ†äº«ä¸€ä¸‹ï¼ˆé›†ä¸­åœ¨å¯¹äºfencing tokenæœºåˆ¶çš„è®¨è®ºä¸Šï¼‰ã€‚

å…³äºantirezæå‡ºçš„â€œCheck and Setâ€æ“ä½œï¼Œä»–åœ¨blogé‡Œå¹¶æ²¡æœ‰è¯¦åŠ è¯´æ˜ã€‚æœç„¶ï¼Œåœ¨Hacker Newsä¸Šå°±æœ‰äººå‡ºæ¥é—®äº†ã€‚antirezç»™å‡ºçš„ç­”å¤å¦‚ä¸‹ï¼š

> You want to modify locked resource X. You set X.currlock = token. Then you  read, do whatever you want, and when you write, you "write-if-currlock  == token". If another client did X.currlock = somethingelse, the  transaction fails.

ç¿»è¯‘ä¸€ä¸‹å¯ä»¥è¿™æ ·ç†è§£ï¼šå‡è®¾ä½ è¦ä¿®æ”¹èµ„æºXï¼Œé‚£ä¹ˆéµå¾ªä¸‹é¢çš„ä¼ªç æ‰€å®šä¹‰çš„æ­¥éª¤ã€‚

1. å…ˆè®¾ç½®X.currlock = tokenã€‚
2. è¯»å‡ºèµ„æºXï¼ˆåŒ…æ‹¬å®ƒçš„å€¼å’Œé™„å¸¦çš„X.currlockï¼‰ã€‚
3. æŒ‰ç…§"write-if-currlock ==  token"çš„é€»è¾‘ï¼Œä¿®æ”¹èµ„æºXçš„å€¼ã€‚æ„æ€æ˜¯è¯´ï¼Œå¦‚æœå¯¹Xè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼ŒX.currlockä»ç„¶å’Œå½“åˆè®¾ç½®è¿›å»çš„tokenç›¸ç­‰ï¼Œé‚£ä¹ˆæ‰è¿›è¡Œä¿®æ”¹ï¼›å¦‚æœè¿™æ—¶X.currlockå·²ç»æ˜¯å…¶å®ƒå€¼äº†ï¼Œé‚£ä¹ˆè¯´æ˜æœ‰å¦å¤–ä¸€æ–¹ä¹Ÿåœ¨è¯•å›¾è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œé‚£ä¹ˆæ”¾å¼ƒå½“å‰çš„ä¿®æ”¹ï¼Œä»è€Œé¿å…å†²çªã€‚

éšåHacker Newsä¸Šä¸€ä½å«viraptorçš„ç”¨æˆ·æå‡ºäº†å¼‚è®®ï¼Œå®ƒç»™å‡ºäº†è¿™æ ·ä¸€ä¸ªæ‰§è¡Œåºåˆ—ï¼š

- A: X.currlock = Token_ID_A
- A: resource read
- A: is X.currlock still Token_ID_A? yes
- B: X.currlock = Token_ID_B
- B: resource read
- B: is X.currlock still Token_ID_B? yes
- B: resource write
- A: resource write

åˆ°äº†æœ€åä¸¤æ­¥ï¼Œä¸¤ä¸ªå®¢æˆ·ç«¯Aå’ŒBåŒæ—¶è¿›è¡Œå†™æ“ä½œï¼Œå†²çªäº†ã€‚ä¸è¿‡ï¼Œè¿™ä½ç”¨æˆ·åº”è¯¥æ˜¯ç†è§£é”™äº†antirezç»™å‡ºçš„ä¿®æ”¹è¿‡ç¨‹äº†ã€‚æŒ‰ç…§antirezçš„æ„æ€ï¼Œåˆ¤æ–­X.currlockæ˜¯å¦ä¿®æ”¹è¿‡å’Œå¯¹èµ„æºçš„å†™æ“ä½œï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚åªæœ‰è¿™æ ·ç†è§£æ‰èƒ½åˆä¹é€»è¾‘ï¼Œå¦åˆ™çš„è¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æœ‰ä¸¥é‡çš„ç ´ç»½ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆantirezä¹‹å‰ä¼šå¯¹fencingæœºåˆ¶äº§ç”Ÿè´¨ç–‘ï¼šæ—¢ç„¶èµ„æºæœåŠ¡å™¨æœ¬èº«éƒ½èƒ½æä¾›äº’æ–¥çš„åŸå­æ“ä½œäº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ä¸€ä¸ªåˆ†å¸ƒå¼é”å‘¢ï¼Ÿå› æ­¤ï¼Œantirezè®¤ä¸ºè¿™ç§fencingæœºåˆ¶æ˜¯å¾ˆç´¯èµ˜çš„ï¼Œä»–ä¹‹æ‰€ä»¥è¿˜æ˜¯æå‡ºäº†è¿™ç§â€œCheck and Setâ€æ“ä½œï¼Œåªæ˜¯ä¸ºäº†è¯æ˜åœ¨æä¾›fencing  tokenè¿™ä¸€ç‚¹ä¸Šï¼ŒRedlockä¹Ÿèƒ½åšåˆ°ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œä»ç„¶æœ‰ä¸€äº›ä¸æ˜ç¡®çš„åœ°æ–¹ï¼Œå¦‚æœå°†"write-if-currlock ==  token"çœ‹åšæ˜¯åŸå­æ“ä½œçš„è¯ï¼Œè¿™ä¸ªé€»è¾‘åŠ¿å¿…è¦åœ¨èµ„æºæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œé‚£ä¹ˆç¬¬äºŒæ­¥ä¸ºä»€ä¹ˆè¿˜è¦â€œè¯»å‡ºèµ„æºXâ€å‘¢ï¼Ÿé™¤éè¿™ä¸ªâ€œè¯»å‡ºèµ„æºXâ€çš„æ“ä½œä¹Ÿæ˜¯åœ¨èµ„æºæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œå®ƒåŒ…å«åœ¨â€œåˆ¤æ–­-å†™å›â€è¿™ä¸ªåŸå­æ“ä½œé‡Œé¢ã€‚è€Œå‡å¦‚ä¸è¿™æ ·ç†è§£çš„è¯ï¼Œâ€œè¯»å–-åˆ¤æ–­-å†™å›â€è¿™ä¸‰ä¸ªæ“ä½œéƒ½æ”¾åœ¨å®¢æˆ·ç«¯æ‰§è¡Œï¼Œé‚£ä¹ˆçœ‹ä¸å‡ºå®ƒä»¬å¦‚ä½•æ‰èƒ½å®ç°åŸå­æ€§æ“ä½œã€‚åœ¨ä¸‹é¢çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬æš‚æ—¶å¿½ç•¥â€œè¯»å‡ºèµ„æºXâ€è¿™ä¸€æ­¥ã€‚

è¿™ä¸ªåŸºäºrandom tokençš„â€œCheck and Setâ€æ“ä½œï¼Œå¦‚æœä¸Martinæå‡ºçš„é€’å¢çš„fencing tokenå¯¹æ¯”ä¸€ä¸‹çš„è¯ï¼Œè‡³å°‘æœ‰ä¸¤ç‚¹ä¸åŒï¼š

- â€œCheck and Setâ€å¯¹äºå†™æ“ä½œè¦åˆ†æˆä¸¤æ­¥æ¥å®Œæˆï¼ˆè®¾ç½®tokenã€åˆ¤æ–­-å†™å›ï¼‰ï¼Œè€Œé€’å¢çš„fencing tokenæœºåˆ¶åªéœ€è¦ä¸€æ­¥ï¼ˆå¸¦ç€tokenå‘èµ„æºæœåŠ¡å™¨å‘èµ·å†™è¯·æ±‚ï¼‰ã€‚
- é€’å¢çš„fencing tokenæœºåˆ¶èƒ½ä¿è¯æœ€ç»ˆæ“ä½œå…±äº«èµ„æºçš„é¡ºåºï¼Œé‚£äº›å»¶è¿Ÿæ—¶é—´å¤ªé•¿çš„æ“ä½œå°±æ— æ³•æ“ä½œå…±äº«èµ„æºäº†ã€‚ä½†æ˜¯åŸºäºrandom tokençš„â€œCheck and Setâ€æ“ä½œä¸ä¼šä¿è¯è¿™ä¸ªé¡ºåºï¼Œé‚£äº›å»¶è¿Ÿæ—¶é—´å¤ªé•¿çš„æ“ä½œå¦‚æœååˆ°è¾¾äº†ï¼Œå®ƒä»ç„¶æœ‰å¯èƒ½æ“ä½œå…±äº«èµ„æºï¼ˆå½“ç„¶æ˜¯ä»¥äº’æ–¥çš„æ–¹å¼ï¼‰ã€‚

å¯¹äºå‰ä¸€ç‚¹ä¸åŒï¼Œæˆ‘ä»¬åœ¨åé¢çš„åˆ†æä¸­ä¼šçœ‹åˆ°ï¼Œå¦‚æœèµ„æºæœåŠ¡å™¨ä¹Ÿæ˜¯åˆ†å¸ƒå¼çš„ï¼Œé‚£ä¹ˆä½¿ç”¨é€’å¢çš„fencing tokenä¹Ÿè¦å˜æˆä¸¤æ­¥ã€‚

è€Œå¯¹äºåä¸€ç‚¹æ“ä½œé¡ºåºä¸Šçš„ä¸åŒï¼Œantirezè®¤ä¸ºè¿™ä¸ªé¡ºåºæ²¡æœ‰æ„ä¹‰ï¼Œå…³é”®æ˜¯èƒ½äº’æ–¥è®¿é—®å°±è¡Œäº†ã€‚ä»–å†™ä¸‹äº†ä¸‹é¢çš„è¯ï¼š

> So the goal is, when race conditions happen, to avoid them in some way.......Note also that when it happens that, because of delays, the clients are  accessing concurrently, the lock ID has little to do with the order in  which the operations were indented to happen.ï¼ˆè¯‘æ–‡ï¼š æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼Œå½“ç«äº‰æ¡ä»¶å‡ºç°çš„æ—¶å€™ï¼Œèƒ½å¤Ÿä»¥**æŸç§æ–¹å¼**é¿å…ã€‚......è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é‚£ç§ç«äº‰æ¡ä»¶å‡ºç°çš„æ—¶å€™ï¼Œæ¯”å¦‚ç”±äºå»¶è¿Ÿï¼Œå®¢æˆ·ç«¯æ˜¯åŒæ—¶æ¥è®¿é—®çš„ï¼Œé”çš„IDçš„å¤§å°é¡ºåºè·Ÿé‚£äº›æ“ä½œçœŸæ­£æƒ³æ‰§è¡Œçš„é¡ºåºï¼Œæ˜¯æ²¡æœ‰ä»€ä¹ˆå…³ç³»çš„ã€‚ï¼‰

è¿™é‡Œçš„lock IDï¼Œè·ŸMartinè¯´çš„é€’å¢çš„tokenæ˜¯ä¸€å›äº‹ã€‚

éšåï¼Œantirezä¸¾äº†ä¸€ä¸ªâ€œå°†åå­—åŠ å…¥åˆ—è¡¨â€çš„æ“ä½œçš„ä¾‹å­ï¼š

- T0: Client A receives new name to add from web.
- T0: Client B is idle
- T1: Client A is experiencing pauses.
- T1: Client B receives new name to add from web.
- T2: Client A is experiencing pauses.
- T2: Client B receives a lock with ID 1
- T3: Client A receives a lock with ID 2

ä½ çœ‹ï¼Œä¸¤ä¸ªå®¢æˆ·ç«¯ï¼ˆå…¶å®æ˜¯WebæœåŠ¡å™¨ï¼‰æ‰§è¡Œâ€œæ·»åŠ åå­—â€çš„æ“ä½œï¼ŒAæœ¬æ¥æ˜¯æ’åœ¨Bå‰é¢çš„ï¼Œä½†è·å¾—é”çš„é¡ºåºå´æ˜¯Bæ’åœ¨Aå‰é¢ã€‚å› æ­¤ï¼Œantirezè¯´ï¼Œé”çš„IDçš„å¤§å°é¡ºåºè·Ÿé‚£äº›æ“ä½œçœŸæ­£æƒ³æ‰§è¡Œçš„é¡ºåºï¼Œæ˜¯æ²¡æœ‰ä»€ä¹ˆå…³ç³»çš„ã€‚å…³é”®æ˜¯èƒ½æ’å‡ºä¸€ä¸ªé¡ºåºæ¥ï¼Œèƒ½äº’æ–¥è®¿é—®å°±è¡Œäº†ã€‚é‚£ä¹ˆï¼Œè‡³äºé”çš„IDæ˜¯é€’å¢çš„ï¼Œè¿˜æ˜¯ä¸€ä¸ªrandom tokenï¼Œè‡ªç„¶å°±ä¸é‚£ä¹ˆé‡è¦äº†ã€‚

Martinæå‡ºçš„fencing  tokenæœºåˆ¶ï¼Œç»™äººç•™ä¸‹äº†æ— å°½çš„ç–‘æƒ‘ã€‚è¿™ä¸»è¦æ˜¯å› ä¸ºä»–å¯¹äºè¿™ä¸€æœºåˆ¶çš„æè¿°ç¼ºå°‘å¤ªå¤šçš„æŠ€æœ¯ç»†èŠ‚ã€‚ä»ä¸Šé¢çš„è®¨è®ºå¯ä»¥çœ‹å‡ºï¼Œantirezå¯¹äºè¿™ä¸€æœºåˆ¶çš„çœ‹æ³•æ˜¯ï¼Œå®ƒè·Ÿä¸€ä¸ªrandom tokenæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œè€Œä¸”ï¼Œå®ƒéœ€è¦èµ„æºæœåŠ¡å™¨æœ¬èº«æä¾›æŸç§äº’æ–¥æœºåˆ¶ï¼Œè¿™å‡ ä¹è®©åˆ†å¸ƒå¼é”æœ¬èº«çš„å­˜åœ¨å¤±å»äº†æ„ä¹‰ã€‚å›´ç»•fencing  tokençš„é—®é¢˜ï¼Œè¿˜æœ‰ä¸¤ç‚¹æ˜¯æ¯”è¾ƒå¼•äººæ³¨ç›®çš„ï¼ŒHacker Newsä¸Šä¹Ÿæœ‰äººæå‡ºäº†ç›¸å…³çš„ç–‘é—®ï¼š

- ï¼ˆ1ï¼‰å…³äºèµ„æºæœåŠ¡å™¨æœ¬èº«çš„æ¶æ„ç»†èŠ‚ã€‚
- ï¼ˆ2ï¼‰èµ„æºæœåŠ¡å™¨å¯¹äºfencing tokenè¿›è¡Œæ£€æŸ¥çš„å®ç°ç»†èŠ‚ï¼Œæ¯”å¦‚æ˜¯å¦éœ€è¦æä¾›ä¸€ç§åŸå­æ“ä½œã€‚

å…³äºä¸Šè¿°é—®é¢˜ï¼ˆ1ï¼‰ï¼ŒHacker Newsä¸Šæœ‰ä¸€ä½å«dwenzekçš„ç”¨æˆ·å‘è¡¨äº†ä¸‹é¢çš„è¯„è®ºï¼š

> ...... the issue around the usage of fencing tokens to reject any late usage  of a lock is unclear just because the protected resource and its access  are themselves unspecified. Is the resource distributed or not? If  distributed, does the resource has a mean to ensure that tokens are  increasing over all the nodes? Does the resource have a mean to rollback any effects done by a client which session is interrupted by a timeout?
>
> ï¼ˆè¯‘æ–‡ï¼š...... å…³äºä½¿ç”¨fencing  tokenæ‹’ç»æ‰å»¶è¿Ÿè¯·æ±‚çš„ç›¸å…³è®®é¢˜ï¼Œæ˜¯ä¸å¤Ÿæ¸…æ™°çš„ï¼Œå› ä¸ºå—ä¿æŠ¤çš„èµ„æºä»¥åŠå¯¹å®ƒçš„è®¿é—®æ–¹å¼æœ¬èº«æ˜¯æ²¡æœ‰è¢«æ˜ç¡®å®šä¹‰è¿‡çš„ã€‚èµ„æºæœåŠ¡æ˜¯ä¸æ˜¯åˆ†å¸ƒå¼çš„å‘¢ï¼Ÿå¦‚æœæ˜¯ï¼Œèµ„æºæœåŠ¡æœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼èƒ½ç¡®ä¿tokenåœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šé€’å¢å‘¢ï¼Ÿå¯¹äºå®¢æˆ·ç«¯çš„Sessionç”±äºè¿‡æœŸè€Œè¢«ä¸­æ–­çš„æƒ…å†µï¼Œèµ„æºæœåŠ¡æœ‰åŠæ³•å°†å®ƒçš„å½±å“å›æ»šå—ï¼Ÿï¼‰

è¿™äº›ç–‘é—®åœ¨Hacker Newsä¸Šå¹¶æ²¡æœ‰äººç»™å‡ºè§£ç­”ã€‚è€Œå…³äºåˆ†å¸ƒå¼çš„èµ„æºæœåŠ¡å™¨æ¶æ„å¦‚ä½•å¤„ç†fencing tokenï¼Œå¦å¤–ä¸€ååˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸“å®¶Flavio Junqueiraåœ¨ä»–çš„ä¸€ç¯‡blogä¸­æœ‰æ‰€æåŠï¼ˆæˆ‘ä»¬åé¢ä¼šå†æåˆ°ï¼‰ã€‚

å…³äºä¸Šè¿°é—®é¢˜ï¼ˆ2ï¼‰ï¼ŒHacker Newsä¸Šæœ‰ä¸€ä½å«reza_nçš„ç”¨æˆ·å‘è¡¨äº†ä¸‹é¢çš„ç–‘é—®ï¼š

> I understand how a fencing token can prevent out of order writes when 2  clients get the same lock. But what happens when those writes happen to  arrive in order and you are doing a value modification? Don't you still  need to rely on some kind of value versioning or optimistic locking?  Wouldn't this make the use of a distributed lock unnecessary?
>
> ï¼ˆè¯‘æ–‡ï¼š æˆ‘ç†è§£å½“ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶è·å¾—é”çš„æ—¶å€™fencing tokenæ˜¯å¦‚ä½•é˜²æ­¢ä¹±åºçš„ã€‚ä½†æ˜¯å¦‚æœä¸¤ä¸ªå†™æ“ä½œæ°å¥½æŒ‰åºåˆ°è¾¾äº†ï¼Œè€Œä¸”å®ƒä»¬åœ¨å¯¹åŒä¸€ä¸ªå€¼è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿéš¾é“ä¸ä¼šä»ç„¶æ˜¯ä¾èµ–æŸç§æ•°æ®ç‰ˆæœ¬å·æˆ–è€…ä¹è§‚é”çš„æœºåˆ¶ï¼Ÿè¿™ä¸ä¼šè®©åˆ†å¸ƒå¼é”å˜å¾—æ²¡æœ‰å¿…è¦äº†å—ï¼Ÿï¼‰

ä¸€ä½å«Terr_çš„Hacker Newsç”¨æˆ·ç­”ï¼š

> I believe the "first" write fails, because the token being passed in is  no longer "the lastest", which indicates their lock was already released or expired.
>
> ï¼ˆè¯‘æ–‡ï¼š æˆ‘è®¤ä¸ºâ€œç¬¬ä¸€ä¸ªâ€å†™è¯·æ±‚ä¼šå¤±è´¥ï¼Œå› ä¸ºå®ƒä¼ å…¥çš„tokenä¸å†æ˜¯â€œæœ€æ–°çš„â€äº†ï¼Œè¿™æ„å‘³ç€é”å·²ç»é‡Šæ”¾æˆ–è€…è¿‡æœŸäº†ã€‚ï¼‰

Terr_çš„å›ç­”åˆ°åº•å¯¹ä¸å¯¹å‘¢ï¼Ÿè¿™ä¸å¥½è¯´ï¼Œå–å†³äºèµ„æºæœåŠ¡å™¨å¯¹äºfencing tokenè¿›è¡Œæ£€æŸ¥çš„å®ç°ç»†èŠ‚ã€‚è®©æˆ‘ä»¬æ¥ç®€å•åˆ†æä¸€ä¸‹ã€‚

ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å‡è®¾æœ‰ä¸€å°ï¼ˆå…ˆä¸è€ƒè™‘åˆ†å¸ƒå¼çš„æƒ…å†µï¼‰é€šè¿‡RPCè¿›è¡Œè¿œç¨‹è®¿é—®æ–‡ä»¶æœåŠ¡å™¨ï¼Œå®ƒæ— æ³•æä¾›å¯¹äºæ–‡ä»¶çš„äº’æ–¥è®¿é—®ï¼ˆå¦åˆ™æˆ‘ä»¬å°±ä¸éœ€è¦åˆ†å¸ƒå¼é”äº†ï¼‰ã€‚ç°åœ¨æˆ‘ä»¬æŒ‰ç…§Martinç»™å‡ºçš„è¯´æ³•ï¼ŒåŠ å…¥fencing tokençš„æ£€æŸ¥é€»è¾‘ã€‚ç”±äºMartinæ²¡æœ‰æè¿°å…·ä½“ç»†èŠ‚ï¼Œæˆ‘ä»¬çŒœæµ‹è‡³å°‘æœ‰ä¸¤ç§å¯èƒ½ã€‚

ç¬¬ä¸€ç§å¯èƒ½ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†æ–‡ä»¶æœåŠ¡å™¨çš„ä»£ç ï¼Œè®©å®ƒèƒ½å¤šæ¥å—ä¸€ä¸ªfencing tokençš„å‚æ•°ï¼Œå¹¶åœ¨è¿›è¡Œæ‰€æœ‰å¤„ç†ä¹‹å‰åŠ å…¥äº†ä¸€ä¸ªç®€å•çš„åˆ¤æ–­é€»è¾‘ï¼Œä¿è¯åªæœ‰å½“å‰æ¥æ”¶åˆ°çš„fencing tokenå¤§äºä¹‹å‰çš„å€¼æ‰å…è®¸è¿›è¡Œåè¾¹çš„è®¿é—®ã€‚è€Œä¸€æ—¦é€šè¿‡äº†è¿™ä¸ªåˆ¤æ–­ï¼Œåé¢çš„å¤„ç†ä¸å˜ã€‚

ç°åœ¨æƒ³è±¡reza_næè¿°çš„åœºæ™¯ï¼Œå®¢æˆ·ç«¯1å’Œå®¢æˆ·ç«¯2éƒ½å‘ç”Ÿäº†GC pauseï¼Œä¸¤ä¸ªfencing  tokenéƒ½å»¶è¿Ÿäº†ï¼Œå®ƒä»¬å‡ ä¹åŒæ—¶åˆ°è¾¾äº†æ–‡ä»¶æœåŠ¡å™¨ï¼Œè€Œä¸”ä¿æŒäº†é¡ºåºã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ–°åŠ å…¥çš„åˆ¤æ–­é€»è¾‘ï¼Œåº”è¯¥å¯¹ä¸¤ä¸ªè¯·æ±‚éƒ½ä¼šæ”¾è¿‡ï¼Œè€Œæ”¾è¿‡ä¹‹åå®ƒä»¬å‡ ä¹åŒæ—¶åœ¨æ“ä½œæ–‡ä»¶ï¼Œè¿˜æ˜¯å†²çªäº†ã€‚æ—¢ç„¶Martinå®£ç§°fencing tokenèƒ½ä¿è¯åˆ†å¸ƒå¼é”çš„æ­£ç¡®æ€§ï¼Œé‚£ä¹ˆä¸Šé¢è¿™ç§å¯èƒ½çš„çŒœæµ‹ä¹Ÿè®¸æ˜¯æˆ‘ä»¬ç†è§£é”™äº†ã€‚

å½“ç„¶ï¼Œè¿˜æœ‰ç¬¬äºŒç§å¯èƒ½ï¼Œå°±æ˜¯æˆ‘ä»¬å¯¹æ–‡ä»¶æœåŠ¡å™¨ç¡®å®åšäº†æ¯”è¾ƒå¤§çš„æ”¹åŠ¨ï¼Œè®©è¿™é‡Œåˆ¤æ–­tokençš„é€»è¾‘å’Œéšåå¯¹æ–‡ä»¶çš„å¤„ç†æ”¾åœ¨ä¸€ä¸ªåŸå­æ“ä½œé‡Œäº†ã€‚è¿™å¯èƒ½æ›´æ¥è¿‘antirezçš„ç†è§£ã€‚è¿™æ ·çš„è¯ï¼Œå‰é¢reza_næè¿°çš„åœºæ™¯ä¸­ï¼Œä¸¤ä¸ªå†™æ“ä½œéƒ½åº”è¯¥æˆåŠŸã€‚



### åŸºäºZooKeeperçš„åˆ†å¸ƒå¼é”æ›´å®‰å…¨å—ï¼Ÿ

Zookeeperæ˜¯é€šè¿‡åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹çš„æ–¹å¼æ¥å®ç°ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUkr0NZvdnibzGXkPiaucEtNLZgr0e3ythcYHu2QkEk1C4icaibSfHCluFrzwLTmG0TsVTLeRl7hAm25kA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

1. å½“éœ€è¦å¯¹èµ„æºè¿›è¡ŒåŠ é”æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨çˆ¶èŠ‚ç‚¹ä¹‹ä¸‹åˆ›å»ºä¸€ä¸ªä¸´æ—¶é¡ºåºèŠ‚ç‚¹ã€‚
2. å®¢æˆ·ç«¯Aæ¥å¯¹èµ„æºåŠ é”ï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦ä¸ºæœ€å°èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆåŠ é”æˆåŠŸï¼Œåç»­åŠ é”çº¿ç¨‹é˜»å¡ç­‰å¾…
3. æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯Bä¹Ÿæ¥å°è¯•åŠ é”ï¼Œç”±äºå®¢æˆ·ç«¯Aå·²ç»åŠ é”æˆåŠŸï¼Œæ‰€ä»¥å®¢æˆ·ç«¯Bå‘ç°è‡ªå·±çš„èŠ‚ç‚¹å¹¶ä¸æ˜¯æœ€å°èŠ‚ç‚¹ï¼Œå°±ä¼šå»å–åˆ°ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”å¯¹ä¸Šä¸€èŠ‚ç‚¹æ³¨å†Œç›‘å¬
4. å½“å®¢æˆ·ç«¯Aæ“ä½œå®Œæˆï¼Œé‡Šæ”¾é”çš„æ“ä½œå°±æ˜¯åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥è§¦å‘ç›‘å¬äº‹ä»¶ï¼Œå®¢æˆ·ç«¯Bå°±ä¼šå¾—åˆ°é€šçŸ¥ï¼ŒåŒæ ·ï¼Œå®¢æˆ·ç«¯Båˆ¤æ–­è‡ªå·±æ˜¯å¦ä¸ºæœ€å°èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆåˆ™åŠ é”æˆåŠŸ



å¾ˆå¤šäººï¼ˆä¹ŸåŒ…æ‹¬Martinåœ¨å†…ï¼‰éƒ½è®¤ä¸ºï¼Œå¦‚æœä½ æƒ³æ„å»ºä¸€ä¸ªæ›´å®‰å…¨çš„åˆ†å¸ƒå¼é”ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ZooKeeperï¼Œè€Œä¸æ˜¯Redisã€‚é‚£ä¹ˆï¼Œä¸ºäº†å¯¹æ¯”çš„ç›®çš„ï¼Œè®©æˆ‘ä»¬å…ˆæš‚æ—¶è„±ç¦»å¼€æœ¬æ–‡çš„é¢˜ç›®ï¼Œè®¨è®ºä¸€ä¸‹åŸºäºZooKeeperçš„åˆ†å¸ƒå¼é”èƒ½æä¾›ç»å¯¹çš„å®‰å…¨å—ï¼Ÿå®ƒéœ€è¦fencing tokenæœºåˆ¶çš„ä¿æŠ¤å—ï¼Ÿ

æˆ‘ä»¬ä¸å¾—ä¸æä¸€ä¸‹åˆ†å¸ƒå¼ä¸“å®¶Flavio Junqueiraæ‰€å†™çš„ä¸€ç¯‡blogï¼Œé¢˜ç›®å«â€œNote on fencing and distributed locksâ€ï¼Œåœ°å€å¦‚ä¸‹ï¼š

- https://fpj.me/2016/02/10/note-on-fencing-and-distributed-locks/

Flavio Junqueiraæ˜¯ZooKeeperçš„ä½œè€…ä¹‹ä¸€ï¼Œä»–çš„è¿™ç¯‡blogå°±å†™åœ¨Martinå’Œantirezå‘ç”Ÿäº‰è®ºçš„é‚£å‡ å¤©ã€‚ä»–åœ¨æ–‡ä¸­ç»™å‡ºäº†ä¸€ä¸ªåŸºäºZooKeeperæ„å»ºåˆ†å¸ƒå¼é”çš„æè¿°ï¼ˆå½“ç„¶è¿™ä¸æ˜¯å”¯ä¸€çš„æ–¹å¼ï¼‰ï¼š

- å®¢æˆ·ç«¯å°è¯•åˆ›å»ºä¸€ä¸ªznodeèŠ‚ç‚¹ï¼Œæ¯”å¦‚`/lock`ã€‚é‚£ä¹ˆç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å°±åˆ›å»ºæˆåŠŸäº†ï¼Œç›¸å½“äºæ‹¿åˆ°äº†é”ï¼›è€Œå…¶å®ƒçš„å®¢æˆ·ç«¯ä¼šåˆ›å»ºå¤±è´¥ï¼ˆznodeå·²å­˜åœ¨ï¼‰ï¼Œè·å–é”å¤±è´¥ã€‚
- æŒæœ‰é”çš„å®¢æˆ·ç«¯è®¿é—®å…±äº«èµ„æºå®Œæˆåï¼Œå°†znodeåˆ æ‰ï¼Œè¿™æ ·å…¶å®ƒå®¢æˆ·ç«¯æ¥ä¸‹æ¥å°±èƒ½æ¥è·å–é”äº†ã€‚
- znodeåº”è¯¥è¢«åˆ›å»ºæˆephemeralçš„ã€‚è¿™æ˜¯znodeçš„ä¸€ä¸ªç‰¹æ€§ï¼Œå®ƒä¿è¯å¦‚æœåˆ›å»ºznodeçš„é‚£ä¸ªå®¢æˆ·ç«¯å´©æºƒäº†ï¼Œé‚£ä¹ˆç›¸åº”çš„znodeä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚è¿™ä¿è¯äº†é”ä¸€å®šä¼šè¢«é‡Šæ”¾ã€‚

çœ‹èµ·æ¥è¿™ä¸ªé”ç›¸å½“å®Œç¾ï¼Œæ²¡æœ‰Redlockè¿‡æœŸæ—¶é—´çš„é—®é¢˜ï¼Œè€Œä¸”èƒ½åœ¨éœ€è¦çš„æ—¶å€™è®©é”è‡ªåŠ¨é‡Šæ”¾ã€‚ä½†ä»”ç»†è€ƒå¯Ÿçš„è¯ï¼Œå¹¶ä¸å°½ç„¶ã€‚

ZooKeeperæ˜¯æ€ä¹ˆæ£€æµ‹å‡ºæŸä¸ªå®¢æˆ·ç«¯å·²ç»å´©æºƒäº†å‘¢ï¼Ÿå®é™…ä¸Šï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½ä¸ZooKeeperçš„æŸå°æœåŠ¡å™¨ç»´æŠ¤ç€ä¸€ä¸ªSessionï¼Œè¿™ä¸ªSessionä¾èµ–å®šæœŸçš„å¿ƒè·³(heartbeat)æ¥ç»´æŒã€‚å¦‚æœZooKeeperé•¿æ—¶é—´æ”¶ä¸åˆ°å®¢æˆ·ç«¯çš„å¿ƒè·³ï¼ˆè¿™ä¸ªæ—¶é—´ç§°ä¸ºSesionçš„è¿‡æœŸæ—¶é—´ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±è®¤ä¸ºSessionè¿‡æœŸäº†ï¼Œé€šè¿‡è¿™ä¸ªSessionæ‰€åˆ›å»ºçš„æ‰€æœ‰çš„ephemeralç±»å‹çš„znodeèŠ‚ç‚¹éƒ½ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚

è®¾æƒ³å¦‚ä¸‹çš„æ‰§è¡Œåºåˆ—ï¼š

1. å®¢æˆ·ç«¯1åˆ›å»ºäº†znodeèŠ‚ç‚¹`/lock`ï¼Œè·å¾—äº†é”ã€‚
2. å®¢æˆ·ç«¯1è¿›å…¥äº†é•¿æ—¶é—´çš„GC pauseã€‚
3. å®¢æˆ·ç«¯1è¿æ¥åˆ°ZooKeeperçš„Sessionè¿‡æœŸäº†ã€‚znodeèŠ‚ç‚¹`/lock`è¢«è‡ªåŠ¨åˆ é™¤ã€‚
4. å®¢æˆ·ç«¯2åˆ›å»ºäº†znodeèŠ‚ç‚¹`/lock`ï¼Œä»è€Œè·å¾—äº†é”ã€‚
5. å®¢æˆ·ç«¯1ä»GC pauseä¸­æ¢å¤è¿‡æ¥ï¼Œå®ƒä»ç„¶è®¤ä¸ºè‡ªå·±æŒæœ‰é”ã€‚

æœ€åï¼Œå®¢æˆ·ç«¯1å’Œå®¢æˆ·ç«¯2éƒ½è®¤ä¸ºè‡ªå·±æŒæœ‰äº†é”ï¼Œå†²çªäº†ã€‚è¿™ä¸ä¹‹å‰Martinåœ¨æ–‡ç« ä¸­æè¿°çš„ç”±äºGC pauseå¯¼è‡´çš„åˆ†å¸ƒå¼é”å¤±æ•ˆçš„æƒ…å†µç±»ä¼¼ã€‚

çœ‹èµ·æ¥ï¼Œç”¨ZooKeeperå®ç°çš„åˆ†å¸ƒå¼é”ä¹Ÿä¸ä¸€å®šå°±æ˜¯å®‰å…¨çš„ã€‚è¯¥æœ‰çš„é—®é¢˜å®ƒè¿˜æ˜¯æœ‰ã€‚ä½†æ˜¯ï¼ŒZooKeeperä½œä¸ºä¸€ä¸ªä¸“é—¨ä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›æ–¹æ¡ˆçš„æ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸€äº›éå¸¸å¥½çš„ç‰¹æ€§ï¼Œæ˜¯Redisä¹‹ç±»çš„æ–¹æ¡ˆæ‰€æ²¡æœ‰çš„ã€‚åƒå‰é¢æåˆ°çš„ephemeralç±»å‹çš„znodeè‡ªåŠ¨åˆ é™¤çš„åŠŸèƒ½å°±æ˜¯ä¸€ä¸ªä¾‹å­ã€‚

è¿˜æœ‰ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„ç‰¹æ€§æ˜¯ZooKeeperçš„watchæœºåˆ¶ã€‚è¿™ä¸ªæœºåˆ¶å¯ä»¥è¿™æ ·æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚å½“å®¢æˆ·ç«¯è¯•å›¾åˆ›å»º`/lock`çš„æ—¶å€™ï¼Œå‘ç°å®ƒå·²ç»å­˜åœ¨äº†ï¼Œè¿™æ—¶å€™åˆ›å»ºå¤±è´¥ï¼Œä½†å®¢æˆ·ç«¯ä¸ä¸€å®šå°±æ­¤å¯¹å¤–å®£å‘Šè·å–é”å¤±è´¥ã€‚å®¢æˆ·ç«¯å¯ä»¥è¿›å…¥ä¸€ç§ç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾…å½“`/lock`èŠ‚ç‚¹è¢«åˆ é™¤çš„æ—¶å€™ï¼ŒZooKeeperé€šè¿‡watchæœºåˆ¶é€šçŸ¥å®ƒï¼Œè¿™æ ·å®ƒå°±å¯ä»¥ç»§ç»­å®Œæˆåˆ›å»ºæ“ä½œï¼ˆè·å–é”ï¼‰ã€‚è¿™å¯ä»¥è®©åˆ†å¸ƒå¼é”åœ¨å®¢æˆ·ç«¯ç”¨èµ·æ¥å°±åƒä¸€ä¸ªæœ¬åœ°çš„é”ä¸€æ ·ï¼šåŠ é”å¤±è´¥å°±é˜»å¡ä½ï¼Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢ã€‚è¿™æ ·çš„ç‰¹æ€§Redlockå°±æ— æ³•å®ç°ã€‚

å°ç»“ä¸€ä¸‹ï¼ŒåŸºäºZooKeeperçš„é”å’ŒåŸºäºRedisçš„é”ç›¸æ¯”åœ¨å®ç°ç‰¹æ€§ä¸Šæœ‰ä¸¤ä¸ªä¸åŒï¼š

- åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å¯ä»¥æŒæœ‰é”ä»»æ„é•¿çš„æ—¶é—´ï¼Œè¿™å¯ä»¥ç¡®ä¿å®ƒåšå®Œæ‰€æœ‰éœ€è¦çš„èµ„æºè®¿é—®æ“ä½œä¹‹åå†é‡Šæ”¾é”ã€‚è¿™é¿å…äº†åŸºäºRedisçš„é”å¯¹äºæœ‰æ•ˆæ—¶é—´(lock validity  time)åˆ°åº•è®¾ç½®å¤šé•¿çš„ä¸¤éš¾é—®é¢˜ã€‚å®é™…ä¸Šï¼ŒåŸºäºZooKeeperçš„é”æ˜¯ä¾é Sessionï¼ˆå¿ƒè·³ï¼‰æ¥ç»´æŒé”çš„æŒæœ‰çŠ¶æ€çš„ï¼Œè€ŒRedisä¸æ”¯æŒSesionã€‚
- åŸºäºZooKeeperçš„é”æ”¯æŒåœ¨è·å–é”å¤±è´¥ä¹‹åç­‰å¾…é”é‡æ–°é‡Šæ”¾çš„äº‹ä»¶ã€‚è¿™è®©å®¢æˆ·ç«¯å¯¹é”çš„ä½¿ç”¨æ›´åŠ çµæ´»ã€‚

é¡ºä¾¿æä¸€ä¸‹ï¼Œå¦‚ä¸Šæ‰€è¿°çš„åŸºäºZooKeeperçš„åˆ†å¸ƒå¼é”çš„å®ç°ï¼Œå¹¶ä¸æ˜¯æœ€ä¼˜çš„ã€‚å®ƒä¼šå¼•å‘â€œherd effectâ€ï¼ˆç¾Šç¾¤æ•ˆåº”ï¼‰ï¼Œé™ä½è·å–é”çš„æ€§èƒ½ã€‚ä¸€ä¸ªæ›´å¥½çš„å®ç°å‚è§ä¸‹é¢é“¾æ¥ï¼š

- http://zookeeper.apache.org/doc/r3.4.9/recipes.html#sc_recipes_Locks

æˆ‘ä»¬é‡æ–°å›åˆ°Flavio Junqueiraå¯¹äºfencing tokençš„åˆ†æã€‚Flavio JunqueiraæŒ‡å‡ºï¼Œfencing  tokenæœºåˆ¶æœ¬è´¨ä¸Šæ˜¯è¦æ±‚å®¢æˆ·ç«¯åœ¨æ¯æ¬¡è®¿é—®ä¸€ä¸ªå…±äº«èµ„æºçš„æ—¶å€™ï¼Œåœ¨æ‰§è¡Œä»»ä½•æ“ä½œä¹‹å‰ï¼Œå…ˆå¯¹èµ„æºè¿›è¡ŒæŸç§å½¢å¼çš„â€œæ ‡è®°â€(mark)æ“ä½œï¼Œè¿™ä¸ªâ€œæ ‡è®°â€èƒ½ä¿è¯æŒæœ‰æ—§çš„é”çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆå¦‚æœå»¶è¿Ÿåˆ°è¾¾äº†ï¼‰æ— æ³•æ“ä½œèµ„æºã€‚è¿™ç§æ ‡è®°æ“ä½œå¯ä»¥æ˜¯å¾ˆå¤šå½¢å¼ï¼Œfencing tokenæ˜¯å…¶ä¸­æ¯”è¾ƒå…¸å‹çš„ä¸€ä¸ªã€‚

éšåFlavio Junqueiraæåˆ°ç”¨é€’å¢çš„epoch numberï¼ˆç›¸å½“äºMartinçš„fencing  tokenï¼‰æ¥ä¿æŠ¤å…±äº«èµ„æºã€‚è€Œå¯¹äºåˆ†å¸ƒå¼çš„èµ„æºï¼Œä¸ºäº†æ–¹ä¾¿è®¨è®ºï¼Œå‡è®¾åˆ†å¸ƒå¼èµ„æºæ˜¯ä¸€ä¸ªå°å‹çš„å¤šå¤‡ä»½çš„æ•°æ®å­˜å‚¨(a small replicated  data store)ï¼Œæ‰§è¡Œå†™æ“ä½œçš„æ—¶å€™éœ€è¦å‘æ‰€æœ‰èŠ‚ç‚¹ä¸Šå†™æ•°æ®ã€‚æœ€ç®€å•çš„åšæ ‡è®°çš„æ–¹å¼ï¼Œå°±æ˜¯åœ¨å¯¹èµ„æºè¿›è¡Œä»»ä½•æ“ä½œä¹‹å‰ï¼Œå…ˆæŠŠepoch  numberæ ‡è®°åˆ°å„ä¸ªèµ„æºèŠ‚ç‚¹ä¸Šå»ã€‚è¿™æ ·ï¼Œå„ä¸ªèŠ‚ç‚¹å°±ä¿è¯äº†æ—§çš„ï¼ˆä¹Ÿå°±æ˜¯å°çš„ï¼‰epoch numberæ— æ³•æ“ä½œæ•°æ®ã€‚

å½“ç„¶ï¼Œè¿™é‡Œå†å±•å¼€è®¨è®ºä¸‹å»å¯èƒ½å°±æ¶‰åŠåˆ°äº†è¿™ä¸ªæ•°æ®å­˜å‚¨æœåŠ¡çš„å®ç°ç»†èŠ‚äº†ã€‚æ¯”å¦‚åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œå¯èƒ½ä¸ºäº†å®¹é”™ï¼Œåªè¦ä¸Šé¢è®²çš„æ ‡è®°å’Œå†™å…¥æ“ä½œåœ¨å¤šæ•°èŠ‚ç‚¹ä¸Šå®Œæˆå°±ç®—æˆåŠŸå®Œæˆäº†ï¼ˆFlavio  Junqueiraå¹¶æ²¡æœ‰å±•å¼€å»è®²ï¼‰ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬èƒ½çœ‹åˆ°çš„ï¼Œæœ€é‡è¦çš„ï¼Œæ˜¯è¿™ç§æ ‡è®°æ“ä½œå¦‚ä½•èµ·ä½œç”¨çš„æ–¹å¼ã€‚è¿™æœ‰ç‚¹ç±»ä¼¼äºPaxosåè®®ï¼ˆPaxosåè®®è¦æ±‚æ¯ä¸ªproposalå¯¹åº”ä¸€ä¸ªé€’å¢çš„æ•°å­—ï¼Œæ‰§è¡Œacceptè¯·æ±‚ä¹‹å‰å…ˆæ‰§è¡Œprepareè¯·æ±‚ï¼‰ã€‚antirezæå‡ºçš„random tokençš„æ–¹å¼æ˜¾ç„¶ä¸ç¬¦åˆFlavio  Junqueiraå¯¹äºâ€œæ ‡è®°â€æ“ä½œçš„å®šä¹‰ï¼Œå› ä¸ºå®ƒæ— æ³•åŒºåˆ†æ–°çš„tokenå’Œæ—§çš„tokenã€‚åªæœ‰é€’å¢çš„æ•°å­—æ‰èƒ½ç¡®ä¿æœ€ç»ˆæ”¶æ•›åˆ°æœ€æ–°çš„æ“ä½œç»“æœä¸Šã€‚

åœ¨è¿™ä¸ªåˆ†å¸ƒå¼æ•°æ®å­˜å‚¨æœåŠ¡ï¼ˆå…±äº«èµ„æºï¼‰çš„ä¾‹å­ä¸­ï¼Œå®¢æˆ·ç«¯åœ¨æ ‡è®°å®Œæˆä¹‹åæ‰§è¡Œå†™å…¥æ“ä½œçš„æ—¶å€™ï¼Œå­˜å‚¨æœåŠ¡çš„èŠ‚ç‚¹éœ€è¦åˆ¤æ–­epoch  numberæ˜¯ä¸æ˜¯æœ€æ–°ï¼Œç„¶åç¡®å®šèƒ½ä¸èƒ½æ‰§è¡Œå†™å…¥æ“ä½œã€‚å¦‚æœæŒ‰ç…§ä¸Šä¸€èŠ‚æˆ‘ä»¬çš„åˆ†ææ€è·¯ï¼Œè¿™é‡Œçš„epochåˆ¤æ–­å’Œæ¥ä¸‹æ¥çš„å†™å…¥æ“ä½œï¼Œæ˜¯ä¸æ˜¯åœ¨ä¸€ä¸ªåŸå­æ“ä½œé‡Œå‘¢ï¼Ÿæ ¹æ®Flavio  Junqueiraçš„ç›¸å…³æè¿°ï¼Œæˆ‘ä»¬ç›¸ä¿¡ï¼Œåº”è¯¥æ˜¯åŸå­çš„ã€‚é‚£ä¹ˆæ—¢ç„¶èµ„æºæœ¬èº«å¯ä»¥æä¾›åŸå­äº’æ–¥æ“ä½œäº†ï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼é”è¿˜æœ‰å­˜åœ¨çš„æ„ä¹‰å—ï¼Ÿåº”è¯¥è¯´æœ‰ã€‚å®¢æˆ·ç«¯å¯ä»¥åˆ©ç”¨åˆ†å¸ƒå¼é”æœ‰æ•ˆåœ°é¿å…å†²çªï¼Œç­‰å¾…å†™å…¥æœºä¼šï¼Œè¿™å¯¹äºåŒ…å«å¤šä¸ªèŠ‚ç‚¹çš„åˆ†å¸ƒå¼èµ„æºå°¤å…¶æœ‰ç”¨ï¼ˆå½“ç„¶ï¼Œæ˜¯å‡ºäºæ•ˆç‡çš„åŸå› ï¼‰ã€‚



### Chubbyçš„åˆ†å¸ƒå¼é”æ˜¯æ€æ ·åšfencingçš„ï¼Ÿ





æåˆ°åˆ†å¸ƒå¼é”ï¼Œå°±ä¸èƒ½ä¸æGoogleçš„Chubbyã€‚

Chubbyæ˜¯Googleå†…éƒ¨ä½¿ç”¨çš„åˆ†å¸ƒå¼é”æœåŠ¡ï¼Œæœ‰ç‚¹ç±»ä¼¼äºZooKeeperï¼Œä½†ä¹Ÿå­˜åœ¨å¾ˆå¤šå·®å¼‚ã€‚Chubbyå¯¹å¤–å…¬å¼€çš„èµ„æ–™ï¼Œä¸»è¦æ˜¯ä¸€ç¯‡è®ºæ–‡ï¼Œå«åšâ€œThe Chubby lock service for loosely-coupled distributed systemsâ€ï¼Œä¸‹è½½åœ°å€å¦‚ä¸‹ï¼š

- https://research.google.com/archive/chubby.html

å¦å¤–ï¼ŒYouTubeä¸Šæœ‰ä¸€ä¸ªçš„è®²Chubbyçš„talkï¼Œä¹Ÿå¾ˆä¸é”™ï¼Œæ’­æ”¾åœ°å€ï¼š

- https://www.youtube.com/watch?v=PqItueBaiRg&feature=youtu.be&t=487

Chubbyè‡ªç„¶ä¹Ÿè€ƒè™‘åˆ°äº†å»¶è¿Ÿé€ æˆçš„é”å¤±æ•ˆçš„é—®é¢˜ã€‚è®ºæ–‡é‡Œæœ‰ä¸€æ®µæè¿°å¦‚ä¸‹ï¼š

> a process holding a lock L may issue a request R, but then fail. Another  process may ac- quire L and perform some action before R arrives at its  destination. If R later arrives, it may be acted on without the  protection of L, and potentially on inconsistent data.
>
> ï¼ˆè¯‘æ–‡ï¼š ä¸€ä¸ªè¿›ç¨‹æŒæœ‰é”Lï¼Œå‘èµ·äº†è¯·æ±‚Rï¼Œä½†æ˜¯è¯·æ±‚å¤±è´¥äº†ã€‚å¦ä¸€ä¸ªè¿›ç¨‹è·å¾—äº†é”Lå¹¶åœ¨è¯·æ±‚Råˆ°è¾¾ç›®çš„æ–¹ä¹‹å‰æ‰§è¡Œäº†ä¸€äº›åŠ¨ä½œã€‚å¦‚æœåæ¥è¯·æ±‚Råˆ°è¾¾äº†ï¼Œå®ƒå°±æœ‰å¯èƒ½åœ¨æ²¡æœ‰é”Lä¿æŠ¤çš„æƒ…å†µä¸‹è¿›è¡Œæ“ä½œï¼Œå¸¦æ¥æ•°æ®ä¸ä¸€è‡´çš„æ½œåœ¨é£é™©ã€‚ï¼‰

è¿™è·ŸMartinçš„åˆ†æå¤§åŒå°å¼‚ã€‚

Chubbyç»™å‡ºçš„ç”¨äºè§£å†³ï¼ˆç¼“è§£ï¼‰è¿™ä¸€é—®é¢˜çš„æœºåˆ¶ç§°ä¸ºsequencerï¼Œç±»ä¼¼äºfencing tokenæœºåˆ¶ã€‚é”çš„æŒæœ‰è€…å¯ä»¥éšæ—¶è¯·æ±‚ä¸€ä¸ªsequencerï¼Œè¿™æ˜¯ä¸€ä¸ªå­—èŠ‚ä¸²ï¼Œå®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

- é”çš„åå­—ã€‚
- é”çš„è·å–æ¨¡å¼ï¼ˆæ’ä»–é”è¿˜æ˜¯å…±äº«é”ï¼‰ã€‚
- lock generation numberï¼ˆä¸€ä¸ª64bitçš„å•è°ƒé€’å¢æ•°å­—ï¼‰ã€‚ä½œç”¨ç›¸å½“äºfencing tokenæˆ–epoch numberã€‚

å®¢æˆ·ç«¯æ‹¿åˆ°sequencerä¹‹åï¼Œåœ¨æ“ä½œèµ„æºçš„æ—¶å€™æŠŠå®ƒä¼ ç»™èµ„æºæœåŠ¡å™¨ã€‚ç„¶åï¼Œèµ„æºæœåŠ¡å™¨è´Ÿè´£å¯¹sequencerçš„æœ‰æ•ˆæ€§è¿›è¡Œæ£€æŸ¥ã€‚æ£€æŸ¥å¯ä»¥æœ‰ä¸¤ç§æ–¹å¼ï¼š

- è°ƒç”¨Chubbyæä¾›çš„APIï¼ŒCheckSequencer()ï¼Œå°†æ•´ä¸ªsequencerä¼ è¿›å»è¿›è¡Œæ£€æŸ¥ã€‚è¿™ä¸ªæ£€æŸ¥æ˜¯ä¸ºäº†ä¿è¯å®¢æˆ·ç«¯æŒæœ‰çš„é”åœ¨è¿›è¡Œèµ„æºè®¿é—®çš„æ—¶å€™ä»ç„¶æœ‰æ•ˆã€‚
- å°†å®¢æˆ·ç«¯ä¼ æ¥çš„sequencerä¸èµ„æºæœåŠ¡å™¨å½“å‰è§‚å¯Ÿåˆ°çš„æœ€æ–°çš„sequencerè¿›è¡Œå¯¹æ¯”æ£€æŸ¥ã€‚å¯ä»¥ç†è§£ä¸ºä¸Martinæè¿°çš„å¯¹äºfencing tokençš„æ£€æŸ¥ç±»ä¼¼ã€‚

å½“ç„¶ï¼Œå¦‚æœç”±äºå…¼å®¹çš„åŸå› ï¼Œèµ„æºæœåŠ¡æœ¬èº«ä¸å®¹æ˜“ä¿®æ”¹ï¼Œé‚£ä¹ˆChubbyè¿˜æä¾›äº†ä¸€ç§æœºåˆ¶ï¼š

- lock-delayã€‚Chubbyå…è®¸å®¢æˆ·ç«¯ä¸ºæŒæœ‰çš„é”æŒ‡å®šä¸€ä¸ªlock-delayçš„æ—¶é—´å€¼ï¼ˆé»˜è®¤æ˜¯1åˆ†é’Ÿï¼‰ã€‚å½“Chubbyå‘ç°å®¢æˆ·ç«¯è¢«åŠ¨å¤±å»è”ç³»çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šç«‹å³é‡Šæ”¾é”ï¼Œè€Œæ˜¯ä¼šåœ¨lock-delayæŒ‡å®šçš„æ—¶é—´å†…é˜»æ­¢å…¶å®ƒå®¢æˆ·ç«¯è·å¾—è¿™ä¸ªé”ã€‚è¿™æ˜¯ä¸ºäº†åœ¨æŠŠé”åˆ†é…ç»™æ–°çš„å®¢æˆ·ç«¯ä¹‹å‰ï¼Œè®©ä¹‹å‰æŒæœ‰é”çš„å®¢æˆ·ç«¯æœ‰å……åˆ†çš„æ—¶é—´æŠŠè¯·æ±‚é˜Ÿåˆ—æ’ç©º(draining the queue)ï¼Œå°½é‡é˜²æ­¢å‡ºç°å»¶è¿Ÿåˆ°è¾¾çš„æœªå¤„ç†è¯·æ±‚ã€‚

å¯è§ï¼Œä¸ºäº†åº”å¯¹é”å¤±æ•ˆé—®é¢˜ï¼ŒChubbyæä¾›çš„ä¸‰ç§å¤„ç†æ–¹å¼ï¼šCheckSequencer()æ£€æŸ¥ã€ä¸ä¸Šæ¬¡æœ€æ–°çš„sequencerå¯¹æ¯”ã€lock-delayï¼Œå®ƒä»¬å¯¹äºå®‰å…¨æ€§çš„ä¿è¯æ˜¯ä»å¼ºåˆ°å¼±çš„ã€‚è€Œä¸”ï¼Œè¿™äº›å¤„ç†æ–¹å¼æœ¬èº«éƒ½æ²¡æœ‰ä¿è¯æä¾›ç»å¯¹çš„æ­£ç¡®æ€§(correctness)ã€‚ä½†æ˜¯ï¼ŒChubbyç¡®å®æä¾›äº†å•è°ƒé€’å¢çš„lock generation numberï¼Œè¿™å°±å…è®¸èµ„æºæœåŠ¡å™¨åœ¨éœ€è¦çš„æ—¶å€™ï¼Œåˆ©ç”¨å®ƒæä¾›æ›´å¼ºçš„å®‰å…¨æ€§ä¿éšœã€‚



### å…³äºæ—¶é’Ÿ



åœ¨Martinä¸antirezçš„è¿™åœºäº‰è®ºä¸­ï¼Œå†²çªæœ€ä¸ºä¸¥é‡çš„å°±æ˜¯å¯¹äºç³»ç»Ÿæ—¶é’Ÿçš„å‡è®¾æ˜¯ä¸æ˜¯åˆç†çš„é—®é¢˜ã€‚Martinè®¤ä¸ºç³»ç»Ÿæ—¶é’Ÿéš¾å…ä¼šå‘ç”Ÿè·³è·ƒï¼ˆè¿™ä¸åˆ†å¸ƒå¼ç®—æ³•çš„å¼‚æ­¥æ¨¡å‹ç›¸ç¬¦ï¼‰ï¼Œè€Œantirezè®¤ä¸ºåœ¨å®é™…ä¸­ç³»ç»Ÿæ—¶é’Ÿå¯ä»¥ä¿è¯ä¸å‘ç”Ÿå¤§çš„è·³è·ƒã€‚

Martinå¯¹äºè¿™ä¸€åˆ†æ­§å‘è¡¨äº†å¦‚ä¸‹çœ‹æ³•ï¼ˆåŸè¯ï¼‰ï¼š

> So, fundamentally, this discussion boils down to whether it is reasonable  to make timing assumptions for ensuring safety properties. I say no,  Salvatore says yes â€” but that's ok. Engineering discussions rarely have  one right answer.
>
> ï¼ˆè¯‘æ–‡ï¼šä»æ ¹æœ¬ä¸Šæ¥è¯´ï¼Œè¿™åœºè®¨è®ºæœ€åå½’ç»“åˆ°äº†ä¸€ä¸ªé—®é¢˜ä¸Šï¼šä¸ºäº†ç¡®ä¿å®‰å…¨æ€§è€Œåšå‡ºçš„è®°æ—¶å‡è®¾åˆ°åº•æ˜¯å¦åˆç†ã€‚æˆ‘è®¤ä¸ºä¸åˆç†ï¼Œè€Œantirezè®¤ä¸ºåˆç† â€”â€” ä½†æ˜¯è¿™ä¹Ÿæ²¡å…³ç³»ã€‚å·¥ç¨‹é—®é¢˜çš„è®¨è®ºå¾ˆå°‘åªæœ‰ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆã€‚ï¼‰

é‚£ä¹ˆï¼Œåœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œæ—¶é’Ÿåˆ°åº•æ˜¯å¦å¯ä¿¡å‘¢ï¼Ÿå¯¹æ­¤ï¼ŒJulia Evansä¸“é—¨å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œâ€œTIL: clock skew existsâ€ï¼Œæ€»ç»“äº†å¾ˆå¤šè·Ÿæ—¶é’Ÿåç§»æœ‰å…³çš„å®é™…èµ„æ–™ï¼Œå¹¶è¿›è¡Œäº†åˆ†æã€‚è¿™ç¯‡æ–‡ç« åœ°å€ï¼š



- http://jvns.ca/blog/2016/02/09/til-clock-skew-exists/



Julia Evansåœ¨æ–‡ç« æœ€åå¾—å‡ºçš„ç»“è®ºæ˜¯ï¼š

> clock skew is realï¼ˆæ—¶é’Ÿåç§»åœ¨ç°å®ä¸­æ˜¯å­˜åœ¨çš„ï¼‰



### Martinçš„äº‹åæ€»ç»“





æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œå½“å„æ–¹çš„äº‰è®ºåœ¨æ¿€çƒˆè¿›è¡Œçš„æ—¶å€™ï¼ŒMartinå‡ ä¹å§‹ç»ˆç½®èº«äº‹å¤–ã€‚ä½†æ˜¯Martinåœ¨è¿™ä»¶äº‹è¿‡å»ä¹‹åï¼ŒæŠŠè¿™ä¸ªäº‹ä»¶çš„å‰åç»è¿‡æ€»ç»“æˆäº†ä¸€ä¸ªå¾ˆé•¿çš„æ•…äº‹çº¿ã€‚å¦‚æœä½ æƒ³æœ€å…¨é¢åœ°äº†è§£è¿™ä¸ªäº‹ä»¶å‘ç”Ÿçš„å‰åç»è¿‡ï¼Œé‚£ä¹ˆå»ºè®®å»è¯»è¯»Martinçš„è¿™ä¸ªæ€»ç»“ï¼š

- https://storify.com/martinkl/redlock-discussion

åœ¨è¿™ä¸ªæ•…äº‹æ€»ç»“çš„æœ€åï¼ŒMartinå†™ä¸‹äº†å¾ˆå¤šæ„Ÿæ€§çš„è¯„è®ºï¼š

> For me, this is the most important point: I don't care who is right or  wrong in this debate â€” I care about learning from others' work, so that  we can avoid repeating old mistakes, and make things better in future.  So much great work has already been done for us: by standing on the  shoulders of giants, we can build better software.......By all means, test ideas by arguing them and checking whether they stand  up to scrutiny by others. That's part of the learning process. But the  goal should be to learn, not to convince others that you are right.  Sometimes that just means to stop and think for a while.
>
> ï¼ˆè¯‘æ–‡ï¼šå¯¹æˆ‘æ¥è¯´æœ€é‡è¦çš„ä¸€ç‚¹åœ¨äºï¼šæˆ‘å¹¶ä¸åœ¨ä¹åœ¨è¿™åœºè¾©è®ºä¸­è°å¯¹è°é”™ â€”â€” æˆ‘åªå…³å¿ƒä»å…¶ä»–äººçš„å·¥ä½œä¸­å­¦åˆ°çš„ä¸œè¥¿ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿé¿å…é‡è¹ˆè¦†è¾™ï¼Œå¹¶è®©æœªæ¥æ›´åŠ ç¾å¥½ã€‚å‰äººå·²ç»ä¸ºæˆ‘ä»¬åˆ›é€ å‡ºäº†è®¸å¤šä¼Ÿå¤§çš„æˆæœï¼šç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œæˆ‘ä»¬å¾—ä»¥æ„å»ºæ›´æ£’çš„è½¯ä»¶ã€‚......å¯¹äºä»»ä½•æƒ³æ³•ï¼ŒåŠ¡å¿…è¦è¯¦åŠ æ£€éªŒï¼Œé€šè¿‡è®ºè¯ä»¥åŠæ£€æŸ¥å®ƒä»¬æ˜¯å¦ç»å¾—ä½åˆ«äººçš„è¯¦ç»†å®¡æŸ¥ã€‚é‚£æ˜¯å­¦ä¹ è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚ä½†ç›®æ ‡åº”è¯¥æ˜¯ä¸ºäº†è·å¾—çŸ¥è¯†ï¼Œè€Œä¸åº”è¯¥æ˜¯ä¸ºäº†è¯´æœåˆ«äººç›¸ä¿¡ä½ è‡ªå·±æ˜¯å¯¹çš„ã€‚æœ‰æ—¶å€™ï¼Œé‚£åªä¸è¿‡æ„å‘³ç€åœä¸‹æ¥ï¼Œå¥½å¥½åœ°æƒ³ä¸€æƒ³ã€‚ï¼‰



------